<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>处理任意数量的 Future | rust语言中文文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/rust-doc/logo.svg">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="一门赋予每个人构建可靠且高效软件能力的语言。">
    
    <link rel="preload" href="/rust-doc/assets/css/0.styles.b04b0b2c.css" as="style"><link rel="preload" href="/rust-doc/assets/js/app.a88c00c6.js" as="script"><link rel="preload" href="/rust-doc/assets/js/2.de3bffe6.js" as="script"><link rel="preload" href="/rust-doc/assets/js/1.5cc4c8d6.js" as="script"><link rel="preload" href="/rust-doc/assets/js/53.229b8eab.js" as="script"><link rel="prefetch" href="/rust-doc/assets/js/10.eb17c9b1.js"><link rel="prefetch" href="/rust-doc/assets/js/100.8c04b19c.js"><link rel="prefetch" href="/rust-doc/assets/js/101.33ce1471.js"><link rel="prefetch" href="/rust-doc/assets/js/102.abc16712.js"><link rel="prefetch" href="/rust-doc/assets/js/103.1062f6e2.js"><link rel="prefetch" href="/rust-doc/assets/js/104.21f110ee.js"><link rel="prefetch" href="/rust-doc/assets/js/105.1c8ab381.js"><link rel="prefetch" href="/rust-doc/assets/js/106.ba5256a8.js"><link rel="prefetch" href="/rust-doc/assets/js/107.40f903c0.js"><link rel="prefetch" href="/rust-doc/assets/js/108.cf6bd7fd.js"><link rel="prefetch" href="/rust-doc/assets/js/109.cd1a4390.js"><link rel="prefetch" href="/rust-doc/assets/js/11.4d96857f.js"><link rel="prefetch" href="/rust-doc/assets/js/110.417a69bf.js"><link rel="prefetch" href="/rust-doc/assets/js/111.ce90067b.js"><link rel="prefetch" href="/rust-doc/assets/js/112.379ff0a5.js"><link rel="prefetch" href="/rust-doc/assets/js/113.b25bff3c.js"><link rel="prefetch" href="/rust-doc/assets/js/114.e644be40.js"><link rel="prefetch" href="/rust-doc/assets/js/115.7a6871f4.js"><link rel="prefetch" href="/rust-doc/assets/js/12.0eea138a.js"><link rel="prefetch" href="/rust-doc/assets/js/13.ded142e7.js"><link rel="prefetch" href="/rust-doc/assets/js/14.ed95d241.js"><link rel="prefetch" href="/rust-doc/assets/js/15.c72c8a9e.js"><link rel="prefetch" href="/rust-doc/assets/js/16.1c185a04.js"><link rel="prefetch" href="/rust-doc/assets/js/17.eda25704.js"><link rel="prefetch" href="/rust-doc/assets/js/18.94f1420e.js"><link rel="prefetch" href="/rust-doc/assets/js/19.ac65ddaa.js"><link rel="prefetch" href="/rust-doc/assets/js/20.b2f37783.js"><link rel="prefetch" href="/rust-doc/assets/js/21.bc7abb0d.js"><link rel="prefetch" href="/rust-doc/assets/js/22.22dfa4a0.js"><link rel="prefetch" href="/rust-doc/assets/js/23.3cb3298f.js"><link rel="prefetch" href="/rust-doc/assets/js/24.3123e7b2.js"><link rel="prefetch" href="/rust-doc/assets/js/25.43f64b7b.js"><link rel="prefetch" href="/rust-doc/assets/js/26.7cf20f6f.js"><link rel="prefetch" href="/rust-doc/assets/js/27.b6484f43.js"><link rel="prefetch" href="/rust-doc/assets/js/28.e8f925c2.js"><link rel="prefetch" href="/rust-doc/assets/js/29.7b185968.js"><link rel="prefetch" href="/rust-doc/assets/js/3.bfcba754.js"><link rel="prefetch" href="/rust-doc/assets/js/30.bcf625d6.js"><link rel="prefetch" href="/rust-doc/assets/js/31.a4621f10.js"><link rel="prefetch" href="/rust-doc/assets/js/32.18029521.js"><link rel="prefetch" href="/rust-doc/assets/js/33.04ff1333.js"><link rel="prefetch" href="/rust-doc/assets/js/34.738157d8.js"><link rel="prefetch" href="/rust-doc/assets/js/35.251e1b14.js"><link rel="prefetch" href="/rust-doc/assets/js/36.83c259ce.js"><link rel="prefetch" href="/rust-doc/assets/js/37.f3e1e755.js"><link rel="prefetch" href="/rust-doc/assets/js/38.33045d52.js"><link rel="prefetch" href="/rust-doc/assets/js/39.777d3e20.js"><link rel="prefetch" href="/rust-doc/assets/js/4.508a9818.js"><link rel="prefetch" href="/rust-doc/assets/js/40.cda38724.js"><link rel="prefetch" href="/rust-doc/assets/js/41.dcca86ef.js"><link rel="prefetch" href="/rust-doc/assets/js/42.f9fdf067.js"><link rel="prefetch" href="/rust-doc/assets/js/43.c1d2f573.js"><link rel="prefetch" href="/rust-doc/assets/js/44.7bb0690f.js"><link rel="prefetch" href="/rust-doc/assets/js/45.82784fbd.js"><link rel="prefetch" href="/rust-doc/assets/js/46.d7808969.js"><link rel="prefetch" href="/rust-doc/assets/js/47.d66560c6.js"><link rel="prefetch" href="/rust-doc/assets/js/48.59d859e9.js"><link rel="prefetch" href="/rust-doc/assets/js/49.d43315c6.js"><link rel="prefetch" href="/rust-doc/assets/js/5.f95f0a29.js"><link rel="prefetch" href="/rust-doc/assets/js/50.f9672ec2.js"><link rel="prefetch" href="/rust-doc/assets/js/51.ecb77311.js"><link rel="prefetch" href="/rust-doc/assets/js/52.6607c2a4.js"><link rel="prefetch" href="/rust-doc/assets/js/54.5880dc0d.js"><link rel="prefetch" href="/rust-doc/assets/js/55.ade6608a.js"><link rel="prefetch" href="/rust-doc/assets/js/56.aa0abb29.js"><link rel="prefetch" href="/rust-doc/assets/js/57.96df9fe4.js"><link rel="prefetch" href="/rust-doc/assets/js/58.6b7ba48a.js"><link rel="prefetch" href="/rust-doc/assets/js/59.f2bb8a08.js"><link rel="prefetch" href="/rust-doc/assets/js/6.c4bf9bde.js"><link rel="prefetch" href="/rust-doc/assets/js/60.eb253920.js"><link rel="prefetch" href="/rust-doc/assets/js/61.3c77c203.js"><link rel="prefetch" href="/rust-doc/assets/js/62.850afab7.js"><link rel="prefetch" href="/rust-doc/assets/js/63.ffde9bdf.js"><link rel="prefetch" href="/rust-doc/assets/js/64.47fe36c4.js"><link rel="prefetch" href="/rust-doc/assets/js/65.a432095e.js"><link rel="prefetch" href="/rust-doc/assets/js/66.4320af40.js"><link rel="prefetch" href="/rust-doc/assets/js/67.f902a740.js"><link rel="prefetch" href="/rust-doc/assets/js/68.af599e94.js"><link rel="prefetch" href="/rust-doc/assets/js/69.96e151bd.js"><link rel="prefetch" href="/rust-doc/assets/js/7.7610c249.js"><link rel="prefetch" href="/rust-doc/assets/js/70.ee05e42c.js"><link rel="prefetch" href="/rust-doc/assets/js/71.3993e2fb.js"><link rel="prefetch" href="/rust-doc/assets/js/72.278e0c01.js"><link rel="prefetch" href="/rust-doc/assets/js/73.4f5bc7fb.js"><link rel="prefetch" href="/rust-doc/assets/js/74.14f18397.js"><link rel="prefetch" href="/rust-doc/assets/js/75.eb51a247.js"><link rel="prefetch" href="/rust-doc/assets/js/76.ea8105d3.js"><link rel="prefetch" href="/rust-doc/assets/js/77.8c32ad9f.js"><link rel="prefetch" href="/rust-doc/assets/js/78.07e3b60a.js"><link rel="prefetch" href="/rust-doc/assets/js/79.6da01008.js"><link rel="prefetch" href="/rust-doc/assets/js/80.8027ae78.js"><link rel="prefetch" href="/rust-doc/assets/js/81.4a361f83.js"><link rel="prefetch" href="/rust-doc/assets/js/82.b81544aa.js"><link rel="prefetch" href="/rust-doc/assets/js/83.35a71696.js"><link rel="prefetch" href="/rust-doc/assets/js/84.1acd927f.js"><link rel="prefetch" href="/rust-doc/assets/js/85.6ded5918.js"><link rel="prefetch" href="/rust-doc/assets/js/86.e681d56c.js"><link rel="prefetch" href="/rust-doc/assets/js/87.b5799a20.js"><link rel="prefetch" href="/rust-doc/assets/js/88.2a2b5211.js"><link rel="prefetch" href="/rust-doc/assets/js/89.10b17a5d.js"><link rel="prefetch" href="/rust-doc/assets/js/90.b89d513f.js"><link rel="prefetch" href="/rust-doc/assets/js/91.0fb3ef4f.js"><link rel="prefetch" href="/rust-doc/assets/js/92.8e03de8c.js"><link rel="prefetch" href="/rust-doc/assets/js/93.ed05eb21.js"><link rel="prefetch" href="/rust-doc/assets/js/94.7c1302f9.js"><link rel="prefetch" href="/rust-doc/assets/js/95.d9c440b8.js"><link rel="prefetch" href="/rust-doc/assets/js/96.44a1e907.js"><link rel="prefetch" href="/rust-doc/assets/js/97.0228a56b.js"><link rel="prefetch" href="/rust-doc/assets/js/98.b853575d.js"><link rel="prefetch" href="/rust-doc/assets/js/99.24df70a3.js"><link rel="prefetch" href="/rust-doc/assets/js/vendors~docsearch.3b28fe31.js">
    <link rel="stylesheet" href="/rust-doc/assets/css/0.styles.b04b0b2c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rust-doc/" class="home-link router-link-active"><!----> <span class="site-name">rust语言中文文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/rust-doc/doc/introduce/introduce.html" class="sidebar-link">Rust介绍</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/getting-started/getting-started" class="sidebar-heading clickable"><span>入门</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/rust-doc/doc/guess-game/guess-game.html" class="sidebar-link">猜一猜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-concept/common-concept" class="sidebar-heading clickable"><span>常用的编程概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/understand-ownership/understand-ownership" class="sidebar-heading clickable"><span>认识所有权</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/structs/structs" class="sidebar-heading clickable"><span>使用结构体来构造相关数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/enums/enums" class="sidebar-heading clickable"><span>枚举</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/packages-crates-and-modules/packages-crates-and-modules" class="sidebar-heading clickable"><span>使用包、依赖箱和模块管理不断增长的项目</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-collections/common-collections" class="sidebar-heading clickable"><span>常用集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/error-handling/error-handling" class="sidebar-heading clickable"><span>错误处理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/generics/generics" class="sidebar-heading clickable"><span>泛型类型、特性和生命周期</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/testing/testing" class="sidebar-heading clickable"><span>测试</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/an-io-project/an-io-project" class="sidebar-heading clickable"><span>I/O 项目：构建命令行程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/functional-features/functional-features" class="sidebar-heading clickable"><span>函数式语言特性：迭代器与闭包</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/more-about-cargo/more-about-cargo" class="sidebar-heading clickable"><span>关于 Cargo 和 Crates.io 的更多信息</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/smart-pointers/smart-pointers" class="sidebar-heading clickable"><span>智能指针</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/concurrency/concurrency" class="sidebar-heading clickable"><span>无畏并发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/async-await/async-await" class="sidebar-heading clickable open"><span>异步编程基础：Async、Await、Futures 和 Streams</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust-doc/doc/async-await/futures-and-syntax.html" class="sidebar-link">Future 与异步语法</a></li><li><a href="/rust-doc/doc/async-await/concurrency-with-async.html" class="sidebar-link">应用异步并发</a></li><li><a href="/rust-doc/doc/async-await/more-futures.html" aria-current="page" class="active sidebar-link">处理任意数量的 Future</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust-doc/doc/async-await/more-futures.html#处理任意数量的-future" class="sidebar-link">处理任意数量的 Future</a></li></ul></li><li><a href="/rust-doc/doc/async-await/streams.html" class="sidebar-link">流：按顺序排列的 Future</a></li><li><a href="/rust-doc/doc/async-await/traits-for-async.html" class="sidebar-link">深入了解异步特性</a></li><li><a href="/rust-doc/doc/async-await/futures-tasks-threads.html" class="sidebar-link">整合：Future、任务和线程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/oop/oop" class="sidebar-heading clickable"><span>面向对象编程特性</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>附录</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="处理任意数量的-future"><a href="#处理任意数量的-future" class="header-anchor">#</a> 处理任意数量的 Future</h2> <p>在上一节中，当我们从使用两个 Future 切换到三个时，我们也不得不从使用 <code>join</code> 切换到使用 <code>join3</code>。每次我们改变想要 <code>join</code> 的 Future 数量时，都不得不调用不同的函数，这会很烦人。幸运的是，我们有一个 <code>join</code> 的宏形式，可以向其传递任意数量的参数。它还处理 Future 本身的 <code>await</code>。因此，我们可以将示例 17-13 中的代码重写为使用 <code>join!</code> 而不是 <code>join3</code>，如示例 17-14 所示。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> <span class="token keyword">mut</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx1 <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> tx1_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;future&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> rx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> rx<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;received '{value}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;more&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;for&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;you&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token macro property">join!</span><span class="token punctuation">(</span>tx1_fut<span class="token punctuation">,</span> tx_fut<span class="token punctuation">,</span> rx_fut<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-14：使用 <code>join!</code> 等待多个 Future</p> <p>这无疑比在 <code>join</code>、<code>join3</code>、<code>join4</code> 等之间来回切换要好得多！然而，即使是这种宏形式，也只在我们预先知道 Future 数量时才有效。但在实际的 Rust 开发中，将 Future 推入集合，然后等待其中部分或全部 Future 完成是一种常见模式。</p> <p>为了检查集合中的所有 Future，我们需要遍历并 <code>join</code> 它们。<code>trpl::join_all</code> 函数接受任何实现了 <code>Iterator</code> trait 的类型，你可以在第 13 章的 <a href="https://doc.rust-lang.org/book/ch13-02-iterators.html#the-iterator-trait-and-the-next-method" target="_blank" rel="noopener noreferrer">迭代器 trait 和 next 方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中了解到它，所以这似乎正是我们需要的。让我们尝试将 Future 放入一个 vector 中，并用 <code>join_all</code> 替换 <code>join!</code>，如示例 17-15 所示。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> <span class="token keyword">mut</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx1 <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> tx1_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;future&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> rx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> rx<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;received '{value}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;more&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;for&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;you&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> futures <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>tx1_fut<span class="token punctuation">,</span> rx_fut<span class="token punctuation">,</span> tx_fut<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">join_all</span><span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-15：将匿名 Future 存储在 vector 中并调用 <code>join_all</code></p> <p>不幸的是，这段代码无法编译。相反，我们得到了这个错误：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>error<span class="token punctuation">[</span><span class="token constant">E0308</span><span class="token punctuation">]</span><span class="token punctuation">:</span> mismatched types
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">45</span><span class="token punctuation">:</span><span class="token number">37</span>
   <span class="token operator">|</span>
<span class="token number">10</span> <span class="token operator">|</span>         <span class="token keyword">let</span> tx1_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
   <span class="token operator">|</span>                       <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> the expected `<span class="token keyword">async</span>` block
<span class="token punctuation">...</span>
<span class="token number">24</span> <span class="token operator">|</span>         <span class="token keyword">let</span> rx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
   <span class="token operator">|</span>                      <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> the found `<span class="token keyword">async</span>` block
<span class="token punctuation">...</span>
<span class="token number">45</span> <span class="token operator">|</span>         <span class="token keyword">let</span> futures <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>tx1_fut<span class="token punctuation">,</span> rx_fut<span class="token punctuation">,</span> tx_fut<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                                     <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> expected `<span class="token keyword">async</span>` block<span class="token punctuation">,</span> found a different `<span class="token keyword">async</span>` block
   <span class="token operator">|</span>
   <span class="token operator">=</span> note<span class="token punctuation">:</span> expected `<span class="token keyword">async</span>` block `<span class="token punctuation">{</span><span class="token keyword">async</span> block<span class="token operator">@</span>src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">33</span><span class="token punctuation">}</span>`
              found `<span class="token keyword">async</span>` block `<span class="token punctuation">{</span><span class="token keyword">async</span> block<span class="token operator">@</span>src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">:</span><span class="token number">22</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token punctuation">:</span><span class="token number">27</span><span class="token punctuation">}</span>`
   <span class="token operator">=</span> note<span class="token punctuation">:</span> no two <span class="token keyword">async</span> blocks<span class="token punctuation">,</span> even <span class="token keyword">if</span> identical<span class="token punctuation">,</span> have the same <span class="token keyword">type</span>
   <span class="token operator">=</span> help<span class="token punctuation">:</span> consider pinning your <span class="token keyword">async</span> block and casting it to a <span class="token keyword">trait</span> <span class="token type-definition class-name">object</span>
</code></pre></div><p>这可能令人惊讶。毕竟，所有的异步块都没有返回任何东西，所以每个都生成一个 <code>Future&lt;Output = ()&gt;</code>。但是请记住，<code>Future</code> 是一个 trait，编译器会为每个异步块创建一个唯一的枚举。你不能将两个不同的手写结构体放入 <code>Vec</code> 中，同样的规则也适用于编译器生成的不同枚举。</p> <p>为了解决这个问题，我们需要使用 trait 对象，就像我们在第 12 章的 <a href="https://doc.rust-lang.org/book/ch12-03-improving-error-handling-and-modularity.html" target="_blank" rel="noopener noreferrer">从 <code>run</code> 函数返回错误<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中所做的那样。（我们将在第 18 章详细介绍 trait 对象。）使用 trait 对象可以让我们将这些类型生成的每个匿名 Future 都视为相同的类型，因为它们都实现了 <code>Future</code> trait。</p> <blockquote><p>注意：在第 8 章的 <a href="https://doc.rust-lang.org/book/ch08-01-vectors.html#using-an-enum-to-store-multiple-types" target="_blank" rel="noopener noreferrer">使用枚举存储多个值<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中，我们讨论了在 <code>Vec</code> 中包含多种类型的另一种方法：使用枚举来表示 <code>vector</code> 中可能出现的每种类型。但在这里我们不能这样做。一方面，我们无法命名这些不同的类型，因为它们是匿名的。另一方面，我们最初选择 <code>vector</code> 和 <code>join_all</code> 的原因是为了能够处理动态集合的 Future，而我们只关心它们具有相同的输出类型。</p></blockquote> <p>我们首先将 <code>vec!</code> 中的每个 Future 包装在 <code>Box::new</code> 中，如示例 17-16 所示。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> <span class="token keyword">mut</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx1 <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> tx1_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;future&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> rx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> rx<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;received '{value}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;more&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;for&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;you&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> futures <span class="token operator">=</span>
            <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>tx1_fut<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>rx_fut<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>tx_fut<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">join_all</span><span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-16：使用 <code>Box::new</code> 对齐 <code>Vec</code> 中 Future 的类型</p> <p>不幸的是，这段代码仍然无法编译。实际上，我们得到了与之前相同的基本错误，针对第二个和第三个 <code>Box::new</code> 调用，以及引用 <code>Unpin</code> trait 的新错误。我们稍后会回到 <code>Unpin</code> 错误。首先，让我们通过显式标注 <code>futures</code> 变量的类型来修复 <code>Box::new</code> 调用上的类型错误（参见示例 17-17）。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> <span class="token keyword">mut</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx1 <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> tx1_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;future&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> rx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> rx<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;received '{value}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;more&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;for&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;you&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> futures<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
            <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>tx1_fut<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>rx_fut<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>tx_fut<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">join_all</span><span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-17：通过显式类型声明修复其余类型不匹配错误</p> <p>这个类型声明有点复杂，我们来一步步分析：</p> <ol><li>最内层的类型是 Future 本身。我们通过写入 <code>Future&lt;Output = ()&gt;</code> 明确指出 Future 的输出是单元类型 <code>()</code>。</li> <li>然后我们用 <code>dyn</code> 标注 trait，将其标记为动态的。</li> <li>整个 trait 引用被包装在一个 <code>Box</code> 中。</li> <li>最后，我们明确声明 <code>futures</code> 是一个包含这些项的 <code>Vec</code>。</li></ol> <p>这已经带来了很大的不同。现在当我们运行编译器时，我们只会得到提到 <code>Unpin</code> 的错误。尽管有三个错误，但它们的内容非常相似。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>error<span class="token punctuation">[</span><span class="token constant">E0277</span><span class="token punctuation">]</span><span class="token punctuation">:</span> `<span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>` cannot be unpinned
   <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">:</span><span class="token number">24</span>
    <span class="token operator">|</span>
<span class="token number">49</span>  <span class="token operator">|</span>         <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">join_all</span><span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token operator">|</span>         <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> the <span class="token keyword">trait</span> `<span class="token class-name">Unpin</span>` is not implemented <span class="token keyword">for</span> `<span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>`
    <span class="token operator">|</span>         <span class="token operator">|</span>
    <span class="token operator">|</span>         required by a bound introduced by this call
    <span class="token operator">|</span>
    <span class="token operator">=</span> note<span class="token punctuation">:</span> consider using the `<span class="token macro property">pin!</span>` <span class="token keyword">macro</span>
            consider using `<span class="token class-name">Box</span><span class="token punctuation">::</span>pin` <span class="token keyword">if</span> you need to access the pinned value outside of the current scope
    <span class="token operator">=</span> note<span class="token punctuation">:</span> required <span class="token keyword">for</span> `<span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span>` to implement `<span class="token class-name">Future</span>`
note<span class="token punctuation">:</span> required by a bound <span class="token keyword">in</span> `join_all`
   <span class="token operator">-</span><span class="token punctuation">-&gt;</span> file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//home/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/futures-util-0.3.30/src/future/join_all.rs:105:14</span>
    <span class="token operator">|</span>
<span class="token number">102</span> <span class="token operator">|</span> <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">join_all</span><span class="token operator">&lt;</span><span class="token class-name">I</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>iter<span class="token punctuation">:</span> <span class="token class-name">I</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">JoinAll</span><span class="token operator">&lt;</span><span class="token class-name">I</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token operator">&gt;</span>
    <span class="token operator">|</span>        <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> required by a bound <span class="token keyword">in</span> this function
<span class="token punctuation">...</span>
<span class="token number">105</span> <span class="token operator">|</span>     <span class="token class-name">I</span><span class="token punctuation">::</span><span class="token class-name">Item</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span>
    <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>              <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> required by this bound <span class="token keyword">in</span> `join_all`

error<span class="token punctuation">[</span><span class="token constant">E0277</span><span class="token punctuation">]</span><span class="token punctuation">:</span> `<span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>` cannot be unpinned
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">:</span><span class="token number">9</span>
   <span class="token closure-punctuation punctuation">|</span></span>
<span class="token number">49</span> <span class="token operator">|</span>         <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">join_all</span><span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>         <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> the <span class="token keyword">trait</span> `<span class="token class-name">Unpin</span>` is not implemented <span class="token keyword">for</span> `<span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>`
   <span class="token operator">|</span>
   <span class="token operator">=</span> note<span class="token punctuation">:</span> consider using the `<span class="token macro property">pin!</span>` <span class="token keyword">macro</span>
           consider using `<span class="token class-name">Box</span><span class="token punctuation">::</span>pin` <span class="token keyword">if</span> you need to access the pinned value outside of the current scope
   <span class="token operator">=</span> note<span class="token punctuation">:</span> required <span class="token keyword">for</span> `<span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span>` to implement `<span class="token class-name">Future</span>`
note<span class="token punctuation">:</span> required by a bound <span class="token keyword">in</span> `<span class="token namespace">futures_util<span class="token punctuation">::</span>future<span class="token punctuation">::</span>join_all<span class="token punctuation">::</span></span><span class="token class-name">JoinAll</span>`
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//home/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/futures-util-0.3.30/src/future/join_all.rs:29:8</span>
   <span class="token operator">|</span>
<span class="token number">27</span> <span class="token operator">|</span> <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">JoinAll</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">&gt;</span>
   <span class="token operator">|</span>            <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> required by a bound <span class="token keyword">in</span> this <span class="token keyword">struct</span>
<span class="token type-definition class-name">28</span> <span class="token operator">|</span> <span class="token keyword">where</span>
<span class="token number">29</span> <span class="token operator">|</span>     <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span>
   <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>        <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> required by this bound <span class="token keyword">in</span> `<span class="token class-name">JoinAll</span>`

error<span class="token punctuation">[</span><span class="token constant">E0277</span><span class="token punctuation">]</span><span class="token punctuation">:</span> `<span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>` cannot be unpinned
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">49</span><span class="token punctuation">:</span><span class="token number">33</span>
   <span class="token closure-punctuation punctuation">|</span></span>
<span class="token number">49</span> <span class="token operator">|</span>         <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">join_all</span><span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>                                 <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> the <span class="token keyword">trait</span> `<span class="token class-name">Unpin</span>` is not implemented <span class="token keyword">for</span> `<span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>`
   <span class="token operator">|</span>
   <span class="token operator">=</span> note<span class="token punctuation">:</span> consider using the `<span class="token macro property">pin!</span>` <span class="token keyword">macro</span>
           consider using `<span class="token class-name">Box</span><span class="token punctuation">::</span>pin` <span class="token keyword">if</span> you need to access the pinned value outside of the current scope
   <span class="token operator">=</span> note<span class="token punctuation">:</span> required <span class="token keyword">for</span> `<span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span>` to implement `<span class="token class-name">Future</span>`
note<span class="token punctuation">:</span> required by a bound <span class="token keyword">in</span> `<span class="token namespace">futures_util<span class="token punctuation">::</span>future<span class="token punctuation">::</span>join_all<span class="token punctuation">::</span></span><span class="token class-name">JoinAll</span>`
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//home/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/futures-util-0.3.30/src/future/join_all.rs:29:8</span>
   <span class="token operator">|</span>
<span class="token number">27</span> <span class="token operator">|</span> <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">JoinAll</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">&gt;</span>
   <span class="token operator">|</span>            <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> required by a bound <span class="token keyword">in</span> this <span class="token keyword">struct</span>
<span class="token type-definition class-name">28</span> <span class="token operator">|</span> <span class="token keyword">where</span>
<span class="token number">29</span> <span class="token operator">|</span>     <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token punctuation">,</span>
   <span class="token operator">|</span>        <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> required by this bound <span class="token keyword">in</span> `<span class="token class-name">JoinAll</span>`

<span class="token class-name">For</span> more information about this error<span class="token punctuation">,</span> <span class="token keyword">try</span> `rustc <span class="token operator">-</span><span class="token operator">-</span>explain <span class="token constant">E0277</span>`<span class="token punctuation">.</span>
error<span class="token punctuation">:</span> could not compile `async_await` <span class="token punctuation">(</span>bin <span class="token string">&quot;async_await&quot;</span><span class="token punctuation">)</span> due to <span class="token number">3</span> previous errors
</code></pre></div><p>这需要消化的内容很多，所以我们来分解一下。消息的第一部分告诉我们，第一个异步块（src/main.rs:8:23: 20:10）没有实现 <code>Unpin</code> trait，并建议使用 <code>pin!</code> 或 <code>Box::pin</code> 来解决。在本章后面，我们将深入探讨 <code>Pin</code> 和 <code>Unpin</code> 的更多细节。不过，目前我们可以按照编译器的建议来解决问题。在示例 17-18 中，我们首先从 <code>std::pin</code> 导入 <code>Pin</code>。接下来，我们更新 <code>futures</code> 的类型注解，用 <code>Pin</code> 包装每个 <code>Box</code>。最后，我们使用 <code>Box::pin</code> 来 <code>pin</code> Future 本身。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>pin<span class="token punctuation">::</span></span><span class="token class-name">Pin</span><span class="token punctuation">;</span>

<span class="token comment">// -- snip --</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> <span class="token keyword">mut</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx1 <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> tx1_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;future&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> rx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> rx<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;received '{value}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx_fut <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;more&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;for&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;you&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> futures<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span>
            <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span>tx1_fut<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span>rx_fut<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">pin</span><span class="token punctuation">(</span>tx_fut<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">join_all</span><span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-18：使用 <code>Pin</code> 和 <code>Box::pin</code> 使 <code>Vec</code> 类型检查通过</p> <p>如果我们编译并运行它，我们最终会得到我们期望的输出：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>received <span class="token lifetime-annotation symbol">'hi</span>'
received <span class="token lifetime-annotation symbol">'more</span>'
received <span class="token lifetime-annotation symbol">'from</span>'
received <span class="token lifetime-annotation symbol">'messages</span>'
received <span class="token lifetime-annotation symbol">'the</span>'
received <span class="token lifetime-annotation symbol">'for</span>'
received <span class="token lifetime-annotation symbol">'future</span>'
received <span class="token lifetime-annotation symbol">'you</span>'
</code></pre></div><p>呼！</p> <p>这里还有一些值得探讨的地方。首先，使用 <code>Pin&lt;Box&lt;T&gt;&gt;</code> 会因为将这些 Future 放到堆上而增加少量开销——我们这样做只是为了让类型对齐。毕竟，我们实际上不需要堆分配：这些 Future 是此特定函数的局部变量。如前所述，<code>Pin</code> 本身是一个包装类型，因此我们可以获得在 <code>Vec</code> 中拥有单一类型的好处——这是我们最初选择 <code>Box</code> 的原因——而无需进行堆分配。我们可以使用 <code>std::pin::pin</code> 宏直接将 <code>Pin</code> 用于每个 Future。</p> <p>然而，我们仍然必须明确 <code>pin</code> 引用的类型；否则，Rust 仍然不知道将它们解释为动态 trait 对象，而这正是我们在 <code>Vec</code> 中所需要的。因此，我们将 <code>pin</code> 添加到 <code>std::pin</code> 的导入列表中。然后，我们可以在定义每个 Future 时使用 <code>pin!</code>，并将 <code>futures</code> 定义为一个包含 <code>pin</code> 动态 Future 类型可变引用的 <code>Vec</code>，如示例 17-19 所示。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>pin<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Pin</span><span class="token punctuation">,</span> pin<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// -- snip --</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> <span class="token keyword">mut</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx1 <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> tx1_fut <span class="token operator">=</span> <span class="token macro property">pin!</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token comment">// --snip--</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;from&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;the&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;future&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx1<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> rx_fut <span class="token operator">=</span> <span class="token macro property">pin!</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token comment">// --snip--</span>
            <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=</span> rx<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;received '{value}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> tx_fut <span class="token operator">=</span> <span class="token macro property">pin!</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">move</span> <span class="token punctuation">{</span>
            <span class="token comment">// --snip--</span>
            <span class="token keyword">let</span> vals <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;more&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;messages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;for&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;you&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> val <span class="token keyword">in</span> vals <span class="token punctuation">{</span>
                tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> futures<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Pin</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">dyn</span> <span class="token class-name">Future</span><span class="token operator">&lt;</span><span class="token class-name">Output</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
            <span class="token macro property">vec!</span><span class="token punctuation">[</span>tx1_fut<span class="token punctuation">,</span> rx_fut<span class="token punctuation">,</span> tx_fut<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">join_all</span><span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-19：直接使用 <code>pin!</code> 宏 <code>Pin</code> Future 以避免不必要的堆分配</p> <p>我们之所以能走到这一步，是因为我们忽略了可能存在不同 <code>Output</code> 类型的事实。例如，在示例 17-20 中，<code>a</code> 的匿名 Future 实现了 <code>Future&lt;Output = u32&gt;</code>，<code>b</code> 的匿名 Future 实现了 <code>Future&lt;Output = &amp;str&gt;</code>，而 <code>c</code> 的匿名 Future 实现了 <code>Future&lt;Output = bool&gt;</code>。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span> <span class="token number">1u32</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span> <span class="token string">&quot;Hello!&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token punctuation">(</span>a_result<span class="token punctuation">,</span> b_result<span class="token punctuation">,</span> c_result<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token macro property">join!</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{a_result}, {b_result}, {c_result}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-20：三个不同类型的 Future</p> <p>我们可以使用 <code>trpl::join!</code> 来等待它们，因为它允许我们传入多个 Future 类型并生成这些类型的元组。我们不能使用 <code>trpl::join_all</code>，因为它要求传入的所有 Future 都具有相同的类型。请记住，正是这个错误让我们开始了 <code>Pin</code> 的冒险！</p> <p>这是一个基本的权衡：我们可以使用 <code>join_all</code> 处理动态数量的 Future，只要它们都具有相同的类型；或者我们可以使用 <code>join</code> 函数或 <code>join!</code> 宏处理固定数量的 Future，即使它们具有不同的类型。这与我们在 Rust 中处理任何其他类型时面临的情况相同。Future 并非特殊，尽管我们有一些很好的语法来处理它们，这是一件好事。</p> <h3 id="竞速-future"><a href="#竞速-future" class="header-anchor">#</a> 竞速 Future</h3> <p>当我们使用 <code>join</code> 系列函数和宏“连接”Future 时，我们要求所有 Future 都完成后才能继续。然而，有时我们只需要集合中的某个 Future 完成即可继续——这有点类似于让一个 Future 与另一个 Future 竞速。</p> <p>在示例 17-21 中，我们再次使用 <code>trpl::race</code> 让两个 Future，<code>slow</code> 和 <code>fast</code> 相互竞速。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> slow <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'slow' started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'slow' finished.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> fast <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'fast' started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'fast' finished.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">race</span><span class="token punctuation">(</span>slow<span class="token punctuation">,</span> fast<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-21：使用 <code>race</code> 获取最先完成的 Future 的结果</p> <p>每个 Future 在开始运行时打印一条消息，通过调用并等待 <code>sleep</code> 暂停一段时间，然后在完成时打印另一条消息。然后我们将 <code>slow</code> 和 <code>fast</code> 都传递给 <code>trpl::race</code> 并等待其中一个完成。（这里的结果并不令人惊讶：<code>fast</code> 赢了。）与我们在 <a href="https://doc.rust-lang.org/book/ch17-01-futures-and-syntax.html#our-first-async-program" target="_blank" rel="noopener noreferrer">“我们的第一个异步程序”<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中使用 <code>race</code> 不同，我们在这里忽略了它返回的 <code>Either</code> 实例，因为所有有趣的行为都发生在异步块的主体中。</p> <p>请注意，如果您颠倒 <code>race</code> 参数的顺序，即使 <code>fast</code> Future 总是首先完成，“started”消息的顺序也会改变。这是因为这个特定的 <code>race</code> 函数的实现是不公平的。它总是按照传入参数的顺序运行 Future。其他实现是公平的，会随机选择哪个 Future 首先进行轮询。无论我们使用的 <code>race</code> 实现是否公平，其中一个 Future 都将在其主体中的第一个 <code>await</code> 点之前运行，然后另一个任务才能开始。</p> <p>回想一下 <a href="https://doc.rust-lang.org/book/ch17-01-futures-and-syntax.html#our-first-async-program" target="_blank" rel="noopener noreferrer">我们的第一个异步程序<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中，在每个 <code>await</code> 点，如果正在等待的 Future 尚未准备好，Rust 会给运行时一个暂停任务并切换到另一个任务的机会。反之亦然：Rust 只在 <code>await</code> 点暂停异步块并将控制权交还给运行时。<code>await</code> 点之间的一切都是同步的。</p> <p>这意味着如果您在没有 <code>await</code> 点的异步块中执行大量工作，该 Future 将阻止任何其他 Future 的进展。您有时可能会听到这被称为一个 Future“饿死”其他 Future。在某些情况下，这可能不是什么大问题。但是，如果您正在进行某种昂贵的设置或长时间运行的工作，或者您的 Future 将无限期地执行某个特定任务，您就需要考虑何时何地将控制权交还给运行时。</p> <p>同样，如果您有长时间运行的阻塞操作，异步可以成为一个有用的工具，为程序的不同部分相互关联提供方式。</p> <p>But how would you hand control back to the runtime in those cases?</p> <h3 id="yielding-control-to-the-runtime"><a href="#yielding-control-to-the-runtime" class="header-anchor">#</a> Yielding Control to the Runtime</h3> <p>Let’s simulate a long-running operation. Listing 17-22 introduces a slow function.</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>thread<span class="token punctuation">,</span> <span class="token namespace">time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token comment">// We will call `slow` here later</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">slow</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> ms<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'{name}' ran for {ms}ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Listing 17-22: Using thread::sleep to simulate slow operations
This code uses std::thread::sleep instead of trpl::sleep so that calling slow will block the current thread for some number of milliseconds. We can use slow to stand in for real-world operations that are both long-running and blocking.</p> <p>In Listing 17-23, we use slow to emulate doing this kind of CPU-bound work in a pair of futures.</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>thread<span class="token punctuation">,</span> <span class="token namespace">time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'a' started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'a' finished.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'b' started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'b' finished.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">race</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">slow</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> ms<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'{name}' ran for {ms}ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-23：使用 <code>thread::sleep</code> 模拟慢速操作</p> <p>首先，每个 Future 只有在执行完一系列慢速操作后才将控制权交还给运行时。如果您运行此代码，您将看到以下输出：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token char">'a'</span> started<span class="token punctuation">.</span>
<span class="token char">'a'</span> ran <span class="token keyword">for</span> 30ms
<span class="token char">'a'</span> ran <span class="token keyword">for</span> 10ms
<span class="token char">'a'</span> ran <span class="token keyword">for</span> 20ms
<span class="token char">'b'</span> started<span class="token punctuation">.</span>
<span class="token char">'b'</span> ran <span class="token keyword">for</span> 75ms
<span class="token char">'b'</span> ran <span class="token keyword">for</span> 10ms
<span class="token char">'b'</span> ran <span class="token keyword">for</span> 15ms
<span class="token char">'b'</span> ran <span class="token keyword">for</span> 350ms
<span class="token char">'a'</span> finished<span class="token punctuation">.</span>
</code></pre></div><p>与我们之前的示例一样，<code>race</code> 仍然在 <code>a</code> 完成后立即结束。然而，两个 Future 之间没有交错执行。<code>a</code> Future 会完成所有工作，直到 <code>trpl::sleep</code> 调用被 <code>await</code>，然后 <code>b</code> Future 会完成所有工作，直到它自己的 <code>trpl::sleep</code> 调用被 <code>await</code>，最后 <code>a</code> Future 完成。为了让两个 Future 在它们的慢速任务之间取得进展，我们需要 <code>await</code> 点，以便将控制权交还给运行时。这意味着我们需要一些可以 <code>await</code> 的东西！</p> <p>我们已经可以在示例 17-23 中看到这种交接：如果我们移除 <code>a</code> Future 末尾的 <code>trpl::sleep</code>，它将在 <code>b</code> Future 完全没有运行的情况下完成。让我们尝试使用 <code>sleep</code> 函数作为起点，让操作轮流进行，如示例 17-24 所示。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>thread<span class="token punctuation">,</span> <span class="token namespace">time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> one_ms <span class="token operator">=</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'a' started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>one_ms<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>one_ms<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>one_ms<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'a' finished.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'b' started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>one_ms<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>one_ms<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>one_ms<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>one_ms<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'b' finished.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">race</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">slow</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> ms<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'{name}' ran for {ms}ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-24：使用 <code>sleep</code> 让操作轮流进行</p> <p>在示例 17-24 中，我们在每次调用 <code>slow</code> 之间添加了带有 <code>await</code> 点的 <code>trpl::sleep</code> 调用。现在两个 Future 的工作是交错进行的：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token char">'a'</span> started<span class="token punctuation">.</span>
<span class="token char">'b'</span> started<span class="token punctuation">.</span>
<span class="token char">'a'</span> ran <span class="token keyword">for</span> 30ms
<span class="token char">'b'</span> ran <span class="token keyword">for</span> 75ms
<span class="token char">'a'</span> ran <span class="token keyword">for</span> 10ms
<span class="token char">'b'</span> ran <span class="token keyword">for</span> 10ms
<span class="token char">'a'</span> ran <span class="token keyword">for</span> 20ms
<span class="token char">'b'</span> ran <span class="token keyword">for</span> 15ms
<span class="token char">'a'</span> finished<span class="token punctuation">.</span>
<span class="token char">'b'</span> ran <span class="token keyword">for</span> 350ms
<span class="token char">'b'</span> finished<span class="token punctuation">.</span>
</code></pre></div><p><code>a</code> Future 在将控制权交给 <code>b</code> 之前仍然会运行一段时间，因为它在调用 <code>trpl::sleep</code> 之前就调用了 <code>slow</code>，但在此之后，每当其中一个 Future 达到 <code>await</code> 点时，它们就会来回切换。在这种情况下，我们在每次调用 <code>slow</code> 之后都这样做了，但我们可以根据最适合我们的方式来分解工作。</p> <p>然而，我们这里并不真的想休眠：我们希望尽可能快地取得进展。我们只需要将控制权交还给运行时。我们可以直接使用 <code>yield_now</code> 函数来做到这一点。在示例 17-25 中，我们将所有这些 <code>sleep</code> 调用替换为 <code>yield_now</code>。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>thread<span class="token punctuation">,</span> <span class="token namespace">time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'a' started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'a' finished.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'b' started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token function">slow</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token number">350</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'b' finished.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">race</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">slow</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">,</span> ms<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;'{name}' ran for {ms}ms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-25：使用 <code>yield_now</code> 让操作轮流进行</p> <p>这段代码不仅意图更清晰，而且比使用 <code>sleep</code> 快得多，因为像 <code>sleep</code> 这样的计时器通常在粒度上有限制。例如，我们使用的 <code>sleep</code> 版本即使我们传入一纳秒的 <code>Duration</code>，也总是会至少休眠一毫秒。再说一次，现代计算机速度很快：它们在一毫秒内可以做很多事情！</p> <p>你可以通过设置一个小的基准测试来亲自验证这一点，例如示例 17-26 中的测试。（这不是一种特别严格的性能测试方法，但足以在这里展示差异。）</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Duration</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> one_ns <span class="token operator">=</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_nanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">1000</span> <span class="token punctuation">{</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>one_ns<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">&quot;'sleep' version finished after {} seconds.&quot;</span><span class="token punctuation">,</span>
            time<span class="token punctuation">.</span><span class="token function">as_secs_f32</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">1000</span> <span class="token punctuation">{</span>
                <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">&quot;'yield' version finished after {} seconds.&quot;</span><span class="token punctuation">,</span>
            time<span class="token punctuation">.</span><span class="token function">as_secs_f32</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-26：比较 <code>sleep</code> 和 <code>yield_now</code> 的性能</p> <p>在这里，我们跳过所有状态打印，向 <code>trpl::sleep</code> 传递一个一纳秒的 <code>Duration</code>，并让每个 Future 独立运行，不在 Future 之间进行切换。然后我们运行 1,000 次迭代，看看使用 <code>trpl::sleep</code> 的 Future 与使用 <code>trpl::yield_now</code> 的 Future 相比需要多长时间。</p> <p><code>yield_now</code> 版本要快得多！</p> <p>这意味着异步即使对于计算密集型任务也很有用，这取决于你的程序还在做什么，因为它提供了一个有用的工具来构建程序不同部分之间的关系。这是一种协作式多任务处理形式，其中每个 Future 都有权通过 <code>await</code> 点决定何时交出控制权。因此，每个 Future 也有责任避免阻塞太长时间。在一些基于 Rust 的嵌入式操作系统中，这是唯一的多任务处理方式！</p> <p>当然，在实际代码中，你通常不会在每一行都交替使用函数调用和 <code>await</code> 点。虽然以这种方式交出控制权相对便宜，但它并非没有成本。在许多情况下，尝试分解计算密集型任务可能会使其显著变慢，因此有时为了整体性能，最好让操作短暂阻塞。始终进行测量以查看代码的实际性能瓶颈在哪里。但是，如果你看到大量工作串行发生而你期望它们并发发生，那么底层动态很重要。</p> <h3 id="构建我们自己的异步抽象"><a href="#构建我们自己的异步抽象" class="header-anchor">#</a> 构建我们自己的异步抽象</h3> <p>我们还可以将 Future 组合在一起以创建新的模式。例如，我们可以使用已有的异步构建块来构建一个超时函数。完成后，结果将是另一个构建块，我们可以用它来创建更多的异步抽象。</p> <p>示例 17-27 展示了我们期望这个超时函数如何与一个慢速 Future 一起工作。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> slow <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token string">&quot;I finished!&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">match</span> <span class="token function">timeout</span><span class="token punctuation">(</span>slow<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Succeeded with '{message}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed after {} seconds&quot;</span><span class="token punctuation">,</span> duration<span class="token punctuation">.</span><span class="token function">as_secs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-27：使用我们设想的超时函数来运行有时间限制的慢速操作</p> <p>让我们来实现它！首先，让我们考虑一下 <code>timeout</code> 的 API：</p> <ul><li>它本身需要是一个 <code>async</code> 函数，这样我们就可以 <code>await</code> 它。</li> <li>它的第一个参数应该是一个要运行的 Future。我们可以将其泛型化，使其适用于任何 Future。</li> <li>它的第二个参数将是最大等待时间。如果我们使用 <code>Duration</code>，这将很容易传递给 <code>trpl::sleep</code>。</li> <li>它应该返回一个 <code>Result</code>。如果 Future 成功完成，<code>Result</code> 将是 <code>Ok</code>，其中包含 Future 产生的值。如果超时首先过去，<code>Result</code> 将是 <code>Err</code>，其中包含超时等待的持续时间。</li></ul> <p>示例 17-28 展示了此声明。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> slow <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token string">&quot;Finally finished&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">match</span> <span class="token function">timeout</span><span class="token punctuation">(</span>slow<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Succeeded with '{message}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed after {} seconds&quot;</span><span class="token punctuation">,</span> duration<span class="token punctuation">.</span><span class="token function">as_secs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">timeout</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    future_to_try<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">,</span>
    max_time<span class="token punctuation">:</span> <span class="token class-name">Duration</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Here is where our implementation will go!</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-28：定义 <code>timeout</code> 的签名</p> <p>这满足了我们对类型的目标。现在让我们考虑一下我们需要的功能：我们希望将传入的 Future 与持续时间进行竞争。我们可以使用 <code>trpl::sleep</code> 从持续时间创建一个计时器 Future，并使用 <code>trpl::race</code> 将该计时器与调用者传入的 Future 一起运行。</p> <p>我们还知道 <code>race</code> 是不公平的，它按照参数传入的顺序轮询。因此，我们首先将 <code>future_to_try</code> 传递给 <code>race</code>，这样即使 <code>max_time</code> 是一个非常短的持续时间，它也有机会完成。如果 <code>future_to_try</code> 首先完成，<code>race</code> 将返回 <code>Left</code>，其中包含 <code>future_to_try</code> 的输出。如果计时器首先完成，<code>race</code> 将返回 <code>Right</code>，其中包含计时器的输出 <code>()</code>。</p> <p>In Listing 17-29, we match on the result of awaiting trpl::race.</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">trpl</span><span class="token punctuation">;</span> <span class="token comment">// required for mdbook test</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token class-name">Either</span><span class="token punctuation">;</span>

<span class="token comment">// --snip--</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> slow <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
            <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">;</span>
            <span class="token string">&quot;Finally finished&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">match</span> <span class="token function">timeout</span><span class="token punctuation">(</span>slow<span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Succeeded with '{message}'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Failed after {} seconds&quot;</span><span class="token punctuation">,</span> duration<span class="token punctuation">.</span><span class="token function">as_secs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">timeout</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Future</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    future_to_try<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">,</span>
    max_time<span class="token punctuation">:</span> <span class="token class-name">Duration</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">::</span><span class="token class-name">Output</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">match</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">race</span><span class="token punctuation">(</span>future_to_try<span class="token punctuation">,</span> <span class="token namespace">trpl<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span>max_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span> <span class="token punctuation">{</span>
        <span class="token class-name">Either</span><span class="token punctuation">::</span><span class="token class-name">Left</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Either</span><span class="token punctuation">::</span><span class="token class-name">Right</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>max_time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 17-29：使用 <code>race</code> 和 <code>sleep</code> 定义 <code>timeout</code></p> <p>如果 <code>future_to_try</code> 成功并返回 <code>Left(output)</code>，我们返回 <code>Ok(output)</code>。如果 <code>sleep</code> 计时器反而超时并返回 <code>Right(())</code>，我们忽略 <code>()</code> 并返回 <code>Err(max_time)</code>。</p> <p>这样，我们就用另外两个异步辅助函数构建了一个可用的超时函数。如果运行我们的代码，它将在超时后打印失败模式：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token class-name">Failed</span> after <span class="token number">2</span> seconds
</code></pre></div><p>因为 Future 可以与其他 Future 组合，所以你可以使用更小的异步构建块来构建真正强大的工具。例如，你可以使用相同的方法将超时与重试结合起来，进而将它们用于网络调用等操作（本章开头的一个示例）。</p> <p>实际上，你通常会直接使用 <code>async</code> 和 <code>await</code>，其次是 <code>join</code>、<code>join_all</code>、<code>race</code> 等函数和宏。你只需要偶尔使用 <code>pin</code> 来将 Future 与这些 API 结合使用。</p> <p>我们现在已经看到了同时处理多个 Future 的多种方法。接下来，我们将研究如何使用流（streams）按时间顺序处理多个 Future。不过，这里还有几点你可能需要首先考虑：</p> <ul><li>我们使用 <code>Vec</code> 和 <code>join_all</code> 来等待某个组中的所有 Future 完成。你如何使用 <code>Vec</code> 来按顺序处理一组 Future 呢？这样做有什么权衡？</li> <li>查看 <code>futures</code> crate 中的 <code>futures::stream::FuturesUnordered</code> 类型。使用它与使用 <code>Vec</code> 有何不同？(不用担心它是来自 crate 的流部分；它与任何 Future 集合都能很好地配合使用。)</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rust-doc/doc/async-await/concurrency-with-async.html" class="prev">
        应用异步并发
      </a></span> <span class="next"><a href="/rust-doc/doc/async-await/streams.html">
        流：按顺序排列的 Future
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/rust-doc/assets/js/app.a88c00c6.js" defer></script><script src="/rust-doc/assets/js/2.de3bffe6.js" defer></script><script src="/rust-doc/assets/js/1.5cc4c8d6.js" defer></script><script src="/rust-doc/assets/js/53.229b8eab.js" defer></script>
  </body>
</html>
