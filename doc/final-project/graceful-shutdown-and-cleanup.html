<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>优雅关闭和清理 | rust语言中文文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/rust-doc/logo.svg">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="一门赋予每个人构建可靠且高效软件能力的语言。">
    
    <link rel="preload" href="/rust-doc/assets/css/0.styles.b04b0b2c.css" as="style"><link rel="preload" href="/rust-doc/assets/js/app.f0d374f6.js" as="script"><link rel="preload" href="/rust-doc/assets/js/2.f80c1e3f.js" as="script"><link rel="preload" href="/rust-doc/assets/js/1.fd67daac.js" as="script"><link rel="preload" href="/rust-doc/assets/js/85.186197b8.js" as="script"><link rel="prefetch" href="/rust-doc/assets/js/10.eb17c9b1.js"><link rel="prefetch" href="/rust-doc/assets/js/100.fefafa9b.js"><link rel="prefetch" href="/rust-doc/assets/js/101.17ee2c97.js"><link rel="prefetch" href="/rust-doc/assets/js/102.348689f8.js"><link rel="prefetch" href="/rust-doc/assets/js/103.b1fc7e8c.js"><link rel="prefetch" href="/rust-doc/assets/js/104.3183edc5.js"><link rel="prefetch" href="/rust-doc/assets/js/105.a6cc6f0f.js"><link rel="prefetch" href="/rust-doc/assets/js/106.ffb0a0de.js"><link rel="prefetch" href="/rust-doc/assets/js/107.0ce758b4.js"><link rel="prefetch" href="/rust-doc/assets/js/108.1da873f8.js"><link rel="prefetch" href="/rust-doc/assets/js/109.d28576a3.js"><link rel="prefetch" href="/rust-doc/assets/js/11.4d96857f.js"><link rel="prefetch" href="/rust-doc/assets/js/110.714de49b.js"><link rel="prefetch" href="/rust-doc/assets/js/111.f34ee52d.js"><link rel="prefetch" href="/rust-doc/assets/js/112.150389e0.js"><link rel="prefetch" href="/rust-doc/assets/js/113.c600da56.js"><link rel="prefetch" href="/rust-doc/assets/js/114.8dd55411.js"><link rel="prefetch" href="/rust-doc/assets/js/115.d81d1edd.js"><link rel="prefetch" href="/rust-doc/assets/js/116.589a38c1.js"><link rel="prefetch" href="/rust-doc/assets/js/117.df8467d8.js"><link rel="prefetch" href="/rust-doc/assets/js/118.c981eed9.js"><link rel="prefetch" href="/rust-doc/assets/js/119.82c7f0ad.js"><link rel="prefetch" href="/rust-doc/assets/js/12.0eea138a.js"><link rel="prefetch" href="/rust-doc/assets/js/120.f0a989fe.js"><link rel="prefetch" href="/rust-doc/assets/js/121.5b3a830f.js"><link rel="prefetch" href="/rust-doc/assets/js/122.36b7633b.js"><link rel="prefetch" href="/rust-doc/assets/js/123.cb56d684.js"><link rel="prefetch" href="/rust-doc/assets/js/124.4a94c2a7.js"><link rel="prefetch" href="/rust-doc/assets/js/125.2da7eeab.js"><link rel="prefetch" href="/rust-doc/assets/js/126.c8929e44.js"><link rel="prefetch" href="/rust-doc/assets/js/127.8fb0f7a0.js"><link rel="prefetch" href="/rust-doc/assets/js/128.dd80d591.js"><link rel="prefetch" href="/rust-doc/assets/js/129.aa170fe9.js"><link rel="prefetch" href="/rust-doc/assets/js/13.4e4de3f9.js"><link rel="prefetch" href="/rust-doc/assets/js/130.db8c6071.js"><link rel="prefetch" href="/rust-doc/assets/js/131.93d3925a.js"><link rel="prefetch" href="/rust-doc/assets/js/14.7d8cc8c4.js"><link rel="prefetch" href="/rust-doc/assets/js/15.c72c8a9e.js"><link rel="prefetch" href="/rust-doc/assets/js/16.d49862cf.js"><link rel="prefetch" href="/rust-doc/assets/js/17.c084fb46.js"><link rel="prefetch" href="/rust-doc/assets/js/18.61b146cc.js"><link rel="prefetch" href="/rust-doc/assets/js/19.ac65ddaa.js"><link rel="prefetch" href="/rust-doc/assets/js/20.b2f37783.js"><link rel="prefetch" href="/rust-doc/assets/js/21.bc7abb0d.js"><link rel="prefetch" href="/rust-doc/assets/js/22.2dd10b21.js"><link rel="prefetch" href="/rust-doc/assets/js/23.55de02b6.js"><link rel="prefetch" href="/rust-doc/assets/js/24.3123e7b2.js"><link rel="prefetch" href="/rust-doc/assets/js/25.c2d4d2c7.js"><link rel="prefetch" href="/rust-doc/assets/js/26.7cf20f6f.js"><link rel="prefetch" href="/rust-doc/assets/js/27.b6484f43.js"><link rel="prefetch" href="/rust-doc/assets/js/28.a022eff5.js"><link rel="prefetch" href="/rust-doc/assets/js/29.7b185968.js"><link rel="prefetch" href="/rust-doc/assets/js/3.bfcba754.js"><link rel="prefetch" href="/rust-doc/assets/js/30.4186c23c.js"><link rel="prefetch" href="/rust-doc/assets/js/31.813b9678.js"><link rel="prefetch" href="/rust-doc/assets/js/32.44491046.js"><link rel="prefetch" href="/rust-doc/assets/js/33.52d1bd4d.js"><link rel="prefetch" href="/rust-doc/assets/js/34.322d9308.js"><link rel="prefetch" href="/rust-doc/assets/js/35.ca435b08.js"><link rel="prefetch" href="/rust-doc/assets/js/36.c5e7b3e2.js"><link rel="prefetch" href="/rust-doc/assets/js/37.4b0c4e3a.js"><link rel="prefetch" href="/rust-doc/assets/js/38.176b7420.js"><link rel="prefetch" href="/rust-doc/assets/js/39.ac4964b1.js"><link rel="prefetch" href="/rust-doc/assets/js/4.0d286bf5.js"><link rel="prefetch" href="/rust-doc/assets/js/40.b5016b37.js"><link rel="prefetch" href="/rust-doc/assets/js/41.c051920d.js"><link rel="prefetch" href="/rust-doc/assets/js/42.b1e880d5.js"><link rel="prefetch" href="/rust-doc/assets/js/43.4061a648.js"><link rel="prefetch" href="/rust-doc/assets/js/44.b6ce63a6.js"><link rel="prefetch" href="/rust-doc/assets/js/45.778e0931.js"><link rel="prefetch" href="/rust-doc/assets/js/46.75468c64.js"><link rel="prefetch" href="/rust-doc/assets/js/47.2c1e1a10.js"><link rel="prefetch" href="/rust-doc/assets/js/48.35f9f3e6.js"><link rel="prefetch" href="/rust-doc/assets/js/49.1ee52dfa.js"><link rel="prefetch" href="/rust-doc/assets/js/5.1658b7c6.js"><link rel="prefetch" href="/rust-doc/assets/js/50.2ad6c5d5.js"><link rel="prefetch" href="/rust-doc/assets/js/51.18a069ec.js"><link rel="prefetch" href="/rust-doc/assets/js/52.59cb67e0.js"><link rel="prefetch" href="/rust-doc/assets/js/53.0d9d34de.js"><link rel="prefetch" href="/rust-doc/assets/js/54.0a9fe69b.js"><link rel="prefetch" href="/rust-doc/assets/js/55.a30e4a64.js"><link rel="prefetch" href="/rust-doc/assets/js/56.5df943c5.js"><link rel="prefetch" href="/rust-doc/assets/js/57.f44ee57f.js"><link rel="prefetch" href="/rust-doc/assets/js/58.34af13bf.js"><link rel="prefetch" href="/rust-doc/assets/js/59.dab934fe.js"><link rel="prefetch" href="/rust-doc/assets/js/6.6bd8219b.js"><link rel="prefetch" href="/rust-doc/assets/js/60.5b5aefde.js"><link rel="prefetch" href="/rust-doc/assets/js/61.cc30625c.js"><link rel="prefetch" href="/rust-doc/assets/js/62.57791b4d.js"><link rel="prefetch" href="/rust-doc/assets/js/63.d10762f6.js"><link rel="prefetch" href="/rust-doc/assets/js/64.dc64731f.js"><link rel="prefetch" href="/rust-doc/assets/js/65.4ee2306c.js"><link rel="prefetch" href="/rust-doc/assets/js/66.f1a99e1f.js"><link rel="prefetch" href="/rust-doc/assets/js/67.6903a840.js"><link rel="prefetch" href="/rust-doc/assets/js/68.efc3417d.js"><link rel="prefetch" href="/rust-doc/assets/js/69.4c361eff.js"><link rel="prefetch" href="/rust-doc/assets/js/7.76c11fc1.js"><link rel="prefetch" href="/rust-doc/assets/js/70.5f433f05.js"><link rel="prefetch" href="/rust-doc/assets/js/71.e7030c67.js"><link rel="prefetch" href="/rust-doc/assets/js/72.cc994ed8.js"><link rel="prefetch" href="/rust-doc/assets/js/73.16e1c3d6.js"><link rel="prefetch" href="/rust-doc/assets/js/74.8dde486e.js"><link rel="prefetch" href="/rust-doc/assets/js/75.00a1c9ed.js"><link rel="prefetch" href="/rust-doc/assets/js/76.7b27ad89.js"><link rel="prefetch" href="/rust-doc/assets/js/77.537c5d96.js"><link rel="prefetch" href="/rust-doc/assets/js/78.d5ec6a76.js"><link rel="prefetch" href="/rust-doc/assets/js/79.485d89fb.js"><link rel="prefetch" href="/rust-doc/assets/js/80.49855892.js"><link rel="prefetch" href="/rust-doc/assets/js/81.ebe811b5.js"><link rel="prefetch" href="/rust-doc/assets/js/82.35ef98d5.js"><link rel="prefetch" href="/rust-doc/assets/js/83.442f1239.js"><link rel="prefetch" href="/rust-doc/assets/js/84.a2c5694c.js"><link rel="prefetch" href="/rust-doc/assets/js/86.1ce0ee03.js"><link rel="prefetch" href="/rust-doc/assets/js/87.16afe7d6.js"><link rel="prefetch" href="/rust-doc/assets/js/88.38fc6f23.js"><link rel="prefetch" href="/rust-doc/assets/js/89.7e4e8cf3.js"><link rel="prefetch" href="/rust-doc/assets/js/90.9a764995.js"><link rel="prefetch" href="/rust-doc/assets/js/91.59e310ba.js"><link rel="prefetch" href="/rust-doc/assets/js/92.bf258199.js"><link rel="prefetch" href="/rust-doc/assets/js/93.bbef4287.js"><link rel="prefetch" href="/rust-doc/assets/js/94.1aeb268a.js"><link rel="prefetch" href="/rust-doc/assets/js/95.d20aa01a.js"><link rel="prefetch" href="/rust-doc/assets/js/96.1c2ac11b.js"><link rel="prefetch" href="/rust-doc/assets/js/97.f8400bd1.js"><link rel="prefetch" href="/rust-doc/assets/js/98.8cb332e9.js"><link rel="prefetch" href="/rust-doc/assets/js/99.3cf0cdd5.js"><link rel="prefetch" href="/rust-doc/assets/js/vendors~docsearch.5da1c945.js">
    <link rel="stylesheet" href="/rust-doc/assets/css/0.styles.b04b0b2c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rust-doc/" class="home-link router-link-active"><!----> <span class="site-name">rust语言中文文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/rust-doc/doc/introduce/introduce.html" class="sidebar-link">Rust介绍</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/getting-started/getting-started" class="sidebar-heading clickable"><span>入门</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/rust-doc/doc/guess-game/guess-game.html" class="sidebar-link">猜一猜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-concept/common-concept" class="sidebar-heading clickable"><span>常用的编程概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/understand-ownership/understand-ownership" class="sidebar-heading clickable"><span>认识所有权</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/structs/structs" class="sidebar-heading clickable"><span>使用结构体来构造相关数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/enums/enums" class="sidebar-heading clickable"><span>枚举</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/packages-crates-and-modules/packages-crates-and-modules" class="sidebar-heading clickable"><span>使用包、依赖箱和模块管理不断增长的项目</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-collections/common-collections" class="sidebar-heading clickable"><span>常用集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/error-handling/error-handling" class="sidebar-heading clickable"><span>错误处理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/generics/generics" class="sidebar-heading clickable"><span>泛型类型、特性和生命周期</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/testing/testing" class="sidebar-heading clickable"><span>测试</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/an-io-project/an-io-project" class="sidebar-heading clickable"><span>I/O 项目：构建命令行程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/functional-features/functional-features" class="sidebar-heading clickable"><span>函数式语言特性：迭代器与闭包</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/more-about-cargo/more-about-cargo" class="sidebar-heading clickable"><span>关于 Cargo 和 Crates.io 的更多信息</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/smart-pointers/smart-pointers" class="sidebar-heading clickable"><span>智能指针</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/concurrency/concurrency" class="sidebar-heading clickable"><span>无畏并发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/async-await/async-await" class="sidebar-heading clickable"><span>异步编程基础：Async、Await、Futures 和 Streams</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/oop/oop" class="sidebar-heading clickable"><span>面向对象编程特性</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/patterns/patterns" class="sidebar-heading clickable"><span>模式与匹配</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/advanced-features/advanced-features" class="sidebar-heading clickable"><span>高级特性</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/final-project/final-project" class="sidebar-heading clickable open"><span>最终项目：构建多线程Web服务器</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust-doc/doc/final-project/single-threaded.html" class="sidebar-link">构建单线程Web服务器</a></li><li><a href="/rust-doc/doc/final-project/multithreaded.html" class="sidebar-link">将单线程服务器转换为多线程服务器</a></li><li><a href="/rust-doc/doc/final-project/graceful-shutdown-and-cleanup.html" aria-current="page" class="active sidebar-link">优雅关闭和清理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust-doc/doc/final-project/graceful-shutdown-and-cleanup.html#优雅关闭和清理" class="sidebar-link">优雅关闭和清理</a></li><li class="sidebar-sub-header"><a href="/rust-doc/doc/final-project/graceful-shutdown-and-cleanup.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>附录</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="优雅关闭和清理"><a href="#优雅关闭和清理" class="header-anchor">#</a> 优雅关闭和清理</h2> <p>示例21-20中的代码通过使用线程池异步响应请求，正如我们预期的那样。我们得到一些关于<code>workers</code>、<code>id</code>和<code>thread</code>字段的警告，提醒我们没有以直接方式使用它们，这提醒我们没有清理任何东西。当我们使用不太优雅的<code>ctrl-c</code>方法来停止主线程时，所有其他线程也会立即停止，即使它们正在服务请求的中途。</p> <p>接下来，我们将实现<code>Drop</code> trait在池中的每个线程上调用<code>join</code>，以便它们可以在关闭之前完成它们正在处理的请求。然后我们将实现一种方式来告诉线程它们应该停止接受新请求并关闭。为了看到这段代码的实际运行，我们将修改我们的服务器，在优雅关闭其线程池之前只接受两个请求。</p> <p>需要注意的一点是：这些都不会影响处理执行闭包的代码部分，所以如果我们为异步运行时使用线程池，这里的一切都是一样的。</p> <h3 id="在threadpool上实现drop-trait"><a href="#在threadpool上实现drop-trait" class="header-anchor">#</a> 在<code>ThreadPool</code>上实现<code>Drop</code> Trait</h3> <p>让我们从在我们的线程池上实现<code>Drop</code>开始。当池被丢弃时，我们的线程都应该<code>join</code>以确保它们完成工作。示例21-22显示了<code>Drop</code>实现的第一次尝试；这段代码还不能完全正常工作。</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">,</span> mpsc<span class="token punctuation">}</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ThreadPool</span> <span class="token punctuation">{</span>
    workers<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Worker</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    sender<span class="token punctuation">:</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token type-definition class-name">Job</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create a new ThreadPool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The size is the number of threads in the pool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Panics</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The `new` function will panic if the size is zero.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> receiver <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> workers <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> id <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>size <span class="token punctuation">{</span>
            workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Worker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span> workers<span class="token punctuation">,</span> sender <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">execute</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span>
    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> job <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> worker <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>workers <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down worker {}&quot;</span><span class="token punctuation">,</span> worker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            worker<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Worker</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">:</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> thread <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">loop</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> job <span class="token operator">=</span> receiver<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Worker {id} got a job; executing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Worker</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> thread <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例21-22：当线程池超出作用域时连接每个线程</p> <p>首先，我们循环遍历线程池的每个<code>workers</code>。我们为此使用<code>&amp;mut</code>，因为<code>self</code>是一个可变引用，并且我们还需要能够改变<code>worker</code>。对于每个<code>worker</code>，我们打印一条消息，说明这个特定的<code>Worker</code>实例正在关闭，然后我们在该<code>Worker</code>实例的线程上调用<code>join</code>。如果对<code>join</code>的调用失败，我们使用<code>unwrap</code>让Rust恐慌并进入不优雅的关闭。</p> <p>这是我们编译此代码时得到的错误：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo check
    <span class="token class-name">Checking</span> hello v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/hello)</span>
error<span class="token punctuation">[</span><span class="token constant">E0507</span><span class="token punctuation">]</span><span class="token punctuation">:</span> cannot <span class="token keyword">move</span> out of `worker<span class="token punctuation">.</span>thread` which is behind a mutable reference
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">13</span>
   <span class="token operator">|</span>
<span class="token number">52</span> <span class="token operator">|</span>             worker<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>             <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> `worker<span class="token punctuation">.</span>thread` moved due to this method call
   <span class="token operator">|</span>             <span class="token operator">|</span>
   <span class="token operator">|</span>             <span class="token keyword">move</span> occurs because `worker<span class="token punctuation">.</span>thread` has <span class="token keyword">type</span> `<span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>`<span class="token punctuation">,</span> which does not implement the `<span class="token class-name">Copy</span>` <span class="token keyword">trait</span>
   <span class="token operator">|</span>
note<span class="token punctuation">:</span> `<span class="token class-name">JoinHandle</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">::</span>join` takes ownership of the receiver `<span class="token keyword">self</span>`<span class="token punctuation">,</span> which moves `worker<span class="token punctuation">.</span>thread`
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> <span class="token operator">/</span>rustc<span class="token operator">/</span>4eb161250e340c8f48f66e2b929ef4a5bed7c181<span class="token operator">/</span>library<span class="token operator">/</span>std<span class="token operator">/</span>src<span class="token operator">/</span>thread<span class="token operator">/</span><span class="token keyword">mod</span><span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">1876</span><span class="token punctuation">:</span><span class="token number">17</span>

<span class="token class-name">For</span> more information about this error<span class="token punctuation">,</span> <span class="token keyword">try</span> `rustc <span class="token operator">-</span><span class="token operator">-</span>explain <span class="token constant">E0507</span>`<span class="token punctuation">.</span>
error<span class="token punctuation">:</span> could not compile `hello` <span class="token punctuation">(</span>lib<span class="token punctuation">)</span> due to <span class="token number">1</span> previous error
</code></pre></div><p>错误告诉我们不能调用<code>join</code>，因为我们只有每个<code>worker</code>的可变借用，而<code>join</code>获取其参数的所有权。为了解决这个问题，我们需要将线程从拥有<code>thread</code>的<code>Worker</code>实例中移出，以便<code>join</code>可以消费线程。我们在示例18-15中采用了这种方法。如果<code>Worker</code>持有<code>Option&lt;thread::JoinHandle&lt;()&gt;&gt;</code>，我们可以在<code>Option</code>上调用<code>take</code>方法将值从<code>Some</code>变体中移出，并在其位置留下<code>None</code>变体。换句话说，正在运行的<code>Worker</code>在<code>thread</code>中会有一个<code>Some</code>变体，当我们想要清理<code>Worker</code>时，我们会用<code>None</code>替换<code>Some</code>，这样<code>Worker</code>就没有线程可以运行。</p> <p>然而，这只会在丢弃<code>Worker</code>时出现。作为交换，我们必须在访问<code>worker.thread</code>的任何地方处理<code>Option&lt;thread::JoinHandle&lt;()&gt;&gt;</code>。惯用的Rust很多时候都使用<code>Option</code>，但当你发现自己将你知道总是存在的东西包装在<code>Option</code>中作为这样的解决方法时，寻找替代方法是个好主意。它们可以使你的代码更清洁，错误更少。</p> <p>在这种情况下，存在一个更好的替代方案：<code>Vec::drain</code>方法。它接受一个范围参数来指定要从<code>Vec</code>中删除哪些项目，并返回这些项目的迭代器。传递<code>..</code>范围语法将从<code>Vec</code>中删除每个值。</p> <p>所以我们需要像这样更新<code>ThreadPool</code> drop实现：</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#![allow(unused)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">,</span> mpsc<span class="token punctuation">}</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ThreadPool</span> <span class="token punctuation">{</span>
    workers<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Worker</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    sender<span class="token punctuation">:</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token type-definition class-name">Job</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create a new ThreadPool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The size is the number of threads in the pool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Panics</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The `new` function will panic if the size is zero.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> receiver <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> workers <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> id <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>size <span class="token punctuation">{</span>
            workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Worker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span> workers<span class="token punctuation">,</span> sender <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">execute</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span>
    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> job <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> worker <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>workers<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down worker {}&quot;</span><span class="token punctuation">,</span> worker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            worker<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Worker</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">:</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> thread <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">loop</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> job <span class="token operator">=</span> receiver<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Worker {id} got a job; executing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Worker</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> thread <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这解决了编译器错误，并且不需要对我们的代码进行任何其他更改。</p> <h3 id="向线程发出停止监听作业的信号"><a href="#向线程发出停止监听作业的信号" class="header-anchor">#</a> 向线程发出停止监听作业的信号</h3> <p>通过我们所做的所有更改，我们的代码编译时没有任何警告。然而，坏消息是这段代码还没有按照我们想要的方式运行。关键是<code>Worker</code>实例的线程运行的闭包中的逻辑：目前，我们调用<code>join</code>，但这不会关闭线程，因为它们永远循环寻找作业。如果我们尝试使用我们当前的<code>drop</code>实现丢弃我们的<code>ThreadPool</code>，主线程将永远阻塞，等待第一个线程完成。</p> <p>为了解决这个问题，我们需要在<code>ThreadPool</code> drop实现中进行更改，然后在<code>Worker</code>循环中进行更改。</p> <p>首先，我们将更改<code>ThreadPool</code> drop实现，在等待线程完成之前显式丢弃<code>sender</code>。示例21-23显示了对<code>ThreadPool</code>的更改，以显式丢弃<code>sender</code>。与线程不同，这里我们确实需要使用<code>Option</code>来能够用<code>Option::take</code>将<code>sender</code>从<code>ThreadPool</code>中移出。</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">,</span> mpsc<span class="token punctuation">}</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ThreadPool</span> <span class="token punctuation">{</span>
    workers<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Worker</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    sender<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">// --snip--</span>

<span class="token keyword">type</span> <span class="token type-definition class-name">Job</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create a new ThreadPool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The size is the number of threads in the pool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Panics</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The `new` function will panic if the size is zero.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
        <span class="token comment">// --snip--</span>

        <span class="token macro property">assert!</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> receiver <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> workers <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> id <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>size <span class="token punctuation">{</span>
            workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Worker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
            workers<span class="token punctuation">,</span>
            sender<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">execute</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span>
    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> job <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">drop</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> worker <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>workers<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down worker {}&quot;</span><span class="token punctuation">,</span> worker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            worker<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Worker</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">:</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> thread <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">loop</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> job <span class="token operator">=</span> receiver<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Worker {id} got a job; executing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Worker</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> thread <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例21-23：在连接<code>Worker</code>线程之前显式丢弃<code>sender</code></p> <p>丢弃<code>sender</code>会关闭通道，这表明不会再发送更多消息。当这种情况发生时，<code>Worker</code>实例在无限循环中对<code>recv</code>的所有调用都将返回错误。在示例21-24中，我们更改<code>Worker</code>循环以在这种情况下优雅地退出循环，这意味着当<code>ThreadPool</code> drop实现对它们调用<code>join</code>时线程将完成。</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">,</span> mpsc<span class="token punctuation">}</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ThreadPool</span> <span class="token punctuation">{</span>
    workers<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Worker</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    sender<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token type-definition class-name">Job</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create a new ThreadPool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The size is the number of threads in the pool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Panics</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The `new` function will panic if the size is zero.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> receiver <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> workers <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> id <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>size <span class="token punctuation">{</span>
            workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Worker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
            workers<span class="token punctuation">,</span>
            sender<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">execute</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span>
    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> job <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">drop</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> worker <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>workers<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down worker {}&quot;</span><span class="token punctuation">,</span> worker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            worker<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Worker</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">:</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> thread <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">loop</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> message <span class="token operator">=</span> receiver<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">match</span> message <span class="token punctuation">{</span>
                    <span class="token class-name">Ok</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Worker {id} got a job; executing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Worker {id} disconnected; shutting down.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Worker</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> thread <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例21-24：当<code>recv</code>返回错误时显式跳出循环</p> <p>为了看到这段代码的实际运行，让我们修改<code>main</code>以在优雅关闭服务器之前只接受两个请求，如示例21-25所示。</p> <p>文件名：src/main.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">hello<span class="token punctuation">::</span></span><span class="token class-name">ThreadPool</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    fs<span class="token punctuation">,</span>
    <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BufReader</span><span class="token punctuation">,</span> <span class="token namespace">prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">net<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">TcpListener</span><span class="token punctuation">,</span> <span class="token class-name">TcpStream</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">,</span>
    <span class="token namespace">time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> listener <span class="token operator">=</span> <span class="token class-name">TcpListener</span><span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:7878&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pool <span class="token operator">=</span> <span class="token class-name">ThreadPool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> stream <span class="token keyword">in</span> listener<span class="token punctuation">.</span><span class="token function">incoming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stream <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token function">handle_connection</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">handle_connection</span><span class="token punctuation">(</span><span class="token keyword">mut</span> stream<span class="token punctuation">:</span> <span class="token class-name">TcpStream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buf_reader <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> request_line <span class="token operator">=</span> buf_reader<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>status_line<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token operator">&amp;</span>request_line<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;GET / HTTP/1.1&quot;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;GET /sleep HTTP/1.1&quot;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.html&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        _ <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 404 NOT FOUND&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;404.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">read_to_string</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> length <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> response <span class="token operator">=</span>
        <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{status_line}\r\nContent-Length: {length}\r\n\r\n{contents}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    stream<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例21-25：通过退出循环在服务两个请求后关闭服务器</p> <p>你不会希望真实世界的web服务器在只服务两个请求后就关闭。这段代码只是演示了优雅关闭和清理正在正常工作。</p> <p><code>take</code>方法在<code>Iterator</code> trait中定义，将迭代限制为最多前两个项目。<code>ThreadPool</code>将在<code>main</code>的末尾超出作用域，<code>drop</code>实现将运行。</p> <p>用<code>cargo run</code>启动服务器，并发出三个请求。第三个请求应该出错，在你的终端中你应该看到类似这样的输出：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo run
   <span class="token class-name">Compiling</span> hello v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/hello)</span>
    <span class="token class-name">Finished</span> `dev` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>41s
     <span class="token class-name">Running</span> `target<span class="token operator">/</span>debug<span class="token operator">/</span>hello`
<span class="token class-name">Worker</span> <span class="token number">0</span> got a job<span class="token punctuation">;</span> executing<span class="token punctuation">.</span>
<span class="token class-name">Shutting</span> down<span class="token punctuation">.</span>
<span class="token class-name">Shutting</span> down worker <span class="token number">0</span>
<span class="token class-name">Worker</span> <span class="token number">3</span> got a job<span class="token punctuation">;</span> executing<span class="token punctuation">.</span>
<span class="token class-name">Worker</span> <span class="token number">1</span> disconnected<span class="token punctuation">;</span> shutting down<span class="token punctuation">.</span>
<span class="token class-name">Worker</span> <span class="token number">2</span> disconnected<span class="token punctuation">;</span> shutting down<span class="token punctuation">.</span>
<span class="token class-name">Worker</span> <span class="token number">3</span> disconnected<span class="token punctuation">;</span> shutting down<span class="token punctuation">.</span>
<span class="token class-name">Worker</span> <span class="token number">0</span> disconnected<span class="token punctuation">;</span> shutting down<span class="token punctuation">.</span>
<span class="token class-name">Shutting</span> down worker <span class="token number">1</span>
<span class="token class-name">Shutting</span> down worker <span class="token number">2</span>
<span class="token class-name">Shutting</span> down worker <span class="token number">3</span>
</code></pre></div><p>你可能会看到不同的<code>Worker</code> ID和打印消息的顺序。我们可以从消息中看到这段代码是如何工作的：<code>Worker</code>实例0和3得到了前两个请求。服务器在第二个连接后停止接受连接，<code>ThreadPool</code>上的<code>Drop</code>实现甚至在<code>Worker</code> 3开始其作业之前就开始执行。丢弃<code>sender</code>会断开所有<code>Worker</code>实例的连接并告诉它们关闭。每个<code>Worker</code>在断开连接时都会打印一条消息，然后线程池调用<code>join</code>等待每个<code>Worker</code>线程完成。</p> <p>注意这个特定执行的一个有趣方面：<code>ThreadPool</code>丢弃了<code>sender</code>，在任何<code>Worker</code>收到错误之前，我们尝试连接<code>Worker</code> 0。<code>Worker</code> 0还没有从<code>recv</code>得到错误，所以主线程阻塞等待<code>Worker</code> 0完成。与此同时，<code>Worker</code> 3收到了一个作业，然后所有线程都收到了错误。当<code>Worker</code> 0完成时，主线程等待其余的<code>Worker</code>实例完成。此时，它们都已经退出了循环并停止了。</p> <p>恭喜！我们现在已经完成了我们的项目；我们有一个使用线程池异步响应的基本web服务器。我们能够执行服务器的优雅关闭，这会清理池中的所有线程。</p> <p>这是完整的代码以供参考：</p> <p>文件名：src/main.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">hello<span class="token punctuation">::</span></span><span class="token class-name">ThreadPool</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    fs<span class="token punctuation">,</span>
    <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BufReader</span><span class="token punctuation">,</span> <span class="token namespace">prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">net<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">TcpListener</span><span class="token punctuation">,</span> <span class="token class-name">TcpStream</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">,</span>
    <span class="token namespace">time<span class="token punctuation">::</span></span><span class="token class-name">Duration</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> listener <span class="token operator">=</span> <span class="token class-name">TcpListener</span><span class="token punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:7878&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pool <span class="token operator">=</span> <span class="token class-name">ThreadPool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> stream <span class="token keyword">in</span> listener<span class="token punctuation">.</span><span class="token function">incoming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stream <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        pool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token function">handle_connection</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">handle_connection</span><span class="token punctuation">(</span><span class="token keyword">mut</span> stream<span class="token punctuation">:</span> <span class="token class-name">TcpStream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buf_reader <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> request_line <span class="token operator">=</span> buf_reader<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> <span class="token punctuation">(</span>status_line<span class="token punctuation">,</span> filename<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token operator">&amp;</span>request_line<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;GET / HTTP/1.1&quot;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;GET /sleep HTTP/1.1&quot;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">::</span><span class="token function">from_secs</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 200 OK&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello.html&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        _ <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;HTTP/1.1 404 NOT FOUND&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;404.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> contents <span class="token operator">=</span> <span class="token namespace">fs<span class="token punctuation">::</span></span><span class="token function">read_to_string</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> length <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> response <span class="token operator">=</span>
        <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{status_line}\r\nContent-Length: {length}\r\n\r\n{contents}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    stream<span class="token punctuation">.</span><span class="token function">write_all</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">as_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">sync<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Arc</span><span class="token punctuation">,</span> <span class="token class-name">Mutex</span><span class="token punctuation">,</span> mpsc<span class="token punctuation">}</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ThreadPool</span> <span class="token punctuation">{</span>
    workers<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Worker</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    sender<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Sender</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token type-definition class-name">Job</span> <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token keyword">dyn</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Create a new ThreadPool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The size is the number of threads in the pool.</span>
    <span class="token comment">///</span>
    <span class="token comment">/// # Panics</span>
    <span class="token comment">///</span>
    <span class="token comment">/// The `new` function will panic if the size is zero.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>size<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token punctuation">(</span>sender<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> receiver <span class="token operator">=</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> workers <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> id <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>size <span class="token punctuation">{</span>
            workers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Worker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>receiver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
            workers<span class="token punctuation">,</span>
            sender<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">execute</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span>
    <span class="token keyword">where</span>
        <span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> job <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">self</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Drop</span> <span class="token keyword">for</span> <span class="token class-name">ThreadPool</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">drop</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> worker <span class="token keyword">in</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>workers <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Shutting down worker {}&quot;</span><span class="token punctuation">,</span> worker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span> <span class="token operator">=</span> worker<span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Worker</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    thread<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> receiver<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token namespace">mpsc<span class="token punctuation">::</span></span><span class="token class-name">Receiver</span><span class="token operator">&lt;</span><span class="token class-name">Job</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> thread <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">loop</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> message <span class="token operator">=</span> receiver<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">match</span> message <span class="token punctuation">{</span>
                    <span class="token class-name">Ok</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Worker {id} got a job; executing.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Worker {id} disconnected; shutting down.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Worker</span> <span class="token punctuation">{</span>
            id<span class="token punctuation">,</span>
            thread<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们可以在这里做更多！如果你想继续增强这个项目，这里有一些想法：</p> <ul><li>为<code>ThreadPool</code>及其公共方法添加更多文档。</li> <li>添加库功能的测试。</li> <li>将对<code>unwrap</code>的调用更改为更强大的错误处理。</li> <li>使用<code>ThreadPool</code>执行除了服务web请求之外的其他任务。</li> <li>在<a href="https://crates.io/" target="_blank" rel="noopener noreferrer">crates.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>上找一个线程池crate，用该crate实现类似的web服务器。然后将其API和健壮性与我们实现的线程池进行比较。</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>干得好！你已经完成了本文档！我们要感谢你加入我们的Rust之旅。你现在已经准备好实现自己的Rust项目并帮助其他人的项目。请记住，有一个热情的Rustaceans社区，他们很乐意帮助你解决在Rust旅程中遇到的任何挑战。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rust-doc/doc/final-project/multithreaded.html" class="prev">
        将单线程服务器转换为多线程服务器
      </a></span> <span class="next"><a href="/rust-doc/doc/appendix/appendix-a.html">
        附录A: 关键字
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/rust-doc/assets/js/app.f0d374f6.js" defer></script><script src="/rust-doc/assets/js/2.f80c1e3f.js" defer></script><script src="/rust-doc/assets/js/1.fd67daac.js" defer></script><script src="/rust-doc/assets/js/85.186197b8.js" defer></script>
  </body>
</html>
