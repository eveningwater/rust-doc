<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何编写测试 | rust语言中文文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/rust-doc/logo.svg">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="一门赋予每个人构建可靠且高效软件能力的语言。">
    
    <link rel="preload" href="/rust-doc/assets/css/0.styles.b04b0b2c.css" as="style"><link rel="preload" href="/rust-doc/assets/js/app.858f10df.js" as="script"><link rel="preload" href="/rust-doc/assets/js/2.d1f3a877.js" as="script"><link rel="preload" href="/rust-doc/assets/js/1.169debde.js" as="script"><link rel="preload" href="/rust-doc/assets/js/107.b904cd96.js" as="script"><link rel="prefetch" href="/rust-doc/assets/js/10.0172388b.js"><link rel="prefetch" href="/rust-doc/assets/js/100.b9dda212.js"><link rel="prefetch" href="/rust-doc/assets/js/101.217ea0f0.js"><link rel="prefetch" href="/rust-doc/assets/js/102.d21f247e.js"><link rel="prefetch" href="/rust-doc/assets/js/103.7d9b56e0.js"><link rel="prefetch" href="/rust-doc/assets/js/104.20e45a3c.js"><link rel="prefetch" href="/rust-doc/assets/js/105.3b2e9e7a.js"><link rel="prefetch" href="/rust-doc/assets/js/106.f62b9226.js"><link rel="prefetch" href="/rust-doc/assets/js/108.491f1210.js"><link rel="prefetch" href="/rust-doc/assets/js/11.8ce27df2.js"><link rel="prefetch" href="/rust-doc/assets/js/12.8f06284b.js"><link rel="prefetch" href="/rust-doc/assets/js/13.a9d52700.js"><link rel="prefetch" href="/rust-doc/assets/js/14.78d60e9f.js"><link rel="prefetch" href="/rust-doc/assets/js/15.c3be2b8d.js"><link rel="prefetch" href="/rust-doc/assets/js/16.9d65f123.js"><link rel="prefetch" href="/rust-doc/assets/js/17.1344f53c.js"><link rel="prefetch" href="/rust-doc/assets/js/18.967f6c8c.js"><link rel="prefetch" href="/rust-doc/assets/js/19.be24f0c8.js"><link rel="prefetch" href="/rust-doc/assets/js/20.6d69020f.js"><link rel="prefetch" href="/rust-doc/assets/js/21.800d8e53.js"><link rel="prefetch" href="/rust-doc/assets/js/22.71d363d8.js"><link rel="prefetch" href="/rust-doc/assets/js/23.f22b7556.js"><link rel="prefetch" href="/rust-doc/assets/js/24.1f1f3426.js"><link rel="prefetch" href="/rust-doc/assets/js/25.0457c80e.js"><link rel="prefetch" href="/rust-doc/assets/js/26.9c0e8457.js"><link rel="prefetch" href="/rust-doc/assets/js/27.b2bbe252.js"><link rel="prefetch" href="/rust-doc/assets/js/28.0d257210.js"><link rel="prefetch" href="/rust-doc/assets/js/29.94fa333d.js"><link rel="prefetch" href="/rust-doc/assets/js/3.2f372239.js"><link rel="prefetch" href="/rust-doc/assets/js/30.499f961c.js"><link rel="prefetch" href="/rust-doc/assets/js/31.95ffe89b.js"><link rel="prefetch" href="/rust-doc/assets/js/32.1bc4680d.js"><link rel="prefetch" href="/rust-doc/assets/js/33.351ca28a.js"><link rel="prefetch" href="/rust-doc/assets/js/34.42a4fd70.js"><link rel="prefetch" href="/rust-doc/assets/js/35.a1e7c9bc.js"><link rel="prefetch" href="/rust-doc/assets/js/36.a93b7523.js"><link rel="prefetch" href="/rust-doc/assets/js/37.b8c01512.js"><link rel="prefetch" href="/rust-doc/assets/js/38.7814be15.js"><link rel="prefetch" href="/rust-doc/assets/js/39.f959a3e6.js"><link rel="prefetch" href="/rust-doc/assets/js/4.028f2830.js"><link rel="prefetch" href="/rust-doc/assets/js/40.8525a0b3.js"><link rel="prefetch" href="/rust-doc/assets/js/41.f502b7a1.js"><link rel="prefetch" href="/rust-doc/assets/js/42.a8383224.js"><link rel="prefetch" href="/rust-doc/assets/js/43.4cd15d0b.js"><link rel="prefetch" href="/rust-doc/assets/js/44.c516f770.js"><link rel="prefetch" href="/rust-doc/assets/js/45.74515de9.js"><link rel="prefetch" href="/rust-doc/assets/js/46.3f6dbfaf.js"><link rel="prefetch" href="/rust-doc/assets/js/47.f47b52f9.js"><link rel="prefetch" href="/rust-doc/assets/js/48.1ec4be20.js"><link rel="prefetch" href="/rust-doc/assets/js/49.0f4c1b03.js"><link rel="prefetch" href="/rust-doc/assets/js/5.d59f8a59.js"><link rel="prefetch" href="/rust-doc/assets/js/50.484cbe9a.js"><link rel="prefetch" href="/rust-doc/assets/js/51.785f9d59.js"><link rel="prefetch" href="/rust-doc/assets/js/52.8c37fd72.js"><link rel="prefetch" href="/rust-doc/assets/js/53.ad699744.js"><link rel="prefetch" href="/rust-doc/assets/js/54.bd2575ee.js"><link rel="prefetch" href="/rust-doc/assets/js/55.e01beca6.js"><link rel="prefetch" href="/rust-doc/assets/js/56.abcac538.js"><link rel="prefetch" href="/rust-doc/assets/js/57.e1cf5467.js"><link rel="prefetch" href="/rust-doc/assets/js/58.653827a0.js"><link rel="prefetch" href="/rust-doc/assets/js/59.dcd7d1e9.js"><link rel="prefetch" href="/rust-doc/assets/js/6.6b5c95a2.js"><link rel="prefetch" href="/rust-doc/assets/js/60.57810f19.js"><link rel="prefetch" href="/rust-doc/assets/js/61.dc7bd6a0.js"><link rel="prefetch" href="/rust-doc/assets/js/62.2c435b70.js"><link rel="prefetch" href="/rust-doc/assets/js/63.9f9255c6.js"><link rel="prefetch" href="/rust-doc/assets/js/64.3d1df9ac.js"><link rel="prefetch" href="/rust-doc/assets/js/65.34bc396c.js"><link rel="prefetch" href="/rust-doc/assets/js/66.97d46611.js"><link rel="prefetch" href="/rust-doc/assets/js/67.10fa04cd.js"><link rel="prefetch" href="/rust-doc/assets/js/68.06be5e25.js"><link rel="prefetch" href="/rust-doc/assets/js/69.2b1ec7d9.js"><link rel="prefetch" href="/rust-doc/assets/js/7.e3826499.js"><link rel="prefetch" href="/rust-doc/assets/js/70.e64e314a.js"><link rel="prefetch" href="/rust-doc/assets/js/71.7fc9dd6c.js"><link rel="prefetch" href="/rust-doc/assets/js/72.838fc207.js"><link rel="prefetch" href="/rust-doc/assets/js/73.db5e1ce7.js"><link rel="prefetch" href="/rust-doc/assets/js/74.cca5b065.js"><link rel="prefetch" href="/rust-doc/assets/js/75.9c75e6d1.js"><link rel="prefetch" href="/rust-doc/assets/js/76.9b2694ef.js"><link rel="prefetch" href="/rust-doc/assets/js/77.adefa865.js"><link rel="prefetch" href="/rust-doc/assets/js/78.f8972598.js"><link rel="prefetch" href="/rust-doc/assets/js/79.1796c54e.js"><link rel="prefetch" href="/rust-doc/assets/js/80.61ca9cc8.js"><link rel="prefetch" href="/rust-doc/assets/js/81.ec272458.js"><link rel="prefetch" href="/rust-doc/assets/js/82.b7f5cedb.js"><link rel="prefetch" href="/rust-doc/assets/js/83.ead1285f.js"><link rel="prefetch" href="/rust-doc/assets/js/84.2434187a.js"><link rel="prefetch" href="/rust-doc/assets/js/85.d1e1a075.js"><link rel="prefetch" href="/rust-doc/assets/js/86.d3146267.js"><link rel="prefetch" href="/rust-doc/assets/js/87.cf40e513.js"><link rel="prefetch" href="/rust-doc/assets/js/88.c71083e9.js"><link rel="prefetch" href="/rust-doc/assets/js/89.ebd49ebe.js"><link rel="prefetch" href="/rust-doc/assets/js/90.cd0db535.js"><link rel="prefetch" href="/rust-doc/assets/js/91.887b6670.js"><link rel="prefetch" href="/rust-doc/assets/js/92.24945cce.js"><link rel="prefetch" href="/rust-doc/assets/js/93.f4cbd5b3.js"><link rel="prefetch" href="/rust-doc/assets/js/94.236e0e92.js"><link rel="prefetch" href="/rust-doc/assets/js/95.6532ea92.js"><link rel="prefetch" href="/rust-doc/assets/js/96.39cba713.js"><link rel="prefetch" href="/rust-doc/assets/js/97.8bfe6fe2.js"><link rel="prefetch" href="/rust-doc/assets/js/98.0f169062.js"><link rel="prefetch" href="/rust-doc/assets/js/99.dfd546fb.js"><link rel="prefetch" href="/rust-doc/assets/js/vendors~docsearch.65d77edd.js">
    <link rel="stylesheet" href="/rust-doc/assets/css/0.styles.b04b0b2c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rust-doc/" class="home-link router-link-active"><!----> <span class="site-name">rust语言中文文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/rust-doc/doc/introduce/introduce.html" class="sidebar-link">Rust介绍</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/getting-started/getting-started" class="sidebar-heading clickable"><span>入门</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/rust-doc/doc/guess-game/guess-game.html" class="sidebar-link">猜一猜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-concept/common-concept" class="sidebar-heading clickable"><span>常用的编程概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/understand-ownership/understand-ownership" class="sidebar-heading clickable"><span>认识所有权</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/structs/structs" class="sidebar-heading clickable"><span>使用结构体来构造相关数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/enums/enums" class="sidebar-heading clickable"><span>枚举</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/packages-crates-and-modules/packages-crates-and-modules" class="sidebar-heading clickable"><span>使用包、依赖箱和模块管理不断增长的项目</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-collections/common-collections" class="sidebar-heading clickable"><span>常用集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/error-handling/error-handling" class="sidebar-heading clickable"><span>错误处理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/generics/generics" class="sidebar-heading clickable"><span>泛型类型、特性和生命周期</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/testing/testing" class="sidebar-heading clickable open"><span>测试</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust-doc/doc/testing/writing-tests.html" aria-current="page" class="active sidebar-link">编写测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust-doc/doc/testing/writing-tests.html#如何编写测试" class="sidebar-link">如何编写测试</a></li></ul></li><li><a href="/rust-doc/doc/testing/running-tests.html" class="sidebar-link">运行测试</a></li><li><a href="/rust-doc/doc/testing/test-organization.html" class="sidebar-link">测试的组织结构</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/an-io-project/an-io-project" class="sidebar-heading clickable"><span>I/O 项目：构建命令行程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/functional-features/functional-features" class="sidebar-heading clickable"><span>函数式语言特性：迭代器与闭包</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/more-about-cargo/more-about-cargo" class="sidebar-heading clickable"><span>关于 Cargo 和 Crates.io 的更多信息</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/smart-pointers/smart-pointers" class="sidebar-heading clickable"><span>智能指针</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/concurrency/concurrency" class="sidebar-heading clickable"><span>无畏并发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/async-await/async-await" class="sidebar-heading clickable"><span>异步编程基础：Async、Await、Futures 和 Streams</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>附录</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="如何编写测试"><a href="#如何编写测试" class="header-anchor">#</a> 如何编写测试</h2> <p>测试是 Rust 函数，用于验证非测试代码是否按预期方式运行。测试函数的主体通常执行以下三个操作：</p> <ul><li>设置所需的数据或状态。</li> <li>运行要测试的代码。</li> <li>断言结果符合预期。</li></ul> <p>让我们看看 Rust 专门为编写执行这些操作的测试提供的功能，包括 test 属性、一些宏和 should_panic 属性。</p> <h3 id="测试函数的剖析"><a href="#测试函数的剖析" class="header-anchor">#</a> 测试函数的剖析</h3> <p>最简单地说，Rust 中的测试是一个带有 test 属性标注的函数。属性是关于 Rust 代码片段的元数据；一个例子是我们在第 5 章中与结构体一起使用的 derive 属性。要将函数转变为测试函数，请在 fn 之前的行上添加 #[test]。当你使用 cargo test 命令运行测试时，Rust 会构建一个测试运行器二进制文件，它会运行带注解的函数并报告每个测试函数是通过还是失败。</p> <p>每当我们使用 Cargo 创建一个新的库项目时，会自动为我们生成一个包含测试函数的测试模块。这个模块为你提供了编写测试的模板，这样你就不必在每次开始新项目时查找确切的结构和语法。你可以添加任意数量的额外测试函数和测试模块！</p> <p>在我们实际测试任何代码之前，我们将通过实验模板测试来探索测试的工作原理的一些方面。然后我们将编写一些真实世界的测试，调用我们编写的代码并断言其行为是正确的。</p> <p>让我们创建一个名为 adder 的新库项目，它将对两个数字进行相加：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo new adder <span class="token operator">-</span><span class="token operator">-</span>lib
     <span class="token class-name">Created</span> library `adder` project
$ cd adder
</code></pre></div><p>adder 库中 src/lib.rs 文件的内容应该如示例 11-1 所示。</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span>left<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> right<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u64</span> <span class="token punctuation">{</span>
    left <span class="token operator">+</span> right
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">it_works</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 11-1：<code>cargo new</code> 自动生成的代码</p> <p>该文件以一个示例 add 函数开始，这样我们就有东西可以测试。</p> <p>现在，让我们只关注 it_works 函数。注意 #[test] 注解：这个属性表明这是一个测试函数，所以测试运行器知道将此函数视为测试。我们也可能在 tests 模块中有非测试函数来帮助设置常见场景或执行常见操作，所以我们总是需要指明哪些函数是测试。</p> <p>示例函数体使用 assert_eq! 宏来断言 result（包含调用 add 函数传入 2 和 2 的结果）等于 4。这个断言作为典型测试格式的示例。让我们运行它，看看这个测试是否通过。</p> <p><code>cargo test</code> 命令运行项目中的所有测试，如示例 11-2 所示。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> adder v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/adder)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>57s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/adder/target/debug/deps/adder-7acb243c25ffd9dc)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>it_works <span class="token punctuation">...</span> ok

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

   <span class="token class-name">Doc</span><span class="token operator">-</span>tests adder

running <span class="token number">0</span> tests

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s
</code></pre></div><p>示例 11-2：运行自动生成的测试的输出</p> <p>Cargo 编译并运行了测试。我们看到 running 1 test 这一行。下一行显示生成的测试函数的名称，称为 tests::it_works，以及运行该测试的结果是 ok。总体测试结果摘要 test result: ok. 表示所有测试都通过了，而读作 1 passed; 0 failed 的部分统计了通过或失败的测试数量。</p> <p>可以将测试标记为忽略，这样它就不会在特定实例中运行；我们将在本章后面的&quot;除非特别请求，否则忽略某些测试&quot;部分中介绍这一点。因为我们在这里没有这样做，所以摘要显示 0 ignored。</p> <p>0 measured 统计数据用于基准测试，测量性能。基准测试在撰写本文时仅在 nightly Rust 中可用。有关基准测试的更多信息，请参阅相关文档。</p> <p>我们可以向 cargo test 命令传递参数，只运行名称匹配字符串的测试；这称为过滤，我们将在&quot;按名称运行测试子集&quot;部分中介绍。这里我们没有过滤正在运行的测试，所以摘要末尾显示 0 filtered out。</p> <p>测试输出的下一部分从 Doc-tests adder 开始，是任何文档测试的结果。我们还没有任何文档测试，但 Rust 可以编译出现在我们 API 文档中的任何代码示例。这个功能有助于保持文档和代码同步！我们将在第 14 章的&quot;文档注释作为测试&quot;部分讨论如何编写文档测试。现在，我们将忽略 Doc-tests 输出。</p> <p>让我们开始根据自己的需求定制测试。首先，将 it_works 函数的名称更改为不同的名称，例如 exploration，如下所示：</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span>left<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> right<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u64</span> <span class="token punctuation">{</span>
    left <span class="token operator">+</span> right
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">exploration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后再次运行 cargo test。输出现在显示 exploration 而不是 it_works：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> adder v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/adder)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>59s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>adder<span class="token operator">-</span>92948b65e88960b4<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>exploration <span class="token punctuation">...</span> ok

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

   <span class="token class-name">Doc</span><span class="token operator">-</span>tests adder

running <span class="token number">0</span> tests

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

</code></pre></div><p>现在我们将添加另一个测试，但这次我们将创建一个失败的测试！当测试函数中的某些内容发生 panic 时，测试就会失败。每个测试都在一个新线程中运行，当主线程看到测试线程已死亡时，测试被标记为失败。在第 9 章中，我们讨论了最简单的 panic 方式是调用 panic! 宏。将新测试作为名为 another 的函数输入，使你的 src/lib.rs 文件看起来像示例 11-3。</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span>left<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> right<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u64</span> <span class="token punctuation">{</span>
    left <span class="token operator">+</span> right
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">exploration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">another</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Make this test fail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 11-3：添加第二个测试，由于我们调用了 panic! 宏而失败</p> <p>再次使用 cargo test 运行测试。输出应该如示例 11-4 所示，表明我们的 exploration 测试通过，another 测试失败。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> adder v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/adder)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>72s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>adder<span class="token operator">-</span>92948b65e88960b4<span class="token punctuation">)</span>

running <span class="token number">2</span> tests
test <span class="token namespace">tests<span class="token punctuation">::</span></span>another <span class="token punctuation">...</span> <span class="token constant">FAILED</span>
test <span class="token namespace">tests<span class="token punctuation">::</span></span>exploration <span class="token punctuation">...</span> ok

failures<span class="token punctuation">:</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token namespace">tests<span class="token punctuation">::</span></span>another stdout <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
thread <span class="token lifetime-annotation symbol">'tests</span><span class="token punctuation">::</span>another' panicked at src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span>
<span class="token class-name">Make</span> this test fail
note<span class="token punctuation">:</span> run with `<span class="token constant">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span>` environment variable to display a backtrace


failures<span class="token punctuation">:</span>
    <span class="token namespace">tests<span class="token punctuation">::</span></span>another

test result<span class="token punctuation">:</span> <span class="token constant">FAILED</span><span class="token punctuation">.</span> <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">1</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

error<span class="token punctuation">:</span> test failed<span class="token punctuation">,</span> to rerun pass `<span class="token operator">-</span><span class="token operator">-</span>lib`
</code></pre></div><p>示例 11-4：一个测试通过一个测试失败时的测试结果</p> <p>不是 ok，test tests::another 行显示 FAILED。在单个结果和摘要之间出现了两个新部分：第一部分显示每个测试失败的详细原因。在这种情况下，我们得到的详细信息是 another 失败，因为它在 src/lib.rs 文件的第 17 行 panic 了，显示 'Make this test fail'。下一部分仅列出所有失败测试的名称，当有很多测试和很多详细的失败测试输出时，这很有用。我们可以使用失败测试的名称只运行该测试，以便更容易地调试它；我们将在&quot;控制测试如何运行&quot;部分中详细讨论运行测试的方法。</p> <p>摘要行显示在末尾：总体而言，我们的测试结果是 FAILED。我们有一个测试通过，一个测试失败。</p> <p>现在你已经看到了不同场景下的测试结果，让我们看看除了 panic! 之外在测试中有用的一些宏。</p> <h3 id="使用-assert-宏检查结果"><a href="#使用-assert-宏检查结果" class="header-anchor">#</a> 使用 <code>assert!</code> 宏检查结果</h3> <p>assert! 宏由标准库提供，当你想确保测试中的某些条件评估为 true 时很有用。我们给 assert! 宏一个计算为布尔值的参数。如果值为 true，则什么都不会发生，测试通过。如果值为 false，assert! 宏会调用 panic! 使测试失败。使用 assert! 宏帮助我们检查代码是否按照我们的意图运行。</p> <p>在第 5 章的示例 5-15 中，我们使用了 Rectangle 结构体和 can_hold 方法，这里在示例 11-5 中重复。让我们将这段代码放入 src/lib.rs 文件中，然后使用 assert! 宏为它编写一些测试。</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Rectangle</span> <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Rectangle</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>width <span class="token operator">&gt;</span> other<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">&gt;</span> other<span class="token punctuation">.</span>height
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 11-5：第 5 章中的 Rectangle 结构体及其 can_hold 方法</p> <p>can_hold 方法返回一个布尔值，这意味着它是 assert! 宏的完美用例。在示例 11-6 中，我们编写了一个测试来测试 can_hold 方法，方法是创建一个宽度为 8、高度为 7 的 Rectangle 实例，并断言它可以容纳另一个宽度为 5、高度为 1 的 Rectangle 实例。</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Rectangle</span> <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Rectangle</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>width <span class="token operator">&gt;</span> other<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">&gt;</span> other<span class="token punctuation">.</span>height
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">larger_can_hold_smaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> larger <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> smaller <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token macro property">assert!</span><span class="token punctuation">(</span>larger<span class="token punctuation">.</span><span class="token function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>smaller<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 11-6：测试 can_hold，检查一个更大的矩形是否确实可以容纳一个更小的矩形</p> <p>注意 tests 模块内的 use super:😗; 行。tests 模块是一个常规模块，遵循我们在第 7 章&quot;引用模块树中项目的路径&quot;部分中介绍的常规可见性规则。因为 tests 模块是一个内部模块，我们需要将外部模块中的被测试代码引入内部模块的作用域。我们在这里使用通配符，所以外部模块中定义的任何内容都可用于这个 tests 模块。</p> <p>我们将测试命名为 larger_can_hold_smaller，并创建了我们需要的两个 Rectangle 实例。然后我们调用 assert! 宏并传递调用 larger.can_hold(&amp;smaller) 的结果。这个表达式应该返回 true，所以我们的测试应该通过。让我们看看！</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> rectangle v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/rectangle)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>66s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>rectangle<span class="token operator">-</span>6584c4561e48942e<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>larger_can_hold_smaller <span class="token punctuation">...</span> ok

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

   <span class="token class-name">Doc</span><span class="token operator">-</span>tests rectangle

running <span class="token number">0</span> tests

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s
</code></pre></div><p>确实通过了！让我们添加另一个测试，这次断言一个较小的矩形不能容纳一个较大的矩形：</p> <p>文件名：src/lib.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Rectangle</span> <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Rectangle</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>width <span class="token operator">&gt;</span> other<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">&gt;</span> other<span class="token punctuation">.</span>height
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">larger_can_hold_smaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// --snip--</span>
        <span class="token keyword">let</span> larger <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> smaller <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token macro property">assert!</span><span class="token punctuation">(</span>larger<span class="token punctuation">.</span><span class="token function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>smaller<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">smaller_cannot_hold_larger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> larger <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> smaller <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token operator">!</span>smaller<span class="token punctuation">.</span><span class="token function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>larger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为在这种情况下 can_hold 函数的正确结果是 false，我们需要在将结果传递给 assert! 宏之前对其取反。因此，如果 can_hold 返回 false，我们的测试将通过：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> rectangle v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/rectangle)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>66s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>rectangle<span class="token operator">-</span>6584c4561e48942e<span class="token punctuation">)</span>

running <span class="token number">2</span> tests
test <span class="token namespace">tests<span class="token punctuation">::</span></span>larger_can_hold_smaller <span class="token punctuation">...</span> ok
test <span class="token namespace">tests<span class="token punctuation">::</span></span>smaller_cannot_hold_larger <span class="token punctuation">...</span> ok

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">2</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

   <span class="token class-name">Doc</span><span class="token operator">-</span>tests rectangle

running <span class="token number">0</span> tests

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s
</code></pre></div><p>两个测试都通过了！现在让我们看看当我们在代码中引入一个 bug 时，我们的测试结果会发生什么。我们将通过在比较宽度时将大于号替换为小于号来更改 can_hold 方法的实现：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Rectangle</span> <span class="token punctuation">{</span>
    width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// --snip--</span>
<span class="token keyword">impl</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Rectangle</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>width <span class="token operator">&lt;</span> other<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">&gt;</span> other<span class="token punctuation">.</span>height
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">larger_can_hold_smaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> larger <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> smaller <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token macro property">assert!</span><span class="token punctuation">(</span>larger<span class="token punctuation">.</span><span class="token function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>smaller<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">smaller_cannot_hold_larger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> larger <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> smaller <span class="token operator">=</span> <span class="token class-name">Rectangle</span> <span class="token punctuation">{</span>
            width<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token macro property">assert!</span><span class="token punctuation">(</span><span class="token operator">!</span>smaller<span class="token punctuation">.</span><span class="token function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>larger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在运行测试会产生以下结果：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> rectangle v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/rectangle)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>66s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>rectangle<span class="token operator">-</span>6584c4561e48942e<span class="token punctuation">)</span>

running <span class="token number">2</span> tests
test <span class="token namespace">tests<span class="token punctuation">::</span></span>larger_can_hold_smaller <span class="token punctuation">...</span> <span class="token constant">FAILED</span>
test <span class="token namespace">tests<span class="token punctuation">::</span></span>smaller_cannot_hold_larger <span class="token punctuation">...</span> ok

failures<span class="token punctuation">:</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token namespace">tests<span class="token punctuation">::</span></span>larger_can_hold_smaller stdout <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
thread <span class="token lifetime-annotation symbol">'tests</span><span class="token punctuation">::</span>larger_can_hold_smaller' panicked at src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span>
assertion failed<span class="token punctuation">:</span> larger<span class="token punctuation">.</span><span class="token function">can_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>smaller<span class="token punctuation">)</span>
note<span class="token punctuation">:</span> run with `<span class="token constant">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span>` environment variable to display a backtrace


failures<span class="token punctuation">:</span>
    <span class="token namespace">tests<span class="token punctuation">::</span></span>larger_can_hold_smaller

test result<span class="token punctuation">:</span> <span class="token constant">FAILED</span><span class="token punctuation">.</span> <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">1</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

error<span class="token punctuation">:</span> test failed<span class="token punctuation">,</span> to rerun pass `<span class="token operator">-</span><span class="token operator">-</span>lib`
</code></pre></div><p>我们的测试捕获了 bug！因为 larger.width 是 8，smaller.width 是 5，can_hold 中宽度的比较现在返回 false：8 不小于 5。</p> <h3 id="使用-assert-eq-和-assert-ne-宏测试相等性"><a href="#使用-assert-eq-和-assert-ne-宏测试相等性" class="header-anchor">#</a> 使用 assert_eq! 和 assert_ne! 宏测试相等性</h3> <p>验证功能的一种常见方法是测试代码执行结果与预期返回值之间的相等性。你可以使用 assert! 宏并传入一个使用 == 运算符的表达式来实现这一点。然而，这种测试非常常见，以至于标准库提供了一对宏—— assert_eq! 和 assert_ne! ——来更方便地执行此测试。这些宏分别比较两个参数的相等性或不相等性。如果断言失败，它们还会打印出两个值，这使得更容易看出测试失败的原因；相反，assert! 宏只表明它得到了 == 表达式的 false 值，而不打印导致 false 值的值。</p> <p>在示例 11-7 中，我们编写了一个名为 add_two 的函数，它将 2 添加到其参数中，然后我们使用 assert_eq! 宏测试这个函数。</p> <p>Filename: src/lib.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_two</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
    a <span class="token operator">+</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">it_adds_two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">add_two</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 11-7：使用 assert_eq! 宏测试函数 add_two</p> <p>让我们检查它是否通过！</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> adder v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/adder)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>58s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>adder<span class="token operator">-</span>92948b65e88960b4<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>it_adds_two <span class="token punctuation">...</span> ok

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

   <span class="token class-name">Doc</span><span class="token operator">-</span>tests adder

running <span class="token number">0</span> tests

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s
</code></pre></div><p>我们创建了一个名为 result 的变量，它保存调用 add_two(2) 的结果。然后我们将 result 和 4 作为参数传递给 assert_eq!。这个测试的输出行是 test tests::it_adds_two ... ok，ok 文本表示我们的测试通过了！</p> <p>让我们在代码中引入一个错误，看看 assert_eq! 在失败时是什么样子。将 add_two 函数的实现改为添加 3：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add_two</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">usize</span> <span class="token punctuation">{</span>
    a <span class="token operator">+</span> <span class="token number">3</span>
<span class="token punctuation">}</span>

<span class="token comment">// #[cfg(test)]</span>
<span class="token comment">// mod tests {</span>
<span class="token comment">//     use super::*;</span>

<span class="token comment">//     #[test]</span>
<span class="token comment">//     fn it_adds_two() {</span>
<span class="token comment">//         let result = add_two(2);</span>
<span class="token comment">//         assert_eq!(result, 4);</span>
<span class="token comment">//     }</span>
<span class="token comment">// }</span>
</code></pre></div><p>再次运行测试：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> adder v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/adder)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>61s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>adder<span class="token operator">-</span>92948b65e88960b4<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>it_adds_two <span class="token punctuation">...</span> <span class="token constant">FAILED</span>

failures<span class="token punctuation">:</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token namespace">tests<span class="token punctuation">::</span></span>it_adds_two stdout <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
thread <span class="token lifetime-annotation symbol">'tests</span><span class="token punctuation">::</span>it_adds_two' panicked at src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span>
assertion `left <span class="token operator">==</span> right` failed
  left<span class="token punctuation">:</span> <span class="token number">5</span>
 right<span class="token punctuation">:</span> <span class="token number">4</span>
note<span class="token punctuation">:</span> run with `<span class="token constant">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span>` environment variable to display a backtrace


failures<span class="token punctuation">:</span>
    <span class="token namespace">tests<span class="token punctuation">::</span></span>it_adds_two

test result<span class="token punctuation">:</span> <span class="token constant">FAILED</span><span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">1</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

error<span class="token punctuation">:</span> test failed<span class="token punctuation">,</span> to rerun pass `<span class="token operator">-</span><span class="token operator">-</span>lib`
</code></pre></div><p>我们的测试捕获了这个错误！it_adds_two 测试失败了，消息告诉我们断言 <code>left == right</code> 失败，并显示了左值和右值是什么。这个消息帮助我们开始调试：左参数，也就是我们调用 add_two(2) 的结果，是 5，但右参数是 4。当我们有很多测试在进行时，你可以想象这会特别有帮助。</p> <p>请注意，在某些语言和测试框架中，相等性断言函数的参数被称为 expected 和 actual，参数的指定顺序很重要。然而，在 Rust 中，它们被称为 left 和 right，我们指定预期值和代码产生的值的顺序并不重要。我们可以在这个测试中将断言写为 assert_eq!(4, result)，这将产生相同的失败消息，显示断言失败：<code>(left == right)</code>。</p> <p>如果我们给 assert_ne! 宏的两个值不相等，它就会通过；如果它们相等，它就会失败。当我们不确定一个值会是什么，但知道它绝对不应该是什么时，这个宏最有用。例如，如果我们测试一个保证以某种方式改变其输入的函数，但输入改变的方式取决于我们运行测试的星期几，那么最好的断言可能是函数的输出不等于输入。</p> <p>在底层，assert_eq! 和 assert_ne! 宏分别使用 == 和 != 运算符。当断言失败时，这些宏使用调试格式打印它们的参数，这意味着被比较的值必须实现 PartialEq 和 Debug 特性。所有基本类型和大多数标准库类型都实现了这些特性。对于你自己定义的结构体和枚举，你需要实现 PartialEq 来断言这些类型的相等性。你还需要实现 Debug 以便在断言失败时打印值。因为这两个特性都是可派生的特性，如第 5 章的示例 5-12 中所述，这通常只需要在结构体或枚举定义上添加 #[derive(PartialEq, Debug)] 注解就可以了。有关这些和其他可派生特性的更多详细信息，请参见附录 C，&quot;<a href="../appendix/appendix-c">可派生特性</a>&quot;。</p> <h3 id="添加自定义失败消息"><a href="#添加自定义失败消息" class="header-anchor">#</a> 添加自定义失败消息</h3> <p>你还可以向 assert!、assert_eq! 和 assert_ne! 宏添加自定义消息，作为可选参数与失败消息一起打印。在必需参数之后指定的任何参数都会传递给 format! 宏（在第 8 章的&quot;使用 + 运算符或 format! 宏进行连接&quot;部分中讨论过），因此你可以传递一个包含 {} 占位符的格式字符串和要放入这些占位符的值。自定义消息对于记录断言的含义很有用；当测试失败时，你将更好地了解代码中的问题所在。</p> <p>例如，假设我们有一个函数，它通过名字向人们问候，我们想测试我们传入函数的名字是否出现在输出中：</p> <p>Filename: src/lib.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">greeting</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello {name}!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">greeting_contains_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token string">&quot;Carol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;Carol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个程序的需求还没有达成一致，我们很确定问候语开头的 Hello 文本将会改变。我们决定不希望在需求变更时必须更新测试，所以我们不检查从 greeting 函数返回的值是否完全相等，而只是断言输出包含输入参数的文本。</p> <p>现在让我们通过更改 greeting 函数来排除名字，看看默认的测试失败是什么样子：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">greeting</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// #[cfg(test)]</span>
<span class="token comment">// mod tests {</span>
<span class="token comment">//     use super::*;</span>

<span class="token comment">//     #[test]</span>
<span class="token comment">//     fn greeting_contains_name() {</span>
<span class="token comment">//         let result = greeting(&quot;Carol&quot;);</span>
<span class="token comment">//         assert!(result.contains(&quot;Carol&quot;));</span>
<span class="token comment">//     }</span>
<span class="token comment">// }</span>
</code></pre></div><p>运行这个测试会产生以下结果：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> greeter v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/greeter)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>91s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>greeter<span class="token operator">-</span>170b942eb5bf5e3a<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>greeting_contains_name <span class="token punctuation">...</span> <span class="token constant">FAILED</span>

failures<span class="token punctuation">:</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token namespace">tests<span class="token punctuation">::</span></span>greeting_contains_name stdout <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
thread <span class="token lifetime-annotation symbol">'tests</span><span class="token punctuation">::</span>greeting_contains_name' panicked at src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span>
assertion failed<span class="token punctuation">:</span> result<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;Carol&quot;</span><span class="token punctuation">)</span>
note<span class="token punctuation">:</span> run with `<span class="token constant">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span>` environment variable to display a backtrace


failures<span class="token punctuation">:</span>
    <span class="token namespace">tests<span class="token punctuation">::</span></span>greeting_contains_name

test result<span class="token punctuation">:</span> <span class="token constant">FAILED</span><span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">1</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

error<span class="token punctuation">:</span> test failed<span class="token punctuation">,</span> to rerun pass `<span class="token operator">-</span><span class="token operator">-</span>lib`
</code></pre></div><p>这个结果只表明断言失败了，以及断言在哪一行。更有用的失败消息会打印出 greeting 函数的值。让我们添加一个自定义失败消息，由一个格式字符串组成，其中包含一个占位符，填入我们从 greeting 函数得到的实际值：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">greeting</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;Hello!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">greeting_contains_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token string">&quot;Carol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property">assert!</span><span class="token punctuation">(</span>
            result<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;Carol&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;Greeting did not contain name, value was `{result}`&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在当我们运行测试时，我们会得到一个更有信息量的错误消息：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> greeter v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/greeter)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>93s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>greeter<span class="token operator">-</span>170b942eb5bf5e3a<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>greeting_contains_name <span class="token punctuation">...</span> <span class="token constant">FAILED</span>

failures<span class="token punctuation">:</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token namespace">tests<span class="token punctuation">::</span></span>greeting_contains_name stdout <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
thread <span class="token lifetime-annotation symbol">'tests</span><span class="token punctuation">::</span>greeting_contains_name' panicked at src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">:</span>
<span class="token class-name">Greeting</span> did not contain name<span class="token punctuation">,</span> value was `<span class="token macro property">Hello!</span>`
note<span class="token punctuation">:</span> run with `<span class="token constant">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span>` environment variable to display a backtrace


failures<span class="token punctuation">:</span>
    <span class="token namespace">tests<span class="token punctuation">::</span></span>greeting_contains_name

test result<span class="token punctuation">:</span> <span class="token constant">FAILED</span><span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">1</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

error<span class="token punctuation">:</span> test failed<span class="token punctuation">,</span> to rerun pass `<span class="token operator">-</span><span class="token operator">-</span>lib`
</code></pre></div><p>我们可以在测试输出中看到我们实际得到的值，这将帮助我们调试发生了什么，而不是我们期望发生的事情。</p> <h3 id="使用-should-panic-检查-panic"><a href="#使用-should-panic-检查-panic" class="header-anchor">#</a> 使用 should_panic 检查 panic</h3> <p>除了检查返回值外，确保我们的代码按预期处理错误条件也很重要。例如，考虑我们在第 9 章的代码示例 9-13 中创建的 Guess 类型。使用 Guess 的其他代码依赖于 Guess 实例只包含 1 到 100 之间的值的保证。我们可以编写一个测试，确保尝试创建一个值超出该范围的 Guess 实例会导致 panic。</p> <p>我们通过在测试函数上添加 should_panic 属性来实现这一点。如果函数内的代码发生 panic，测试就通过；如果函数内的代码没有 panic，测试就失败。</p> <p>代码示例 11-8 展示了一个测试，用于检查 Guess::new 的错误条件是否在我们预期的情况下发生。</p> <p>Filename: src/lib.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Guess</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> value <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Guess value must be between 1 and 100, got {value}.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Guess</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token attribute attr-name">#[should_panic]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">greater_than_100</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Guess</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码示例 11-8：测试某个条件会导致 panic!</p> <p>我们将 <code>#[should_panic]</code> 属性放在 <code>#[test]</code> 属性之后，并在它所适用的测试函数之前。让我们看看这个测试通过时的结果：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> guessing_game v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/guessing_game)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>58s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>guessing_game<span class="token operator">-</span>57d70c3acb738f4d<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>greater_than_100 <span class="token operator">-</span> should panic <span class="token punctuation">...</span> ok

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">1</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

   <span class="token class-name">Doc</span><span class="token operator">-</span>tests guessing_game

running <span class="token number">0</span> tests

test result<span class="token punctuation">:</span> ok<span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">0</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s
</code></pre></div><p>看起来不错！现在让我们在代码中引入一个 bug，移除 new 函数在值大于 100 时会 panic 的条件：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Guess</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// --snip--</span>
<span class="token keyword">impl</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Guess value must be between 1 and 100, got {value}.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Guess</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// #[cfg(test)]</span>
<span class="token comment">// mod tests {</span>
<span class="token comment">//     use super::*;</span>

<span class="token comment">//     #[test]</span>
<span class="token comment">//     #[should_panic]</span>
<span class="token comment">//     fn greater_than_100() {</span>
<span class="token comment">//         Guess::new(200);</span>
<span class="token comment">//     }</span>
<span class="token comment">// }</span>
</code></pre></div><p>当我们运行代码示例 11-8 中的测试时，它会失败：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> guessing_game v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/guessing_game)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>62s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>guessing_game<span class="token operator">-</span>57d70c3acb738f4d<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>greater_than_100 <span class="token operator">-</span> should panic <span class="token punctuation">...</span> <span class="token constant">FAILED</span>

failures<span class="token punctuation">:</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token namespace">tests<span class="token punctuation">::</span></span>greater_than_100 stdout <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
note<span class="token punctuation">:</span> test did not panic <span class="token keyword">as</span> expected

failures<span class="token punctuation">:</span>
    <span class="token namespace">tests<span class="token punctuation">::</span></span>greater_than_100

test result<span class="token punctuation">:</span> <span class="token constant">FAILED</span><span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">1</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

error<span class="token punctuation">:</span> test failed<span class="token punctuation">,</span> to rerun pass `<span class="token operator">-</span><span class="token operator">-</span>lib`
</code></pre></div><p>在这种情况下，我们没有得到非常有用的信息，但是当我们查看测试函数时，我们看到它被标注为 <code>#[should_panic]</code>。我们得到的失败意味着测试函数中的代码没有引起 panic。</p> <p>使用 should_panic 的测试可能不够精确。即使测试因为我们预期之外的原因而 panic，should_panic 测试也会通过。为了使 should_panic 测试更精确，我们可以在 should_panic 属性中添加一个可选的 expected 参数。测试工具将确保失败消息包含所提供的文本。例如，考虑代码示例 11-9 中 Guess 的修改代码，其中 new 函数根据值是太小还是太大而使用不同的消息进行 panic。</p> <p>Filename: src/lib.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Guess</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// --snip--</span>

<span class="token keyword">impl</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Guess value must be greater than or equal to 1, got {value}.&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> value <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Guess value must be less than or equal to 100, got {value}.&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Guess</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token attribute attr-name">#[should_panic(expected = <span class="token string">&quot;less than or equal to 100&quot;</span>)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">greater_than_100</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Guess</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码示例 11-9：使用包含指定子字符串的 panic! 消息进行测试</p> <p>这个测试将通过，因为我们在 should_panic 属性的 expected 参数中放置的值是 Guess::new 函数 panic 消息的子字符串。我们可以指定我们期望的整个 panic 消息，在这种情况下将是 Guess value must be less than or equal to 100, got 200。你选择指定的内容取决于 panic 消息中有多少是唯一的或动态的，以及你希望测试有多精确。在这种情况下，panic 消息的子字符串足以确保测试函数中的代码执行 else if value &gt; 100 分支。</p> <p>为了看看当带有预期消息的 should_panic 测试失败时会发生什么，让我们再次通过交换 if value &lt; 1 和 else if value &gt; 100 块的主体在代码中引入一个 bug：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Guess</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Guess value must be less than or equal to 100, got {value}.&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> value <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token punctuation">{</span>
            <span class="token macro property">panic!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Guess value must be greater than or equal to 1, got {value}.&quot;</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Guess</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token attribute attr-name">#[should_panic(expected = <span class="token string">&quot;less than or equal to 100&quot;</span>)]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">greater_than_100</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Guess</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这次当我们运行 should_panic 测试时，它将失败：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> guessing_game v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/guessing_game)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>66s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>guessing_game<span class="token operator">-</span>57d70c3acb738f4d<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>greater_than_100 <span class="token operator">-</span> should panic <span class="token punctuation">...</span> <span class="token constant">FAILED</span>

failures<span class="token punctuation">:</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token namespace">tests<span class="token punctuation">::</span></span>greater_than_100 stdout <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
thread <span class="token lifetime-annotation symbol">'tests</span><span class="token punctuation">::</span>greater_than_100' panicked at src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span>
<span class="token class-name">Guess</span> value must be greater than or equal to <span class="token number">1</span><span class="token punctuation">,</span> got <span class="token number">200</span><span class="token punctuation">.</span>
note<span class="token punctuation">:</span> run with `<span class="token constant">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span>` environment variable to display a backtrace
note<span class="token punctuation">:</span> panic did not contain expected string
      panic message<span class="token punctuation">:</span> `<span class="token string">&quot;Guess value must be greater than or equal to 1, got 200.&quot;</span>`<span class="token punctuation">,</span>
 expected substring<span class="token punctuation">:</span> `<span class="token string">&quot;less than or equal to 100&quot;</span>`

failures<span class="token punctuation">:</span>
    <span class="token namespace">tests<span class="token punctuation">::</span></span>greater_than_100

test result<span class="token punctuation">:</span> <span class="token constant">FAILED</span><span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">1</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

error<span class="token punctuation">:</span> test failed<span class="token punctuation">,</span> to rerun pass `<span class="token operator">-</span><span class="token operator">-</span>lib`
</code></pre></div><h3 id="在测试中使用-result-t-e"><a href="#在测试中使用-result-t-e" class="header-anchor">#</a> 在测试中使用 <code>Result&lt;T, E&gt;</code></h3> <p>到目前为止，我们的测试在失败时都会 panic。我们也可以使用 <code>Result&lt;T, E&gt;</code> 编写测试！这里是代码示例 11-1 中的测试，重写为使用 <code>Result&lt;T, E&gt;</code> 并在 panic 时返回 Err：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">add</span><span class="token punctuation">(</span>left<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span> right<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u64</span> <span class="token punctuation">{</span>
    left <span class="token operator">+</span> right
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">it_works</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> result <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;two plus two does not equal four&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>it_works 函数现在有 <code>Result&lt;(), String&gt;</code> 返回类型。在函数体中，我们不再调用 assert_eq! 宏，而是在测试通过时返回 <code>Ok(())</code>，在测试失败时返回带有 <code>String</code> 的 Err。</p> <p>编写返回 <code>Result&lt;T, E&gt;</code> 的测试使你能够在测试体中使用问号运算符，这可以是编写应该在其中的任何操作返回 <code>Err</code> 变体时失败的测试的便捷方式。</p> <p>你不能在使用 <code>Result&lt;T, E&gt;</code> 的测试上使用 <code>#[should_panic]</code> 注解。要断言一个操作返回 <code>Err</code> 变体，不要在 <code>Result&lt;T, E&gt;</code> 值上使用问号运算符。相反，使用 <code>assert!(value.is_err())</code>。</p> <p>现在你知道了几种编写测试的方法，让我们看看运行测试时发生了什么，并探索我们可以使用 <code>cargo test</code> 的不同选项。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rust-doc/doc/generics/lifetime-syntax.html" class="prev">
        使用生命周期验证引用
      </a></span> <span class="next"><a href="/rust-doc/doc/testing/running-tests.html">
        运行测试
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/rust-doc/assets/js/app.858f10df.js" defer></script><script src="/rust-doc/assets/js/2.d1f3a877.js" defer></script><script src="/rust-doc/assets/js/1.169debde.js" defer></script><script src="/rust-doc/assets/js/107.b904cd96.js" defer></script>
  </body>
</html>
