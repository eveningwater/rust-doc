<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>要 panic! 还是不要 panic! | rust语言中文文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/rust-doc/logo.svg">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="一门赋予每个人构建可靠且高效软件能力的语言。">
    
    <link rel="preload" href="/rust-doc/assets/css/0.styles.b04b0b2c.css" as="style"><link rel="preload" href="/rust-doc/assets/js/app.f711d394.js" as="script"><link rel="preload" href="/rust-doc/assets/js/2.0b9595c3.js" as="script"><link rel="preload" href="/rust-doc/assets/js/1.c1c7d747.js" as="script"><link rel="preload" href="/rust-doc/assets/js/60.414a0eab.js" as="script"><link rel="prefetch" href="/rust-doc/assets/js/10.ecfc1310.js"><link rel="prefetch" href="/rust-doc/assets/js/11.8ce27df2.js"><link rel="prefetch" href="/rust-doc/assets/js/12.e8a24093.js"><link rel="prefetch" href="/rust-doc/assets/js/13.e2182702.js"><link rel="prefetch" href="/rust-doc/assets/js/14.9c504384.js"><link rel="prefetch" href="/rust-doc/assets/js/15.e953de2c.js"><link rel="prefetch" href="/rust-doc/assets/js/16.1585a3c7.js"><link rel="prefetch" href="/rust-doc/assets/js/17.3428d618.js"><link rel="prefetch" href="/rust-doc/assets/js/18.967f6c8c.js"><link rel="prefetch" href="/rust-doc/assets/js/19.dafc4e8b.js"><link rel="prefetch" href="/rust-doc/assets/js/20.6d69020f.js"><link rel="prefetch" href="/rust-doc/assets/js/21.c3633919.js"><link rel="prefetch" href="/rust-doc/assets/js/22.a565103a.js"><link rel="prefetch" href="/rust-doc/assets/js/23.67d5517c.js"><link rel="prefetch" href="/rust-doc/assets/js/24.bd829c71.js"><link rel="prefetch" href="/rust-doc/assets/js/25.7ea1520a.js"><link rel="prefetch" href="/rust-doc/assets/js/26.ff400385.js"><link rel="prefetch" href="/rust-doc/assets/js/27.d71cf22a.js"><link rel="prefetch" href="/rust-doc/assets/js/28.6193394e.js"><link rel="prefetch" href="/rust-doc/assets/js/29.35f10626.js"><link rel="prefetch" href="/rust-doc/assets/js/3.008fbeae.js"><link rel="prefetch" href="/rust-doc/assets/js/30.2162eed5.js"><link rel="prefetch" href="/rust-doc/assets/js/31.44818758.js"><link rel="prefetch" href="/rust-doc/assets/js/32.e9791cdc.js"><link rel="prefetch" href="/rust-doc/assets/js/33.c81ca844.js"><link rel="prefetch" href="/rust-doc/assets/js/34.5c4722f8.js"><link rel="prefetch" href="/rust-doc/assets/js/35.e6e781f2.js"><link rel="prefetch" href="/rust-doc/assets/js/36.8ceb2703.js"><link rel="prefetch" href="/rust-doc/assets/js/37.21502eb4.js"><link rel="prefetch" href="/rust-doc/assets/js/38.aa7d758d.js"><link rel="prefetch" href="/rust-doc/assets/js/39.2228d545.js"><link rel="prefetch" href="/rust-doc/assets/js/4.2713a537.js"><link rel="prefetch" href="/rust-doc/assets/js/40.472c1505.js"><link rel="prefetch" href="/rust-doc/assets/js/41.8f1514d5.js"><link rel="prefetch" href="/rust-doc/assets/js/42.3af53ef2.js"><link rel="prefetch" href="/rust-doc/assets/js/43.437ab67a.js"><link rel="prefetch" href="/rust-doc/assets/js/44.0febf575.js"><link rel="prefetch" href="/rust-doc/assets/js/45.70ffadba.js"><link rel="prefetch" href="/rust-doc/assets/js/46.1264a8e9.js"><link rel="prefetch" href="/rust-doc/assets/js/47.6e008d86.js"><link rel="prefetch" href="/rust-doc/assets/js/48.01b77d3f.js"><link rel="prefetch" href="/rust-doc/assets/js/49.e5ca56e1.js"><link rel="prefetch" href="/rust-doc/assets/js/5.dd9e9fb1.js"><link rel="prefetch" href="/rust-doc/assets/js/50.8c90af91.js"><link rel="prefetch" href="/rust-doc/assets/js/51.6500b3bc.js"><link rel="prefetch" href="/rust-doc/assets/js/52.cb4ee50a.js"><link rel="prefetch" href="/rust-doc/assets/js/53.879ff44b.js"><link rel="prefetch" href="/rust-doc/assets/js/54.7450bba3.js"><link rel="prefetch" href="/rust-doc/assets/js/55.45375170.js"><link rel="prefetch" href="/rust-doc/assets/js/56.c9fc72d1.js"><link rel="prefetch" href="/rust-doc/assets/js/57.38680082.js"><link rel="prefetch" href="/rust-doc/assets/js/58.4dc44a44.js"><link rel="prefetch" href="/rust-doc/assets/js/59.071f2b6a.js"><link rel="prefetch" href="/rust-doc/assets/js/6.51c20ddf.js"><link rel="prefetch" href="/rust-doc/assets/js/61.fbca79d3.js"><link rel="prefetch" href="/rust-doc/assets/js/62.0126141a.js"><link rel="prefetch" href="/rust-doc/assets/js/63.ffdaaf34.js"><link rel="prefetch" href="/rust-doc/assets/js/64.dc545eb8.js"><link rel="prefetch" href="/rust-doc/assets/js/65.1c60fe98.js"><link rel="prefetch" href="/rust-doc/assets/js/66.d2ee3fec.js"><link rel="prefetch" href="/rust-doc/assets/js/67.e77ef900.js"><link rel="prefetch" href="/rust-doc/assets/js/68.94f6fa4d.js"><link rel="prefetch" href="/rust-doc/assets/js/69.25085e3c.js"><link rel="prefetch" href="/rust-doc/assets/js/7.a5b3ba1a.js"><link rel="prefetch" href="/rust-doc/assets/js/70.9dcca70e.js"><link rel="prefetch" href="/rust-doc/assets/js/71.c71a2f0a.js"><link rel="prefetch" href="/rust-doc/assets/js/72.5d6dfc7d.js"><link rel="prefetch" href="/rust-doc/assets/js/73.dafcbf89.js"><link rel="prefetch" href="/rust-doc/assets/js/74.d76a5f17.js"><link rel="prefetch" href="/rust-doc/assets/js/75.3e595121.js"><link rel="prefetch" href="/rust-doc/assets/js/76.d74a7002.js"><link rel="prefetch" href="/rust-doc/assets/js/77.b6594338.js"><link rel="prefetch" href="/rust-doc/assets/js/78.5f6e7071.js"><link rel="prefetch" href="/rust-doc/assets/js/79.0e345ae8.js"><link rel="prefetch" href="/rust-doc/assets/js/80.d187d07c.js"><link rel="prefetch" href="/rust-doc/assets/js/81.b391bef3.js"><link rel="prefetch" href="/rust-doc/assets/js/82.31dcd912.js"><link rel="prefetch" href="/rust-doc/assets/js/83.619d30cb.js"><link rel="prefetch" href="/rust-doc/assets/js/84.5d7f7a4e.js"><link rel="prefetch" href="/rust-doc/assets/js/85.41b98b34.js"><link rel="prefetch" href="/rust-doc/assets/js/86.3300829c.js"><link rel="prefetch" href="/rust-doc/assets/js/87.21ff1f76.js"><link rel="prefetch" href="/rust-doc/assets/js/vendors~docsearch.a07464bc.js">
    <link rel="stylesheet" href="/rust-doc/assets/css/0.styles.b04b0b2c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rust-doc/" class="home-link router-link-active"><!----> <span class="site-name">rust语言中文文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/rust-doc/doc/introduce/introduce.html" class="sidebar-link">Rust介绍</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/getting-started/getting-started" class="sidebar-heading clickable"><span>入门</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/rust-doc/doc/guess-game/guess-game.html" class="sidebar-link">猜一猜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-concept/common-concept" class="sidebar-heading clickable"><span>常用的编程概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/understand-ownership/understand-ownership" class="sidebar-heading clickable"><span>认识所有权</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/structs/structs" class="sidebar-heading clickable"><span>使用结构体来构造相关数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/enums/enums" class="sidebar-heading clickable"><span>枚举</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/packages-crates-and-modules/packages-crates-and-modules" class="sidebar-heading clickable"><span>使用包、依赖箱和模块管理不断增长的项目</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-collections/common-collections" class="sidebar-heading clickable"><span>常用集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/error-handling/error-handling" class="sidebar-heading clickable open"><span>错误处理</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust-doc/doc/error-handling/unrecoverable-errors-with-panic.html" class="sidebar-link">使用 panic! 处理不可恢复的错误</a></li><li><a href="/rust-doc/doc/error-handling/recoverable-errors-with-result.html" class="sidebar-link">可恢复错误及结果</a></li><li><a href="/rust-doc/doc/error-handling/to-panic-or-not-to-panic.html" aria-current="page" class="active sidebar-link">要 panic! 还是不要 panic!</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust-doc/doc/error-handling/to-panic-or-not-to-panic.html#要-panic-还是不要-panic" class="sidebar-link">要 panic! 还是不要 panic!</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/generics/generics" class="sidebar-heading clickable"><span>泛型类型、特性和生命周期</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/testing/testing" class="sidebar-heading clickable"><span>测试</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/an-io-project/an-io-project" class="sidebar-heading clickable"><span>I/O 项目：构建命令行程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/functional-features/functional-features" class="sidebar-heading clickable"><span>函数式语言特性：迭代器与闭包</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>附录</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="要-panic-还是不要-panic"><a href="#要-panic-还是不要-panic" class="header-anchor">#</a> 要 panic! 还是不要 panic!</h2> <p>那么，你如何决定何时应该调用 panic! 以及何时应该返回 Result 呢？当代码发生 panic 时，没有恢复的方法。你可以为任何错误情况调用 panic!，无论是否有可能恢复，但这样你就代表调用代码做出了一个情况不可恢复的决定。当你选择返回 Result 值时，你给了调用代码选择权。调用代码可以选择以适合其情况的方式尝试恢复，或者它可以决定在这种情况下 Err 值是不可恢复的，所以它可以调用 panic! 并将你的可恢复错误转变为不可恢复错误。因此，返回 Result 是定义可能失败的函数时的一个很好的默认选择。</p> <p>在示例、原型代码和测试等情况下，编写发生 panic 的代码比返回 Result 更为合适。让我们探讨一下原因，然后讨论编译器无法判断失败是不可能的情况，但作为人类，你可以判断。本章将以一些关于如何决定是否在库代码中使用 panic 的一般指导原则作为结束。</p> <h3 id="示例、原型代码和测试"><a href="#示例、原型代码和测试" class="header-anchor">#</a> 示例、原型代码和测试</h3> <p>当你编写一个示例来说明某个概念时，同时包含健壮的错误处理代码可能会使示例不那么清晰。在示例中，大家都理解像 unwrap 这样可能会 panic 的方法调用只是你希望应用程序处理错误的方式的占位符，这可能会根据你代码的其余部分在做什么而有所不同。</p> <p>同样，在原型设计中，unwrap 和 expect 方法非常方便，在你准备好决定如何处理错误之前。它们在你的代码中留下清晰的标记，表明你准备好让程序更加健壮的时候。</p> <p>如果测试中的方法调用失败，你会希望整个测试失败，即使该方法不是被测试的功能。因为 panic! 是测试被标记为失败的方式，所以调用 unwrap 或 expect 正是应该发生的事情。</p> <h3 id="你比编译器拥有更多信息的情况"><a href="#你比编译器拥有更多信息的情况" class="header-anchor">#</a> 你比编译器拥有更多信息的情况</h3> <p>当你有一些其他逻辑确保 Result 将具有 Ok 值，但这种逻辑不是编译器能够理解的，调用 unwrap 或 expect 也是合适的。你仍然会有一个需要处理的 Result 值：你调用的任何操作仍然有可能在一般情况下失败，即使在你特定的情况下逻辑上是不可能的。如果你可以通过手动检查代码来确保你永远不会有 Err 变体，那么调用 unwrap 是完全可以接受的，甚至更好的是在 expect 文本中记录你认为永远不会有 Err 变体的原因。这里有一个例子：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>net<span class="token punctuation">::</span></span><span class="token class-name">IpAddr</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> home<span class="token punctuation">:</span> <span class="token class-name">IpAddr</span> <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span>
        <span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Hardcoded IP address should be valid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们通过解析一个硬编码的字符串来创建一个 IpAddr 实例。我们可以看到 127.0.0.1 是一个有效的 IP 地址，所以在这里使用 expect 是可以接受的。然而，拥有一个硬编码的有效字符串并不会改变 parse 方法的返回类型：我们仍然会得到一个 Result 值，编译器仍然会让我们处理 Result，就好像 Err 变体是一种可能性一样，因为编译器不够聪明，无法看出这个字符串总是一个有效的 IP 地址。如果 IP 地址字符串来自用户而不是硬编码到程序中，因此确实有失败的可能性，我们肯定会希望以更健壮的方式处理 Result。提到这个 IP 地址是硬编码的假设将提示我们，如果将来我们需要从其他来源获取 IP 地址，就会改变 expect 为更好的错误处理代码。</p> <h3 id="错误处理的指导原则"><a href="#错误处理的指导原则" class="header-anchor">#</a> 错误处理的指导原则</h3> <p>当你的代码可能会陷入糟糕状态时，建议让你的代码 panic。在这种情况下，糟糕状态是指某些假设、保证、契约或不变量被破坏，例如当无效值、矛盾值或缺失值被传递给你的代码时，再加上以下一项或多项：</p> <ul><li>糟糕状态是意外的，而不是可能经常发生的事情，比如用户以错误格式输入数据。</li> <li>在这一点之后，你的代码需要依赖于不处于这种糟糕状态，而不是在每一步都检查问题。</li> <li>没有好的方法在你使用的类型中编码这些信息。我们将在第 18 章的&quot;将状态和行为编码为类型&quot;部分中详细讨论这个含义。</li></ul> <p>如果有人调用你的代码并传入没有意义的值，如果可能的话，最好返回一个错误，这样库的用户可以决定在这种情况下他们想做什么。然而，在继续可能不安全或有害的情况下，最好的选择可能是调用 panic! 并提醒使用你的库的人注意他们代码中的错误，以便他们在开发过程中修复它。同样，如果你调用的外部代码超出了你的控制范围，并且它返回了一个你无法修复的无效状态，panic! 通常是合适的。</p> <p>然而，当预期会失败时，返回 Result 比调用 panic! 更合适。例子包括解析器被给予格式错误的数据，或者 HTTP 请求返回表明你已达到速率限制的状态。在这些情况下，返回 Result 表明失败是一种预期的可能性，调用代码必须决定如何处理。</p> <p>当你的代码执行一个操作，如果使用无效值调用可能会使用户处于风险中，你的代码应该首先验证值是否有效，如果值无效则 panic。这主要是出于安全原因：尝试对无效数据进行操作可能会使你的代码暴露于漏洞。这是标准库在你尝试进行越界内存访问时调用 panic! 的主要原因：尝试访问不属于当前数据结构的内存是一个常见的安全问题。函数通常有契约：只有在输入满足特定要求时，它们的行为才能得到保证。当契约被违反时，panic 是有意义的，因为契约违反总是表明调用方的错误，而且这不是你希望调用代码必须明确处理的错误类型。事实上，对于调用代码来说，没有合理的恢复方式；调用程序员需要修复代码。函数的契约，特别是当违反会导致 panic 时，应该在函数的 API 文档中解释。</p> <p>然而，在所有函数中都有大量的错误检查会很冗长且令人烦恼。幸运的是，你可以使用 Rust 的类型系统（以及编译器完成的类型检查）来为你完成许多检查。如果你的函数有一个特定类型的参数，你可以继续你的代码逻辑，知道编译器已经确保你有一个有效值。例如，如果你有一个类型而不是 Option，你的程序期望有东西而不是什么都没有。然后你的代码不必处理 Some 和 None 变体的两种情况：它只会有一种情况，即肯定有一个值。尝试向你的函数传递空值的代码甚至不会编译，所以你的函数不必在运行时检查这种情况。另一个例子是使用无符号整数类型，如 u32，这确保参数永远不会是负数。</p> <h3 id="创建用于验证的自定义类型"><a href="#创建用于验证的自定义类型" class="header-anchor">#</a> 创建用于验证的自定义类型</h3> <p>让我们更进一步，利用 Rust 的类型系统来确保我们有一个有效值，并看看创建一个用于验证的自定义类型。回想一下第 2 章中的猜谜游戏，我们的代码要求用户猜一个 1 到 100 之间的数字。我们从未在检查用户的猜测与我们的秘密数字之前验证用户的猜测是否在这些数字之间；我们只验证猜测是否为正数。在这种情况下，后果并不是很严重：我们的输出&quot;太高&quot;或&quot;太低&quot;仍然是正确的。但是，引导用户进行有效猜测并在用户猜测的数字超出范围时与用户输入字母时有不同的行为，这将是一个有用的增强功能。</p> <p>实现这一点的一种方法是将猜测解析为 i32 而不仅仅是 u32，以允许可能的负数，然后添加一个检查，确保数字在范围内，如下所示：</p> <p>文件名：src/main.rs：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token class-name">Rng</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cmp<span class="token punctuation">::</span></span><span class="token class-name">Ordering</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Guess the number!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> secret_number <span class="token operator">=</span> <span class="token namespace">rand<span class="token punctuation">::</span></span><span class="token function">thread_rng</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gen_range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">..=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">loop</span> <span class="token punctuation">{</span>
        <span class="token comment">// --snip--</span>

        <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Please input your guess.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> guess <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token function">stdin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> guess<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to read line&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> guess<span class="token punctuation">:</span> <span class="token keyword">i32</span> <span class="token operator">=</span> <span class="token keyword">match</span> guess<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> num<span class="token punctuation">,</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">continue</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> guess <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> guess <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token punctuation">{</span>
            <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The secret number will be between 1 and 100.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">match</span> guess<span class="token punctuation">.</span><span class="token function">cmp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>secret_number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// --snip--</span>
            <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Less</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Too small!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Greater</span> <span class="token operator">=&gt;</span> <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Too big!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Equal</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;You win!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>if 表达式检查我们的值是否超出范围，告诉用户问题所在，并调用 continue 开始循环的下一次迭代并要求另一个猜测。在 if 表达式之后，我们可以继续比较 guess 和秘密数字，知道 guess 在 1 到 100 之间。</p> <p>然而，这不是一个理想的解决方案：如果程序只对 1 到 100 之间的值进行操作是绝对关键的，并且它有许多具有此要求的函数，那么在每个函数中都进行这样的检查将会很繁琐（并可能影响性能）。</p> <p>相反，我们可以创建一个新类型，并将验证放在一个函数中，以创建该类型的实例，而不是在各处重复验证。这样，函数可以安全地在其签名中使用新类型，并自信地使用它们接收的值。清单 9-13 展示了一种定义 Guess 类型的方法，该类型只有在新函数接收到 1 到 100 之间的值时才会创建 Guess 的实例。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#![allow(unused)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Guess</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Guess</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> value <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">||</span> value <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token punctuation">{</span>
                <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Guess value must be between 1 and 100, got {value}.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Guess</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">i32</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>清单 9-13：一个只有在值在 1 到 100 之间时才会继续的 Guess 类型</p> <p>首先，我们定义了一个名为 Guess 的结构体，它有一个名为 value 的字段，该字段持有一个 i32。这是存储数字的地方。</p> <p>然后，我们在 Guess 上实现了一个名为 new 的关联函数，用于创建 Guess 值的实例。new 函数被定义为有一个名为 value 的 i32 类型参数，并返回一个 Guess。new 函数体中的代码测试 value 以确保它在 1 到 100 之间。如果 value 没有通过这个测试，我们会调用 panic!，这将提醒编写调用代码的程序员，他们有一个需要修复的错误，因为创建一个值超出此范围的 Guess 将违反 Guess::new 所依赖的契约。Guess::new 可能会 panic 的条件应该在其面向公众的 API 文档中讨论；我们将在第 14 章中介绍你创建的 API 文档中指示 panic! 可能性的文档约定。如果 value 通过测试，我们创建一个新的 Guess，其 value 字段设置为 value 参数，并返回 Guess。</p> <p>接下来，我们实现了一个名为 value 的方法，它借用 self，没有其他参数，并返回一个 i32。这种方法有时被称为 getter，因为它的目的是从其字段获取一些数据并返回它。这个公共方法是必要的，因为 Guess 结构体的 value 字段是私有的。重要的是 value 字段是私有的，这样使用 Guess 结构体的代码就不允许直接设置 value：模块外的代码必须使用 Guess::new 函数创建 Guess 的实例，从而确保没有办法让 Guess 拥有一个没有经过 Guess::new 函数中的条件检查的值。</p> <p>一个只有参数或只返回 1 到 100 之间的数字的函数，可以在其签名中声明它接受或返回一个 Guess 而不是 i32，并且不需要在其函数体中进行任何额外的检查。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>Rust 的错误处理功能旨在帮助你编写更健壮的代码。panic! 宏表明你的程序处于无法处理的状态，让你告诉进程停止，而不是尝试继续使用无效或不正确的值。Result 枚举使用 Rust 的类型系统来表明操作可能会以你的代码可以恢复的方式失败。你可以使用 Result 告诉调用你代码的代码，它需要处理潜在的成功或失败。在适当的情况下使用 panic! 和 Result 将使你的代码在面对不可避免的问题时更加可靠。</p> <p>现在你已经看到了标准库如何使用泛型与 Option 和 Result 枚举的有用方法，我们将讨论泛型如何工作以及如何在你的代码中使用它们。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rust-doc/doc/error-handling/recoverable-errors-with-result.html" class="prev">
        可恢复错误及结果
      </a></span> <span class="next"><a href="/rust-doc/doc/generics/generic-syntax.html">
        泛型数据类型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/rust-doc/assets/js/app.f711d394.js" defer></script><script src="/rust-doc/assets/js/2.0b9595c3.js" defer></script><script src="/rust-doc/assets/js/1.c1c7d747.js" defer></script><script src="/rust-doc/assets/js/60.414a0eab.js" defer></script>
  </body>
</html>
