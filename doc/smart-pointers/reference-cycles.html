<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>引用循环可能导致内存泄漏 | rust语言中文文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/rust-doc/logo.svg">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="一门赋予每个人构建可靠且高效软件能力的语言。">
    
    <link rel="preload" href="/rust-doc/assets/css/0.styles.b04b0b2c.css" as="style"><link rel="preload" href="/rust-doc/assets/js/app.5dbdf326.js" as="script"><link rel="preload" href="/rust-doc/assets/js/2.de3bffe6.js" as="script"><link rel="preload" href="/rust-doc/assets/js/1.5cc4c8d6.js" as="script"><link rel="preload" href="/rust-doc/assets/js/32.0fd42499.js" as="script"><link rel="prefetch" href="/rust-doc/assets/js/10.eb17c9b1.js"><link rel="prefetch" href="/rust-doc/assets/js/100.732ca727.js"><link rel="prefetch" href="/rust-doc/assets/js/101.1cc2e17f.js"><link rel="prefetch" href="/rust-doc/assets/js/102.783c4eba.js"><link rel="prefetch" href="/rust-doc/assets/js/103.93359f3b.js"><link rel="prefetch" href="/rust-doc/assets/js/104.0d541c6d.js"><link rel="prefetch" href="/rust-doc/assets/js/105.7844b86c.js"><link rel="prefetch" href="/rust-doc/assets/js/106.af53b28a.js"><link rel="prefetch" href="/rust-doc/assets/js/107.48076a3f.js"><link rel="prefetch" href="/rust-doc/assets/js/108.42bcc477.js"><link rel="prefetch" href="/rust-doc/assets/js/109.d9647424.js"><link rel="prefetch" href="/rust-doc/assets/js/11.4d96857f.js"><link rel="prefetch" href="/rust-doc/assets/js/110.45657f9d.js"><link rel="prefetch" href="/rust-doc/assets/js/111.eae1197c.js"><link rel="prefetch" href="/rust-doc/assets/js/112.4f617c06.js"><link rel="prefetch" href="/rust-doc/assets/js/113.144d797b.js"><link rel="prefetch" href="/rust-doc/assets/js/114.ade36aa2.js"><link rel="prefetch" href="/rust-doc/assets/js/115.a770441b.js"><link rel="prefetch" href="/rust-doc/assets/js/116.af34b11d.js"><link rel="prefetch" href="/rust-doc/assets/js/117.7140a497.js"><link rel="prefetch" href="/rust-doc/assets/js/118.980c75f8.js"><link rel="prefetch" href="/rust-doc/assets/js/119.d447508f.js"><link rel="prefetch" href="/rust-doc/assets/js/12.0eea138a.js"><link rel="prefetch" href="/rust-doc/assets/js/120.ee6ee238.js"><link rel="prefetch" href="/rust-doc/assets/js/121.b14ed8f5.js"><link rel="prefetch" href="/rust-doc/assets/js/122.64f85a9a.js"><link rel="prefetch" href="/rust-doc/assets/js/123.79962b2d.js"><link rel="prefetch" href="/rust-doc/assets/js/124.d174ec8b.js"><link rel="prefetch" href="/rust-doc/assets/js/125.13bf9574.js"><link rel="prefetch" href="/rust-doc/assets/js/126.fc35ac5d.js"><link rel="prefetch" href="/rust-doc/assets/js/127.b526b073.js"><link rel="prefetch" href="/rust-doc/assets/js/13.420b0b54.js"><link rel="prefetch" href="/rust-doc/assets/js/14.c96b81fc.js"><link rel="prefetch" href="/rust-doc/assets/js/15.c72c8a9e.js"><link rel="prefetch" href="/rust-doc/assets/js/16.1c185a04.js"><link rel="prefetch" href="/rust-doc/assets/js/17.c084fb46.js"><link rel="prefetch" href="/rust-doc/assets/js/18.82ae4a90.js"><link rel="prefetch" href="/rust-doc/assets/js/19.ac65ddaa.js"><link rel="prefetch" href="/rust-doc/assets/js/20.b2f37783.js"><link rel="prefetch" href="/rust-doc/assets/js/21.bc7abb0d.js"><link rel="prefetch" href="/rust-doc/assets/js/22.34214304.js"><link rel="prefetch" href="/rust-doc/assets/js/23.6bf12385.js"><link rel="prefetch" href="/rust-doc/assets/js/24.3123e7b2.js"><link rel="prefetch" href="/rust-doc/assets/js/25.c92ccfb3.js"><link rel="prefetch" href="/rust-doc/assets/js/26.7cf20f6f.js"><link rel="prefetch" href="/rust-doc/assets/js/27.b6484f43.js"><link rel="prefetch" href="/rust-doc/assets/js/28.778214d0.js"><link rel="prefetch" href="/rust-doc/assets/js/29.7b185968.js"><link rel="prefetch" href="/rust-doc/assets/js/3.bfcba754.js"><link rel="prefetch" href="/rust-doc/assets/js/30.b3ac30e3.js"><link rel="prefetch" href="/rust-doc/assets/js/31.4da8ec93.js"><link rel="prefetch" href="/rust-doc/assets/js/33.53e7f224.js"><link rel="prefetch" href="/rust-doc/assets/js/34.6b21045e.js"><link rel="prefetch" href="/rust-doc/assets/js/35.251e1b14.js"><link rel="prefetch" href="/rust-doc/assets/js/36.20741c45.js"><link rel="prefetch" href="/rust-doc/assets/js/37.810ee7d1.js"><link rel="prefetch" href="/rust-doc/assets/js/38.4bc88ad1.js"><link rel="prefetch" href="/rust-doc/assets/js/39.25b21d27.js"><link rel="prefetch" href="/rust-doc/assets/js/4.508a9818.js"><link rel="prefetch" href="/rust-doc/assets/js/40.c4806d92.js"><link rel="prefetch" href="/rust-doc/assets/js/41.42bef7d9.js"><link rel="prefetch" href="/rust-doc/assets/js/42.6fe4c9c0.js"><link rel="prefetch" href="/rust-doc/assets/js/43.0199f751.js"><link rel="prefetch" href="/rust-doc/assets/js/44.16b97fc7.js"><link rel="prefetch" href="/rust-doc/assets/js/45.0db017bc.js"><link rel="prefetch" href="/rust-doc/assets/js/46.3594e3f8.js"><link rel="prefetch" href="/rust-doc/assets/js/47.5ada00cc.js"><link rel="prefetch" href="/rust-doc/assets/js/48.8b36a7ce.js"><link rel="prefetch" href="/rust-doc/assets/js/49.f6758257.js"><link rel="prefetch" href="/rust-doc/assets/js/5.f95f0a29.js"><link rel="prefetch" href="/rust-doc/assets/js/50.d69a475c.js"><link rel="prefetch" href="/rust-doc/assets/js/51.d9f6a1a3.js"><link rel="prefetch" href="/rust-doc/assets/js/52.edaf3c39.js"><link rel="prefetch" href="/rust-doc/assets/js/53.7961a2de.js"><link rel="prefetch" href="/rust-doc/assets/js/54.58d65d7d.js"><link rel="prefetch" href="/rust-doc/assets/js/55.1c4f9239.js"><link rel="prefetch" href="/rust-doc/assets/js/56.d092b5d1.js"><link rel="prefetch" href="/rust-doc/assets/js/57.04f5b2a7.js"><link rel="prefetch" href="/rust-doc/assets/js/58.a3418af2.js"><link rel="prefetch" href="/rust-doc/assets/js/59.0762f312.js"><link rel="prefetch" href="/rust-doc/assets/js/6.c4bf9bde.js"><link rel="prefetch" href="/rust-doc/assets/js/60.ba49db99.js"><link rel="prefetch" href="/rust-doc/assets/js/61.c53d6317.js"><link rel="prefetch" href="/rust-doc/assets/js/62.ba4c9d34.js"><link rel="prefetch" href="/rust-doc/assets/js/63.b08d215f.js"><link rel="prefetch" href="/rust-doc/assets/js/64.e773dc69.js"><link rel="prefetch" href="/rust-doc/assets/js/65.c5598ad5.js"><link rel="prefetch" href="/rust-doc/assets/js/66.c319c85e.js"><link rel="prefetch" href="/rust-doc/assets/js/67.e902a110.js"><link rel="prefetch" href="/rust-doc/assets/js/68.235d62f3.js"><link rel="prefetch" href="/rust-doc/assets/js/69.a73aa5a6.js"><link rel="prefetch" href="/rust-doc/assets/js/7.7610c249.js"><link rel="prefetch" href="/rust-doc/assets/js/70.2e80761f.js"><link rel="prefetch" href="/rust-doc/assets/js/71.3a2e2e52.js"><link rel="prefetch" href="/rust-doc/assets/js/72.8feadd7e.js"><link rel="prefetch" href="/rust-doc/assets/js/73.8df6690f.js"><link rel="prefetch" href="/rust-doc/assets/js/74.31147fcb.js"><link rel="prefetch" href="/rust-doc/assets/js/75.974a3fa6.js"><link rel="prefetch" href="/rust-doc/assets/js/76.3dd7c5eb.js"><link rel="prefetch" href="/rust-doc/assets/js/77.d383a9fc.js"><link rel="prefetch" href="/rust-doc/assets/js/78.6a92fa58.js"><link rel="prefetch" href="/rust-doc/assets/js/79.0e04dd4c.js"><link rel="prefetch" href="/rust-doc/assets/js/80.41d8b541.js"><link rel="prefetch" href="/rust-doc/assets/js/81.bec0d7be.js"><link rel="prefetch" href="/rust-doc/assets/js/82.9da7a232.js"><link rel="prefetch" href="/rust-doc/assets/js/83.e5187cd4.js"><link rel="prefetch" href="/rust-doc/assets/js/84.cdd612ce.js"><link rel="prefetch" href="/rust-doc/assets/js/85.006bdccf.js"><link rel="prefetch" href="/rust-doc/assets/js/86.c27e273d.js"><link rel="prefetch" href="/rust-doc/assets/js/87.082b0346.js"><link rel="prefetch" href="/rust-doc/assets/js/88.87ea3f6b.js"><link rel="prefetch" href="/rust-doc/assets/js/89.7da080a2.js"><link rel="prefetch" href="/rust-doc/assets/js/90.8de1c64b.js"><link rel="prefetch" href="/rust-doc/assets/js/91.9c2fb975.js"><link rel="prefetch" href="/rust-doc/assets/js/92.ae1600f6.js"><link rel="prefetch" href="/rust-doc/assets/js/93.2c6f52d2.js"><link rel="prefetch" href="/rust-doc/assets/js/94.a13c1713.js"><link rel="prefetch" href="/rust-doc/assets/js/95.21e06a23.js"><link rel="prefetch" href="/rust-doc/assets/js/96.73ee5add.js"><link rel="prefetch" href="/rust-doc/assets/js/97.0a2ef5d0.js"><link rel="prefetch" href="/rust-doc/assets/js/98.65ef16c7.js"><link rel="prefetch" href="/rust-doc/assets/js/99.9e91b6ab.js"><link rel="prefetch" href="/rust-doc/assets/js/vendors~docsearch.3b28fe31.js">
    <link rel="stylesheet" href="/rust-doc/assets/css/0.styles.b04b0b2c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rust-doc/" class="home-link router-link-active"><!----> <span class="site-name">rust语言中文文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/rust-doc/doc/introduce/introduce.html" class="sidebar-link">Rust介绍</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/getting-started/getting-started" class="sidebar-heading clickable"><span>入门</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/rust-doc/doc/guess-game/guess-game.html" class="sidebar-link">猜一猜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-concept/common-concept" class="sidebar-heading clickable"><span>常用的编程概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/understand-ownership/understand-ownership" class="sidebar-heading clickable"><span>认识所有权</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/structs/structs" class="sidebar-heading clickable"><span>使用结构体来构造相关数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/enums/enums" class="sidebar-heading clickable"><span>枚举</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/packages-crates-and-modules/packages-crates-and-modules" class="sidebar-heading clickable"><span>使用包、依赖箱和模块管理不断增长的项目</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-collections/common-collections" class="sidebar-heading clickable"><span>常用集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/error-handling/error-handling" class="sidebar-heading clickable"><span>错误处理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/generics/generics" class="sidebar-heading clickable"><span>泛型类型、特性和生命周期</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/testing/testing" class="sidebar-heading clickable"><span>测试</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/an-io-project/an-io-project" class="sidebar-heading clickable"><span>I/O 项目：构建命令行程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/functional-features/functional-features" class="sidebar-heading clickable"><span>函数式语言特性：迭代器与闭包</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/more-about-cargo/more-about-cargo" class="sidebar-heading clickable"><span>关于 Cargo 和 Crates.io 的更多信息</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/smart-pointers/smart-pointers" class="sidebar-heading clickable open"><span>智能指针</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust-doc/doc/smart-pointers/box.html" class="sidebar-link">使用 Box&lt;T&gt; 指向堆上的数据</a></li><li><a href="/rust-doc/doc/smart-pointers/deref.html" class="sidebar-link">通过`Deref`特性将智能指针视为常规引用</a></li><li><a href="/rust-doc/doc/smart-pointers/drop.html" class="sidebar-link">使用`Drop`特性在清理时运行代码</a></li><li><a href="/rust-doc/doc/smart-pointers/rc.html" class="sidebar-link">`Rc&lt;T&gt;`，引用计数智能指针</a></li><li><a href="/rust-doc/doc/smart-pointers/interior-mutability.html" class="sidebar-link">`RefCell&lt;T&gt;`和内部可变性模式</a></li><li><a href="/rust-doc/doc/smart-pointers/reference-cycles.html" aria-current="page" class="active sidebar-link">引用循环可能导致内存泄漏</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust-doc/doc/smart-pointers/reference-cycles.html#引用循环可能导致内存泄漏" class="sidebar-link">引用循环可能导致内存泄漏</a></li><li class="sidebar-sub-header"><a href="/rust-doc/doc/smart-pointers/reference-cycles.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/concurrency/concurrency" class="sidebar-heading clickable"><span>无畏并发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/async-await/async-await" class="sidebar-heading clickable"><span>异步编程基础：Async、Await、Futures 和 Streams</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/oop/oop" class="sidebar-heading clickable"><span>面向对象编程特性</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/patterns/patterns" class="sidebar-heading clickable"><span>模式与匹配</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/advanced-features/advanced-features" class="sidebar-heading clickable"><span>高级特性</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>附录</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="引用循环可能导致内存泄漏"><a href="#引用循环可能导致内存泄漏" class="header-anchor">#</a> 引用循环可能导致内存泄漏</h2> <p>Rust的内存安全保证使得意外创建永远不会被清理的内存（即内存泄漏）变得困难，但并非不可能。完全防止内存泄漏并不是Rust的保证之一，这意味着在Rust中内存泄漏是内存安全的。我们可以看到，通过使用<code>Rc&lt;T&gt;</code>和<code>RefCell&lt;T&gt;</code>，Rust允许内存泄漏：可以创建项目相互引用形成循环的引用。这会导致内存泄漏，因为循环中每个项目的引用计数永远不会达到0，这些值永远不会被丢弃。</p> <h3 id="创建引用循环"><a href="#创建引用循环" class="header-anchor">#</a> 创建引用循环</h3> <p>让我们看看引用循环是如何发生的以及如何防止它，首先从示例15-25中的<code>List</code>枚举定义和<code>tail</code>方法开始。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Cons</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Nil</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">List</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">Cons</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Nil</span> <span class="token operator">=&gt;</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>示例 15-25：一个包含<code>RefCell&lt;T&gt;</code>的cons列表定义，使我们能够修改<code>Cons</code>变体引用的内容</p> <p>我们使用了与示例15-5中不同的<code>List</code>定义变体。<code>Cons</code>变体中的第二个元素现在是<code>RefCell&lt;Rc&lt;List&gt;&gt;</code>，这意味着我们不是像在示例15-24中那样修改<code>i32</code>值，而是要修改<code>Cons</code>变体指向的<code>List</code>值。我们还添加了一个<code>tail</code>方法，使我们能够方便地访问<code>Cons</code>变体的第二个项目。</p> <p>在示例15-26中，我们添加了一个使用示例15-25中定义的<code>main</code>函数。这段代码在<code>a</code>中创建一个列表，在<code>b</code>中创建一个指向<code>a</code>中列表的列表。然后它修改<code>a</code>中的列表使其指向<code>b</code>，从而创建一个引用循环。在这个过程中，有一些<code>println!</code>语句用来显示在各个点上的引用计数。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Cons</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token keyword">i32</span><span class="token punctuation">,</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Nil</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">List</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token class-name">Cons</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Nil</span> <span class="token operator">=&gt;</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a initial rc count = {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a next item = {:?}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a rc count after b creation = {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b initial rc count = {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b next item = {:?}&quot;</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>link<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b rc count after changing a = {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a rc count after changing a = {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Uncomment the next line to see that we have a cycle;</span>
    <span class="token comment">// it will overflow the stack.</span>
    <span class="token comment">// println!(&quot;a next item = {:?}&quot;, a.tail());</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 15-26：创建两个相互指向的<code>List</code>值的引用循环</p> <p>我们创建了一个<code>Rc&lt;List&gt;</code>实例，在变量<code>a</code>中保存一个初始值为5的<code>List</code>值和<code>Nil</code>。然后我们创建另一个<code>Rc&lt;List&gt;</code>实例，在变量<code>b</code>中保存另一个<code>List</code>值，其中包含值<code>10</code>并指向<code>a</code>中的列表。</p> <p>我们修改<code>a</code>使其指向<code>b</code>而不是<code>Nil</code>，从而创建一个循环。我们通过使用<code>tail</code>方法获取<code>a</code>中的<code>RefCell&lt;Rc&lt;List&gt;&gt;</code>的引用，并将其放入变量<code>link</code>中。然后我们在<code>RefCell&lt;Rc&lt;List&gt;&gt;</code>上使用<code>borrow_mut</code>方法，将其内部的值从持有<code>Nil</code>值的<code>Rc&lt;List&gt;</code>更改为<code>b</code>中的<code>Rc&lt;List&gt;</code>。</p> <p>当我们运行这段代码时，暂时保持最后一个<code>println!</code>被注释掉，我们将得到以下输出：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo run
   <span class="token class-name">Compiling</span> cons<span class="token operator">-</span>list v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/cons-list)</span>
    <span class="token class-name">Finished</span> `dev` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>53s
     <span class="token class-name">Running</span> `target<span class="token operator">/</span>debug<span class="token operator">/</span>cons<span class="token operator">-</span>list`
a initial rc count <span class="token operator">=</span> <span class="token number">1</span>
a next item <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token class-name">Nil</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
a rc count after b creation <span class="token operator">=</span> <span class="token number">2</span>
b initial rc count <span class="token operator">=</span> <span class="token number">1</span>
b next item <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token class-name">Nil</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
b rc count after changing a <span class="token operator">=</span> <span class="token number">2</span>
a rc count after changing a <span class="token operator">=</span> <span class="token number">2</span>
</code></pre></div><p>在我们将<code>a</code>中的列表更改为指向<code>b</code>后，<code>a</code>和<code>b</code>中的<code>Rc&lt;List&gt;</code>实例的引用计数都是2。在<code>main</code>结束时，Rust会丢弃变量<code>b</code>，这会将<code>b</code>的<code>Rc&lt;List&gt;</code>实例的引用计数从2减少到1。此时，<code>Rc&lt;List&gt;</code>在堆上的内存不会被丢弃，因为它的引用计数是1，而不是0。然后Rust丢弃<code>a</code>，这也会将<code>a</code>的<code>Rc&lt;List&gt;</code>实例的引用计数从2减少到1。这个实例的内存也不能被丢弃，因为另一个<code>Rc&lt;List&gt;</code>实例仍然引用它。分配给列表的内存将永远不会被回收。为了可视化这个引用循环，我们创建了图15-4中的图表。</p> <p><img src="/rust-doc/assets/img/trpl15-04.dc976bb0.svg" alt=""></p> <p>图15-4：列表<code>a</code>和<code>b</code>相互指向的引用循环</p> <p>如果你取消注释最后一个<code>println!</code>并运行程序，Rust将尝试打印这个循环，<code>a</code>指向<code>b</code>，<code>b</code>指向<code>a</code>，依此类推，直到堆栈溢出。</p> <p>与实际程序相比，在这个例子中创建引用循环的后果并不是很严重：在我们创建引用循环后，程序就结束了。然而，如果一个更复杂的程序在循环中分配了大量内存并长时间保持它，程序将使用比需要更多的内存，可能会使系统不堪重负，导致可用内存耗尽。</p> <p>创建引用循环并不容易，但也不是不可能。如果你有包含<code>Rc&lt;T&gt;</code>值的<code>RefCell&lt;T&gt;</code>值，或者类似的具有内部可变性和引用计数的类型的嵌套组合，你必须确保不创建循环；你不能依赖Rust来捕获它们。创建引用循环将是程序中的逻辑错误，你应该使用自动化测试、代码审查和其他软件开发实践来最小化它。</p> <p>避免引用循环的另一个解决方案是重新组织你的数据结构，使一些引用表示所有权，而一些引用不表示所有权。因此，你可以有由一些所有权关系和一些非所有权关系组成的循环，只有所有权关系影响一个值是否可以被丢弃。在示例15-25中，我们总是希望<code>Cons</code>变体拥有它们的列表，所以重新组织数据结构是不可能的。让我们看一个使用由父节点和子节点组成的图的例子，看看非所有权关系何时是防止引用循环的适当方式。</p> <h3 id="使用weak-t-防止引用循环"><a href="#使用weak-t-防止引用循环" class="header-anchor">#</a> 使用<code>Weak&lt;T&gt;</code>防止引用循环</h3> <p>到目前为止，我们已经证明调用<code>Rc::clone</code>会增加<code>Rc&lt;T&gt;</code>实例的<code>strong_count</code>，并且只有当<code>strong_count</code>为0时，<code>Rc&lt;T&gt;</code>实例才会被清理。你也可以通过调用<code>Rc::downgrade</code>并传递对<code>Rc&lt;T&gt;</code>的引用来创建对<code>Rc&lt;T&gt;</code>实例中值的弱引用。强引用是你共享<code>Rc&lt;T&gt;</code>实例所有权的方式。弱引用不表示所有权关系，它们的计数不影响<code>Rc&lt;T&gt;</code>实例何时被清理。它们不会导致引用循环，因为一旦涉及的值的强引用计数为0，任何包含弱引用的循环都会被打破。</p> <p>当你调用<code>Rc::downgrade</code>时，你会得到一个类型为<code>Weak&lt;T&gt;</code>的智能指针。与将<code>Rc&lt;T&gt;</code>实例中的<code>strong_count</code>增加1不同，调用<code>Rc::downgrade</code>会将<code>weak_count</code>增加1。<code>Rc&lt;T&gt;</code>类型使用<code>weak_count</code>来跟踪存在多少个<code>Weak&lt;T&gt;</code>引用，类似于<code>strong_count</code>。不同之处在于，<code>Rc&lt;T&gt;</code>实例被清理时，<code>weak_count</code>不需要为0。</p> <p>因为<code>Weak&lt;T&gt;</code>引用的值可能已经被丢弃，所以要对<code>Weak&lt;T&gt;</code>指向的值做任何操作，你必须确保该值仍然存在。通过在<code>Weak&lt;T&gt;</code>实例上调用upgrade方法来实现这一点，该方法将返回一个<code>Option&lt;Rc&lt;T&gt;&gt;</code>。如果<code>Rc&lt;T&gt;</code>值尚未被丢弃，你将得到<code>Some</code>结果，如果<code>Rc&lt;T&gt;</code>值已被丢弃，则得到None结果。因为<code>upgrade</code>返回一个<code>Option&lt;Rc&lt;T&gt;&gt;</code>，Rust将确保Some情况和None情况都得到处理，不会有无效指针。</p> <p>作为一个例子，我们将创建一个树，其中的项目不仅知道下一个项目，还知道它们的子项目和父项目。</p> <h3 id="创建树形数据结构-带有子节点的节点"><a href="#创建树形数据结构-带有子节点的节点" class="header-anchor">#</a> 创建树形数据结构：带有子节点的节点</h3> <p>首先，我们将构建一个树，其中的节点知道它们的子节点。我们将创建一个名为<code>Node</code>的结构体，它持有自己的<code>i32</code>值以及对其子<code>Node</code>值的引用：</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> leaf <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> branch <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们希望<code>Node</code>拥有其子节点，并且我们希望与变量共享这种所有权，以便我们可以直接访问树中的每个<code>Node</code>。为此，我们将<code>Vec&lt;T&gt;</code>项定义为<code>Rc&lt;Node&gt;</code>类型的值。我们还希望修改哪些节点是另一个节点的子节点，所以我们在<code>Vec&lt;Rc&lt;Node&gt;&gt;</code>周围有一个<code>RefCell&lt;T&gt;</code>。</p> <p>接下来，我们将使用我们的结构体定义并创建一个名为<code>leaf</code>的<code>Node</code>实例，其值为3且没有子节点，以及另一个名为<code>branch</code>的实例，其值为<code>5</code>且<code>leaf</code>是其子节点之一，如示例15-27所示。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> leaf <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> branch <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 15-27：创建一个没有子节点的<code>leaf</code>节点和一个以<code>leaf</code>为子节点之一的<code>branch</code>节点</p> <p>我们克隆<code>leaf</code>中的<code>Rc&lt;Node&gt;</code>并将其存储在<code>branch</code>中，这意味着<code>leaf</code>中的<code>Node</code>现在有两个所有者：<code>leaf</code>和<code>branch</code>。我们可以通过<code>branch.children</code>从<code>branch</code>到达<code>leaf</code>，但没有办法从<code>leaf</code>到达<code>branch</code>。原因是<code>leaf</code>没有对<code>branch</code>的引用，不知道它们有关联。我们希望<code>leaf</code>知道<code>branch</code>是它的父节点。接下来我们将实现这一点。</p> <h3 id="从子节点添加对其父节点的引用"><a href="#从子节点添加对其父节点的引用" class="header-anchor">#</a> 从子节点添加对其父节点的引用</h3> <p>为了让子节点知道其父节点，我们需要在<code>Node</code>结构体定义中添加一个<code>parent</code>字段。问题在于决定<code>parent</code>的类型应该是什么。我们知道它不能包含<code>Rc&lt;T&gt;</code>，因为这会创建一个引用循环，<code>leaf.parent</code>指向<code>branch</code>，<code>branch.children</code>指向<code>leaf</code>，这将导致它们的<code>strong_count</code>值永远不会为0。</p> <p>从另一个角度思考关系，父节点应该拥有其子节点：如果父节点被丢弃，其子节点也应该被丢弃。然而，子节点不应该拥有其父节点：如果我们丢弃一个子节点，父节点应该仍然存在。这是弱引用的应用场景！</p> <p>因此，我们将使<code>parent</code>的类型使用<code>Weak&lt;T&gt;</code>而不是<code>Rc&lt;T&gt;</code>，具体来说是<code>RefCell&lt;Weak&lt;Node&gt;&gt;</code>。现在我们的<code>Node</code>结构体定义如下：</p> <p>Filename: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Rc</span><span class="token punctuation">,</span> <span class="token class-name">Weak</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Weak</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> leaf <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Weak</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;leaf parent = {:?}&quot;</span><span class="token punctuation">,</span> leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> branch <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Weak</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">downgrade</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>branch<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;leaf parent = {:?}&quot;</span><span class="token punctuation">,</span> leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个节点将能够引用其父节点，但并不拥有其父节点。在示例15-28中，我们更新了<code>main</code>函数以使用这个新的定义，这样<code>leaf</code>节点就有了引用其父节点<code>branch</code>的方法。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Rc</span><span class="token punctuation">,</span> <span class="token class-name">Weak</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Weak</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> leaf <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Weak</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;leaf parent = {:?}&quot;</span><span class="token punctuation">,</span> leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> branch <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Weak</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">downgrade</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>branch<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;leaf parent = {:?}&quot;</span><span class="token punctuation">,</span> leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 15-28：一个<code>leaf</code>节点对其父节点<code>branch</code>的弱引用</p> <p>创建<code>leaf</code>节点看起来与示例15-27类似，除了<code>parent</code>字段：<code>leaf</code>开始时没有父节点，所以我们创建了一个新的、空的<code>Weak&lt;Node&gt;</code>引用实例。</p> <p>此时，当我们尝试使用<code>upgrade</code>方法获取<code>leaf</code>的父节点的引用时，我们得到一个<code>None</code>值。我们在第一个<code>println!</code>语句的输出中看到了这一点：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>leaf parent <span class="token operator">=</span> <span class="token class-name">None</span>
</code></pre></div><p>当我们创建<code>branch</code>节点时，它的<code>parent</code>字段也将有一个新的<code>Weak&lt;Node&gt;</code>引用，因为<code>branch</code>没有父节点。我们仍然将<code>leaf</code>作为<code>branch</code>的子节点之一。一旦我们在<code>branch</code>中有了<code>Node</code>实例，我们就可以修改<code>leaf</code>，使其拥有对其父节点的<code>Weak&lt;Node&gt;</code>引用。我们在<code>leaf</code>的<code>parent</code>字段中的<code>RefCell&lt;Weak&lt;Node&gt;&gt;</code>上使用<code>borrow_mut</code>方法，然后使用<code>Rc::downgrade</code>函数从<code>branch</code>中的<code>Rc&lt;Node&gt;</code>创建一个对<code>branch</code>的<code>Weak&lt;Node&gt;</code>引用。</p> <p>当我们打印<code>leaf</code>的父节点时，这次我们将得到一个包含<code>branch</code>的<code>Some</code>变体：现在<code>leaf</code>可以访问其父节点了！当我们打印<code>leaf</code>时，我们也避免了像示例15-26中那样最终导致堆栈溢出的循环；<code>Weak&lt;Node&gt;</code>引用被打印为<code>(Weak)</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>leaf parent <span class="token operator">=</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">Weak</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Node</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">Weak</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>没有无限输出表明这段代码没有创建引用循环。我们也可以通过查看调用<code>Rc::strong_count</code>和<code>Rc::weak_count</code>得到的值来判断这一点。</p> <h3 id="可视化strong-count和weak-count的变化"><a href="#可视化strong-count和weak-count的变化" class="header-anchor">#</a> 可视化<code>strong_count</code>和<code>weak_count</code>的变化</h3> <p>让我们看看通过创建一个新的内部作用域并将<code>branch</code>的创建移动到该作用域中，<code>Rc&lt;Node&gt;</code>实例的<code>strong_count</code>和<code>weak_count</code>值如何变化。通过这样做，我们可以看到当<code>branch</code>被创建并在超出作用域时被丢弃时会发生什么。修改如示例15-29所示。</p> <p>文件名: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Rc</span><span class="token punctuation">,</span> <span class="token class-name">Weak</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Node</span> <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Weak</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">Node</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> leaf <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Weak</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">&quot;leaf strong = {}, weak = {}&quot;</span><span class="token punctuation">,</span>
        <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">weak_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> branch <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Node</span> <span class="token punctuation">{</span>
            value<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            parent<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Weak</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            children<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">*</span>leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">downgrade</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>branch<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">&quot;branch strong = {}, weak = {}&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>branch<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">weak_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>branch<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">println!</span><span class="token punctuation">(</span>
            <span class="token string">&quot;leaf strong = {}, weak = {}&quot;</span><span class="token punctuation">,</span>
            <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">weak_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;leaf parent = {:?}&quot;</span><span class="token punctuation">,</span> leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span>
        <span class="token string">&quot;leaf strong = {}, weak = {}&quot;</span><span class="token punctuation">,</span>
        <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">strong_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">weak_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例 15-29：在内部作用域中创建<code>branch</code>并检查强引用和弱引用计数</p> <p>创建<code>leaf</code>后，其<code>Rc&lt;Node&gt;</code>的强引用计数为1，弱引用计数为0。在内部作用域中，我们创建<code>branch</code>并将其与<code>leaf</code>关联，此时当我们打印计数时，<code>branch</code>中的<code>Rc&lt;Node&gt;</code>的强引用计数为1，弱引用计数为1（因为<code>leaf.parent</code>通过<code>Weak&lt;Node&gt;</code>指向<code>branch</code>）。当我们打印<code>leaf</code>中的计数时，我们将看到它的强引用计数为2，因为<code>branch</code>现在在<code>branch.children</code>中存储了<code>leaf</code>的<code>Rc&lt;Node&gt;</code>的克隆，但弱引用计数仍为0。</p> <p>当内部作用域结束时，<code>branch</code>超出作用域，<code>Rc&lt;Node&gt;</code>的强引用计数减少到0，因此其<code>Node</code>被丢弃。来自<code>leaf.parent</code>的弱引用计数1对<code>Node</code>是否被丢弃没有影响，所以我们没有内存泄漏！</p> <p>如果在作用域结束后尝试访问<code>leaf</code>的父节点，我们将再次得到<code>None</code>。在程序结束时，<code>leaf</code>中的<code>Rc&lt;Node&gt;</code>的强引用计数为1，弱引用计数为0，因为变量<code>leaf</code>现在再次成为对<code>Rc&lt;Node&gt;</code>的唯一引用。</p> <p>所有管理计数和值丢弃的逻辑都内置在<code>Rc&lt;T&gt;</code>和<code>Weak&lt;T&gt;</code>及其<code>Drop</code> trait的实现中。通过在<code>Node</code>的定义中指定子节点到其父节点的关系应该是<code>Weak&lt;T&gt;</code>引用，你就可以让父节点指向子节点，反之亦然，而不会创建引用循环和内存泄漏。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>本章介绍了如何使用智能指针来实现与Rust默认的常规引用不同的保证和权衡。<code>Box&lt;T&gt;</code>类型具有已知大小，并指向分配在堆上的数据。<code>Rc&lt;T&gt;</code>类型跟踪堆上数据的引用数量，以便数据可以有多个所有者。<code>RefCell&lt;T&gt;</code>类型及其内部可变性为我们提供了一种类型，当我们不需要可变类型但需要更改该类型的内部值时可以使用它；它还在运行时而不是编译时强制执行借用规则。</p> <p>本章还讨论了<code>Deref</code>和<code>Drop</code> trait，它们实现了智能指针的许多功能。我们探讨了可能导致内存泄漏的引用循环，以及如何使用<code>Weak&lt;T&gt;</code>来防止它们。</p> <p>如果本章引起了你的兴趣，并且你想实现自己的智能指针，请查阅<a href="https://doc.rust-lang.org/nomicon/index.html" target="_blank" rel="noopener noreferrer">“The Rustonomicon”<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以获取更多有用的信息。</p> <p>接下来，我们将讨论Rust中的并发。你甚至会学到一些新的智能指针。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rust-doc/doc/smart-pointers/interior-mutability.html" class="prev">
        `RefCell&lt;T&gt;`和内部可变性模式
      </a></span> <span class="next"><a href="/rust-doc/doc/concurrency/threads.html">
        使用线程同时运行代码
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/rust-doc/assets/js/app.5dbdf326.js" defer></script><script src="/rust-doc/assets/js/2.de3bffe6.js" defer></script><script src="/rust-doc/assets/js/1.5cc4c8d6.js" defer></script><script src="/rust-doc/assets/js/32.0fd42499.js" defer></script>
  </body>
</html>
