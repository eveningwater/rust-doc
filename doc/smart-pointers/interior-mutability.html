<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RefCell&lt;T&gt;和内部可变性模式 | rust语言中文文档</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/rust-doc/logo.svg">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="一门赋予每个人构建可靠且高效软件能力的语言。">
    
    <link rel="preload" href="/rust-doc/assets/css/0.styles.b04b0b2c.css" as="style"><link rel="preload" href="/rust-doc/assets/js/app.a072e027.js" as="script"><link rel="preload" href="/rust-doc/assets/js/2.de3bffe6.js" as="script"><link rel="preload" href="/rust-doc/assets/js/1.5cc4c8d6.js" as="script"><link rel="preload" href="/rust-doc/assets/js/116.299e88c6.js" as="script"><link rel="prefetch" href="/rust-doc/assets/js/10.eb17c9b1.js"><link rel="prefetch" href="/rust-doc/assets/js/100.b000e386.js"><link rel="prefetch" href="/rust-doc/assets/js/101.7b0c5a1e.js"><link rel="prefetch" href="/rust-doc/assets/js/102.b3d3cf9f.js"><link rel="prefetch" href="/rust-doc/assets/js/103.83cf828b.js"><link rel="prefetch" href="/rust-doc/assets/js/104.a8b481d6.js"><link rel="prefetch" href="/rust-doc/assets/js/105.5300bfe3.js"><link rel="prefetch" href="/rust-doc/assets/js/106.794ab1ca.js"><link rel="prefetch" href="/rust-doc/assets/js/107.767d465d.js"><link rel="prefetch" href="/rust-doc/assets/js/108.306485b9.js"><link rel="prefetch" href="/rust-doc/assets/js/109.67aef446.js"><link rel="prefetch" href="/rust-doc/assets/js/11.4d96857f.js"><link rel="prefetch" href="/rust-doc/assets/js/110.415d8db1.js"><link rel="prefetch" href="/rust-doc/assets/js/111.b3ad9b53.js"><link rel="prefetch" href="/rust-doc/assets/js/112.3fa4fdb9.js"><link rel="prefetch" href="/rust-doc/assets/js/113.eca395d6.js"><link rel="prefetch" href="/rust-doc/assets/js/114.de689a0b.js"><link rel="prefetch" href="/rust-doc/assets/js/115.f47c0d84.js"><link rel="prefetch" href="/rust-doc/assets/js/117.a1b759ae.js"><link rel="prefetch" href="/rust-doc/assets/js/118.eb7cddd3.js"><link rel="prefetch" href="/rust-doc/assets/js/119.4a168af1.js"><link rel="prefetch" href="/rust-doc/assets/js/12.0eea138a.js"><link rel="prefetch" href="/rust-doc/assets/js/120.03f18f27.js"><link rel="prefetch" href="/rust-doc/assets/js/121.a1140ae7.js"><link rel="prefetch" href="/rust-doc/assets/js/122.1dec2ba7.js"><link rel="prefetch" href="/rust-doc/assets/js/123.44798165.js"><link rel="prefetch" href="/rust-doc/assets/js/124.f5b6b9fd.js"><link rel="prefetch" href="/rust-doc/assets/js/125.7080f568.js"><link rel="prefetch" href="/rust-doc/assets/js/126.e8e772ce.js"><link rel="prefetch" href="/rust-doc/assets/js/13.da6262af.js"><link rel="prefetch" href="/rust-doc/assets/js/14.9386ae96.js"><link rel="prefetch" href="/rust-doc/assets/js/15.c72c8a9e.js"><link rel="prefetch" href="/rust-doc/assets/js/16.1c185a04.js"><link rel="prefetch" href="/rust-doc/assets/js/17.5e3f0cae.js"><link rel="prefetch" href="/rust-doc/assets/js/18.38ede518.js"><link rel="prefetch" href="/rust-doc/assets/js/19.ac65ddaa.js"><link rel="prefetch" href="/rust-doc/assets/js/20.b2f37783.js"><link rel="prefetch" href="/rust-doc/assets/js/21.bc7abb0d.js"><link rel="prefetch" href="/rust-doc/assets/js/22.b15740d1.js"><link rel="prefetch" href="/rust-doc/assets/js/23.8b029831.js"><link rel="prefetch" href="/rust-doc/assets/js/24.3123e7b2.js"><link rel="prefetch" href="/rust-doc/assets/js/25.c92ccfb3.js"><link rel="prefetch" href="/rust-doc/assets/js/26.7cf20f6f.js"><link rel="prefetch" href="/rust-doc/assets/js/27.b6484f43.js"><link rel="prefetch" href="/rust-doc/assets/js/28.c5d100db.js"><link rel="prefetch" href="/rust-doc/assets/js/29.7b185968.js"><link rel="prefetch" href="/rust-doc/assets/js/3.bfcba754.js"><link rel="prefetch" href="/rust-doc/assets/js/30.a897f496.js"><link rel="prefetch" href="/rust-doc/assets/js/31.6dca31d5.js"><link rel="prefetch" href="/rust-doc/assets/js/32.6df6713e.js"><link rel="prefetch" href="/rust-doc/assets/js/33.35cbdf5b.js"><link rel="prefetch" href="/rust-doc/assets/js/34.6bf425a5.js"><link rel="prefetch" href="/rust-doc/assets/js/35.251e1b14.js"><link rel="prefetch" href="/rust-doc/assets/js/36.7fe6156d.js"><link rel="prefetch" href="/rust-doc/assets/js/37.2cd0e0de.js"><link rel="prefetch" href="/rust-doc/assets/js/38.4bc88ad1.js"><link rel="prefetch" href="/rust-doc/assets/js/39.25b21d27.js"><link rel="prefetch" href="/rust-doc/assets/js/4.508a9818.js"><link rel="prefetch" href="/rust-doc/assets/js/40.1f8ea623.js"><link rel="prefetch" href="/rust-doc/assets/js/41.a5b3964e.js"><link rel="prefetch" href="/rust-doc/assets/js/42.95550c94.js"><link rel="prefetch" href="/rust-doc/assets/js/43.dbcac583.js"><link rel="prefetch" href="/rust-doc/assets/js/44.05f74594.js"><link rel="prefetch" href="/rust-doc/assets/js/45.8a75ffa2.js"><link rel="prefetch" href="/rust-doc/assets/js/46.5aa1ed7d.js"><link rel="prefetch" href="/rust-doc/assets/js/47.a602c1f1.js"><link rel="prefetch" href="/rust-doc/assets/js/48.98791225.js"><link rel="prefetch" href="/rust-doc/assets/js/49.70739c54.js"><link rel="prefetch" href="/rust-doc/assets/js/5.f95f0a29.js"><link rel="prefetch" href="/rust-doc/assets/js/50.c9ad4e7b.js"><link rel="prefetch" href="/rust-doc/assets/js/51.9a35b992.js"><link rel="prefetch" href="/rust-doc/assets/js/52.0b6b0a5a.js"><link rel="prefetch" href="/rust-doc/assets/js/53.9336e5a4.js"><link rel="prefetch" href="/rust-doc/assets/js/54.c8d8baef.js"><link rel="prefetch" href="/rust-doc/assets/js/55.b62f2ebe.js"><link rel="prefetch" href="/rust-doc/assets/js/56.1a0d24f7.js"><link rel="prefetch" href="/rust-doc/assets/js/57.21a4b27d.js"><link rel="prefetch" href="/rust-doc/assets/js/58.67dc18f7.js"><link rel="prefetch" href="/rust-doc/assets/js/59.6bf39a82.js"><link rel="prefetch" href="/rust-doc/assets/js/6.c4bf9bde.js"><link rel="prefetch" href="/rust-doc/assets/js/60.9c4885f0.js"><link rel="prefetch" href="/rust-doc/assets/js/61.b71c278b.js"><link rel="prefetch" href="/rust-doc/assets/js/62.3a4f0cb7.js"><link rel="prefetch" href="/rust-doc/assets/js/63.0b702afe.js"><link rel="prefetch" href="/rust-doc/assets/js/64.b83541ff.js"><link rel="prefetch" href="/rust-doc/assets/js/65.16a56806.js"><link rel="prefetch" href="/rust-doc/assets/js/66.6afc737f.js"><link rel="prefetch" href="/rust-doc/assets/js/67.c58df2de.js"><link rel="prefetch" href="/rust-doc/assets/js/68.d626fd8e.js"><link rel="prefetch" href="/rust-doc/assets/js/69.295d65b6.js"><link rel="prefetch" href="/rust-doc/assets/js/7.7610c249.js"><link rel="prefetch" href="/rust-doc/assets/js/70.72d45c40.js"><link rel="prefetch" href="/rust-doc/assets/js/71.7b6416c1.js"><link rel="prefetch" href="/rust-doc/assets/js/72.92d12a1c.js"><link rel="prefetch" href="/rust-doc/assets/js/73.935c4d8c.js"><link rel="prefetch" href="/rust-doc/assets/js/74.be7c496c.js"><link rel="prefetch" href="/rust-doc/assets/js/75.a1d63544.js"><link rel="prefetch" href="/rust-doc/assets/js/76.fcb8ac3b.js"><link rel="prefetch" href="/rust-doc/assets/js/77.df6da012.js"><link rel="prefetch" href="/rust-doc/assets/js/78.fb823ebd.js"><link rel="prefetch" href="/rust-doc/assets/js/79.d5c2dab0.js"><link rel="prefetch" href="/rust-doc/assets/js/80.23ebc8ab.js"><link rel="prefetch" href="/rust-doc/assets/js/81.3ecbb346.js"><link rel="prefetch" href="/rust-doc/assets/js/82.cf75df79.js"><link rel="prefetch" href="/rust-doc/assets/js/83.f29d6a08.js"><link rel="prefetch" href="/rust-doc/assets/js/84.738f8523.js"><link rel="prefetch" href="/rust-doc/assets/js/85.9ed79021.js"><link rel="prefetch" href="/rust-doc/assets/js/86.ec0392f3.js"><link rel="prefetch" href="/rust-doc/assets/js/87.18f830b4.js"><link rel="prefetch" href="/rust-doc/assets/js/88.55b82a78.js"><link rel="prefetch" href="/rust-doc/assets/js/89.ed389936.js"><link rel="prefetch" href="/rust-doc/assets/js/90.f1af2708.js"><link rel="prefetch" href="/rust-doc/assets/js/91.6728badf.js"><link rel="prefetch" href="/rust-doc/assets/js/92.1ad17c00.js"><link rel="prefetch" href="/rust-doc/assets/js/93.6c380c9e.js"><link rel="prefetch" href="/rust-doc/assets/js/94.42aa2d98.js"><link rel="prefetch" href="/rust-doc/assets/js/95.434e21fd.js"><link rel="prefetch" href="/rust-doc/assets/js/96.a1179c39.js"><link rel="prefetch" href="/rust-doc/assets/js/97.aabcd77a.js"><link rel="prefetch" href="/rust-doc/assets/js/98.0814f303.js"><link rel="prefetch" href="/rust-doc/assets/js/99.ea606a25.js"><link rel="prefetch" href="/rust-doc/assets/js/vendors~docsearch.3b28fe31.js">
    <link rel="stylesheet" href="/rust-doc/assets/css/0.styles.b04b0b2c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rust-doc/" class="home-link router-link-active"><!----> <span class="site-name">rust语言中文文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rust-doc/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://github.com/eveningwater/rust-doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/eveningwater" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/rust-doc/doc/introduce/introduce.html" class="sidebar-link">Rust介绍</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/getting-started/getting-started" class="sidebar-heading clickable"><span>入门</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/rust-doc/doc/guess-game/guess-game.html" class="sidebar-link">猜一猜游戏</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-concept/common-concept" class="sidebar-heading clickable"><span>常用的编程概念</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/understand-ownership/understand-ownership" class="sidebar-heading clickable"><span>认识所有权</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/structs/structs" class="sidebar-heading clickable"><span>使用结构体来构造相关数据</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/enums/enums" class="sidebar-heading clickable"><span>枚举</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/packages-crates-and-modules/packages-crates-and-modules" class="sidebar-heading clickable"><span>使用包、依赖箱和模块管理不断增长的项目</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/common-collections/common-collections" class="sidebar-heading clickable"><span>常用集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/error-handling/error-handling" class="sidebar-heading clickable"><span>错误处理</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/generics/generics" class="sidebar-heading clickable"><span>泛型类型、特性和生命周期</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/testing/testing" class="sidebar-heading clickable"><span>测试</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/an-io-project/an-io-project" class="sidebar-heading clickable"><span>I/O 项目：构建命令行程序</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/functional-features/functional-features" class="sidebar-heading clickable"><span>函数式语言特性：迭代器与闭包</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/more-about-cargo/more-about-cargo" class="sidebar-heading clickable"><span>关于 Cargo 和 Crates.io 的更多信息</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/smart-pointers/smart-pointers" class="sidebar-heading clickable open"><span>智能指针</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/rust-doc/doc/smart-pointers/box.html" class="sidebar-link">使用 Box&lt;T&gt; 指向堆上的数据</a></li><li><a href="/rust-doc/doc/smart-pointers/deref.html" class="sidebar-link">通过`Deref`特性将智能指针视为常规引用</a></li><li><a href="/rust-doc/doc/smart-pointers/drop.html" class="sidebar-link">使用`Drop`特性在清理时运行代码</a></li><li><a href="/rust-doc/doc/smart-pointers/rc.html" class="sidebar-link">`Rc&lt;T&gt;`，引用计数智能指针</a></li><li><a href="/rust-doc/doc/smart-pointers/interior-mutability.html" aria-current="page" class="active sidebar-link">`RefCell&lt;T&gt;`和内部可变性模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rust-doc/doc/smart-pointers/interior-mutability.html#refcell-t-和内部可变性模式" class="sidebar-link">RefCell&lt;T&gt;和内部可变性模式</a></li></ul></li><li><a href="/rust-doc/doc/smart-pointers/reference-cycles.html" class="sidebar-link">引用循环可能导致内存泄漏</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/concurrency/concurrency" class="sidebar-heading clickable"><span>无畏并发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/async-await/async-await" class="sidebar-heading clickable"><span>异步编程基础：Async、Await、Futures 和 Streams</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/oop/oop" class="sidebar-heading clickable"><span>面向对象编程特性</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/patterns/patterns" class="sidebar-heading clickable"><span>模式与匹配</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/rust-doc/doc/advanced-features/advanced-features" class="sidebar-heading clickable"><span>高级特性</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>附录</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="refcell-t-和内部可变性模式"><a href="#refcell-t-和内部可变性模式" class="header-anchor">#</a> <code>RefCell&lt;T&gt;</code>和内部可变性模式</h2> <p>内部可变性是Rust中的一种设计模式，它允许你在有不可变引用的情况下修改数据；通常，借用规则不允许这种操作。为了修改数据，该模式在数据结构内部使用<code>unsafe</code>代码来绕过Rust通常管理修改和借用的规则。Unsafe代码向编译器表明我们正在手动检查规则，而不是依赖编译器为我们检查；我们将在第20章中更多地讨论unsafe代码。</p> <p>我们只能在确保借用规则在运行时会被遵守的情况下使用内部可变性模式的类型，即使编译器不能保证这一点。涉及的<code>unsafe</code>代码随后被包装在安全的API中，外部类型仍然是不可变的。</p> <p>让我们通过查看遵循内部可变性模式的<code>RefCell&lt;T&gt;</code>类型来探索这个概念。</p> <h3 id="在运行时使用refcell-t-强制执行借用规则"><a href="#在运行时使用refcell-t-强制执行借用规则" class="header-anchor">#</a> 在运行时使用<code>RefCell&lt;T&gt;</code>强制执行借用规则</h3> <p>与<code>Rc&lt;T&gt;</code>不同，<code>RefCell&lt;T&gt;</code>类型表示对其持有的数据的单一所有权。那么，是什么让<code>RefCell&lt;T&gt;</code>与<code>Box&lt;T&gt;</code>这样的类型不同呢？回想一下你在第4章中学到的借用规则：</p> <ul><li>在任何给定时间，你可以拥有一个可变引用或任意数量的不可变引用（但不能同时拥有两者）。</li> <li>引用必须始终有效。</li></ul> <p>对于引用和<code>Box&lt;T&gt;</code>，借用规则的不变性在编译时强制执行。而对于<code>RefCell&lt;T&gt;</code>，这些不变性在运行时强制执行。使用引用时，如果你违反了这些规则，你会得到一个编译错误。使用<code>RefCell&lt;T&gt;</code>时，如果你违反了这些规则，你的程序将会panic并退出。</p> <p>在编译时检查借用规则的优点是错误会在开发过程的早期被发现，并且由于所有分析都是预先完成的，所以对运行时性能没有影响。出于这些原因，在大多数情况下，在编译时检查借用规则是最佳选择，这就是为什么这是Rust的默认行为。</p> <p>而在运行时检查借用规则的优势在于某些内存安全的场景会被允许，而这些场景在编译时检查中会被禁止。静态分析，如Rust编译器，本质上是保守的。代码的某些属性通过分析代码是不可能检测到的：最著名的例子是停机问题，这超出了本文档的范围，但是一个有趣的研究主题。</p> <p>因为某些分析是不可能的，如果Rust编译器不能确定代码符合所有权规则，它可能会拒绝一个正确的程序；这样，它是保守的。如果Rust接受了一个不正确的程序，用户将无法信任Rust做出的保证。然而，如果Rust拒绝了一个正确的程序，程序员会感到不便，但不会发生灾难性的事情。当你确信你的代码遵循借用规则，但编译器无法理解和保证这一点时，<code>RefCell&lt;T&gt;</code>类型就很有用。</p> <p>与<code>Rc&lt;T&gt;</code>类似，<code>RefCell&lt;T&gt;</code>仅用于单线程场景，如果你尝试在多线程上下文中使用它，将会得到一个编译时错误。我们将在第16章中讨论如何在多线程程序中获得<code>RefCell&lt;T&gt;</code>的功能。</p> <p>以下是选择<code>Box&lt;T&gt;</code>、<code>Rc&lt;T&gt;</code>或<code>RefCell&lt;T&gt;</code>的原因概述：</p> <ul><li><code>Rc&lt;T&gt;</code>允许同一数据有多个所有者；<code>Box&lt;T&gt;</code>和<code>RefCell&lt;T&gt;</code>有单一所有者。</li> <li><code>Box&lt;T&gt;</code>允许在编译时检查的不可变或可变借用；<code>Rc&lt;T&gt;</code>只允许在编译时检查的不可变借用；<code>RefCell&lt;T&gt;</code>允许在运行时检查的不可变或可变借用。</li> <li>因为<code>RefCell&lt;T&gt;</code>允许在运行时检查的可变借用，你可以在<code>RefCell&lt;T&gt;</code>是不可变的情况下修改<code>RefCell&lt;T&gt;</code>内部的值。</li></ul> <p>在不可变值内部修改值就是内部可变性模式。让我们看一个内部可变性有用的情况，并检查它是如何实现的。</p> <h3 id="内部可变性-对不可变值的可变借用"><a href="#内部可变性-对不可变值的可变借用" class="header-anchor">#</a> 内部可变性：对不可变值的可变借用</h3> <p>借用规则的一个结果是，当你有一个不可变值时，你不能可变地借用它。例如，这段代码不会编译：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果你尝试编译这段代码，你会得到以下错误：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo run
   <span class="token class-name">Compiling</span> borrowing v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/borrowing)</span>
error<span class="token punctuation">[</span><span class="token constant">E0596</span><span class="token punctuation">]</span><span class="token punctuation">:</span> cannot borrow `x` <span class="token keyword">as</span> mutable<span class="token punctuation">,</span> <span class="token keyword">as</span> it is not declared <span class="token keyword">as</span> mutable
 <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>main<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">13</span>
  <span class="token operator">|</span>
<span class="token number">3</span> <span class="token operator">|</span>     <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> x<span class="token punctuation">;</span>
  <span class="token operator">|</span>             <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> cannot borrow <span class="token keyword">as</span> mutable
  <span class="token operator">|</span>
help<span class="token punctuation">:</span> consider changing this to be mutable
  <span class="token operator">|</span>
<span class="token number">2</span> <span class="token operator">|</span>     <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token operator">|</span>         <span class="token operator">+</span><span class="token operator">+</span><span class="token operator">+</span>

<span class="token class-name">For</span> more information about this error<span class="token punctuation">,</span> <span class="token keyword">try</span> `rustc <span class="token operator">-</span><span class="token operator">-</span>explain <span class="token constant">E0596</span>`<span class="token punctuation">.</span>
error<span class="token punctuation">:</span> could not compile `borrowing` <span class="token punctuation">(</span>bin <span class="token string">&quot;borrowing&quot;</span><span class="token punctuation">)</span> due to <span class="token number">1</span> previous error
</code></pre></div><p>然而，在某些情况下，对于一个值在其方法中修改自身但对其他代码显示为不可变是有用的。值方法之外的代码将无法修改该值。使用<code>RefCell&lt;T&gt;</code>是获得内部可变性能力的一种方式，但<code>RefCell&lt;T&gt;</code>并没有完全绕过借用规则：编译器中的借用检查器允许这种内部可变性，而借用规则则在运行时检查。如果你违反了规则，你会得到一个<code>panic!</code>而不是编译器错误。</p> <p>让我们通过一个实际的例子来了解如何使用<code>RefCell&lt;T&gt;</code>修改不可变值，并了解为什么这很有用。</p> <h4 id="内部可变性的用例-模拟对象"><a href="#内部可变性的用例-模拟对象" class="header-anchor">#</a> 内部可变性的用例：模拟对象</h4> <p>有时在测试过程中，程序员会使用一种类型代替另一种类型，以观察特定行为并断言它被正确实现。这种占位类型被称为测试替身。可以将其想象为电影制作中的特技替身，一个人介入并替代演员完成特别棘手的场景。测试替身在我们运行测试时代替其他类型。模拟对象是测试替身的特定类型，它们记录测试期间发生的事情，以便你可以断言正确的操作已经发生。</p> <p>Rust没有与其他语言相同意义上的对象，Rust的标准库中也没有像其他一些语言那样内置的模拟对象功能。然而，你绝对可以创建一个结构体，它将服务于与模拟对象相同的目的。</p> <p>这是我们将要测试的场景：我们将创建一个库，它跟踪一个值与最大值的关系，并根据当前值与最大值的接近程度发送消息。例如，这个库可以用来跟踪用户被允许进行的API调用数量的配额。</p> <p>我们的库只提供跟踪值与最大值的接近程度以及在什么时候应该发送什么消息的功能。使用我们库的应用程序将被期望提供发送消息的机制：应用程序可以在应用程序中放置消息，发送电子邮件，发送文本消息，或做其他事情。库不需要知道这些细节。它只需要一些实现我们将提供的名为<code>Messenger</code>的特性的东西。示例15-20显示了库代码。</p> <p>文件名: src/lib.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Messenger</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">LimitTracker</span> <span class="token punctuation">{</span>
            messenger<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            max<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>

        <span class="token keyword">let</span> percentage_of_max <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token keyword">as</span> <span class="token keyword">f64</span> <span class="token operator">/</span> <span class="token keyword">self</span><span class="token punctuation">.</span>max <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">1.0</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Error: You are over your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.9</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Urgent warning: You've used up over 90% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.75</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Warning: You've used up over 75% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例15-20：一个库，用于跟踪一个值与最大值的接近程度，并在值达到特定水平时发出警告</p> <p>这段代码的一个重要部分是<code>Messenger</code>特性有一个名为<code>send</code>的方法，它接受一个对<code>self</code>的不可变引用和消息的文本。这个特性是我们的模拟对象需要实现的接口，以便模拟对象可以以与真实对象相同的方式使用。另一个重要部分是我们想要测试<code>LimitTracker</code>上的<code>set_value</code>方法的行为。我们可以改变我们为<code>value</code>参数传入的内容，但<code>set_value</code>不返回任何东西供我们进行断言。我们希望能够说，如果我们创建一个<code>LimitTracker</code>，其中包含实现了<code>Messenger</code>特性的东西和一个特定的<code>max</code>值，当我们为<code>value</code>传递不同的数字时，messenger被告知发送适当的消息。</p> <p>我们需要一个模拟对象，当我们调用<code>send</code>时，它不会发送电子邮件或文本消息，而只会跟踪它被告知要发送的消息。我们可以创建模拟对象的新实例，创建使用模拟对象的<code>LimitTracker</code>，在<code>LimitTracker</code>上调用<code>set_value</code>方法，然后检查模拟对象是否有我们期望的消息。示例15-21显示了实现模拟对象的尝试，但借用检查器不允许这样做。</p> <p>文件名: src/lib.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Messenger</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">LimitTracker</span> <span class="token punctuation">{</span>
            messenger<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            max<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>

        <span class="token keyword">let</span> percentage_of_max <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token keyword">as</span> <span class="token keyword">f64</span> <span class="token operator">/</span> <span class="token keyword">self</span><span class="token punctuation">.</span>max <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">1.0</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Error: You are over your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.9</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Urgent warning: You've used up over 90% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.75</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Warning: You've used up over 75% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token type-definition class-name">MockMessenger</span> <span class="token punctuation">{</span>
        sent_messages<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
            <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
                sent_messages<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> <span class="token class-name">Messenger</span> <span class="token keyword">for</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">it_sends_an_over_75_percent_warning_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> mock_messenger <span class="token operator">=</span> <span class="token class-name">MockMessenger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> limit_tracker <span class="token operator">=</span> <span class="token class-name">LimitTracker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mock_messenger<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        limit_tracker<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>mock_messenger<span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例15-21：尝试实现一个不被借用检查器允许的<code>MockMessenger</code></p> <p>这段测试代码定义了一个<code>MockMessenger</code>结构体，它有一个<code>sent_messages</code>字段，其中包含一个<code>String</code>值的<code>Vec</code>，用于跟踪它被告知要发送的消息。我们还定义了一个关联函数<code>new</code>，以便于创建以空消息列表开始的新<code>MockMessenger</code>值。然后我们为<code>MockMessenger</code>实现<code>Messenger</code>特性，这样我们就可以将<code>MockMessenger</code>提供给<code>LimitTracker</code>。在<code>send</code>方法的定义中，我们将作为参数传入的消息存储在<code>MockMessenger</code>的<code>sent_messages</code>列表中。</p> <p>在测试中，我们测试当<code>LimitTracker</code>被告知将<code>value</code>设置为超过<code>max</code>值75%的值时会发生什么。首先，我们创建一个新的<code>MockMessenger</code>，它将以空消息列表开始。然后我们创建一个新的<code>LimitTracker</code>，并给它一个对新<code>MockMessenger</code>的引用和一个<code>max</code>值<code>100</code>。我们在<code>LimitTracker</code>上调用<code>set_value</code>方法，值为<code>80</code>，这超过了100的75%。然后我们断言<code>MockMessenger</code>正在跟踪的消息列表现在应该有一条消息。</p> <p>然而，这个测试有一个问题，如这里所示：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> limit<span class="token operator">-</span>tracker v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/limit-tracker)</span>
error<span class="token punctuation">[</span><span class="token constant">E0596</span><span class="token punctuation">]</span><span class="token punctuation">:</span> cannot borrow `<span class="token keyword">self</span><span class="token punctuation">.</span>sent_messages` <span class="token keyword">as</span> mutable<span class="token punctuation">,</span> <span class="token keyword">as</span> it is behind a `<span class="token operator">&amp;</span>` reference
  <span class="token operator">-</span><span class="token punctuation">-&gt;</span> src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">58</span><span class="token punctuation">:</span><span class="token number">13</span>
   <span class="token operator">|</span>
<span class="token number">58</span> <span class="token operator">|</span>             <span class="token keyword">self</span><span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">|</span>             <span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span> `<span class="token keyword">self</span>` is a `<span class="token operator">&amp;</span>` reference<span class="token punctuation">,</span> so the data it refers to cannot be borrowed <span class="token keyword">as</span> mutable
   <span class="token operator">|</span>
help<span class="token punctuation">:</span> consider changing this to be a mutable reference <span class="token keyword">in</span> the `<span class="token keyword">impl</span>` method and the `<span class="token keyword">trait</span>` definition
   <span class="token operator">|</span>
<span class="token number">2</span>  ~     <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3</span>  <span class="token operator">|</span> <span class="token punctuation">}</span>
<span class="token punctuation">...</span>
<span class="token number">56</span> <span class="token operator">|</span>     <span class="token keyword">impl</span> <span class="token class-name">Messenger</span> <span class="token keyword">for</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
<span class="token number">57</span> ~         <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token operator">|</span>

<span class="token class-name">For</span> more information about this error<span class="token punctuation">,</span> <span class="token keyword">try</span> `rustc <span class="token operator">-</span><span class="token operator">-</span>explain <span class="token constant">E0596</span>`<span class="token punctuation">.</span>
error<span class="token punctuation">:</span> could not compile `limit<span class="token operator">-</span>tracker` <span class="token punctuation">(</span>lib test<span class="token punctuation">)</span> due to <span class="token number">1</span> previous error
warning<span class="token punctuation">:</span> build failed<span class="token punctuation">,</span> waiting <span class="token keyword">for</span> other jobs to finish<span class="token punctuation">...</span>
</code></pre></div><p>我们不能修改<code>MockMessenger</code>来跟踪消息，因为<code>send</code>方法接受一个对<code>self</code>的不可变引用。我们也不能采纳错误文本中的建议，在<code>impl</code>方法和<code>trait</code>定义中都使用<code>&amp;mut</code> self。我们不想仅仅为了测试而改变<code>Messenger</code>特性。相反，我们需要找到一种方法，使我们的测试代码能够与我们现有的设计正确地工作。</p> <p>这是一个内部可变性可以帮助的情况！我们将在<code>RefCell&lt;T&gt;</code>中存储<code>sent_messages</code>，然后<code>send</code>方法将能够修改<code>sent_messages</code>以存储我们看到的消息。示例15-22显示了这是什么样子。</p> <p>文件名: src/lib.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Messenger</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">LimitTracker</span> <span class="token punctuation">{</span>
            messenger<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            max<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>

        <span class="token keyword">let</span> percentage_of_max <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token keyword">as</span> <span class="token keyword">f64</span> <span class="token operator">/</span> <span class="token keyword">self</span><span class="token punctuation">.</span>max <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">1.0</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Error: You are over your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.9</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Urgent warning: You've used up over 90% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.75</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Warning: You've used up over 75% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token type-definition class-name">MockMessenger</span> <span class="token punctuation">{</span>
        sent_messages<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
            <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
                sent_messages<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> <span class="token class-name">Messenger</span> <span class="token keyword">for</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">it_sends_an_over_75_percent_warning_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// --snip--</span>
        <span class="token keyword">let</span> mock_messenger <span class="token operator">=</span> <span class="token class-name">MockMessenger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> limit_tracker <span class="token operator">=</span> <span class="token class-name">LimitTracker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mock_messenger<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        limit_tracker<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>mock_messenger<span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例15-22：使用<code>RefCell&lt;T&gt;</code>修改内部值，而外部值被视为不可变</p> <p><code>sent_messages</code>字段现在的类型是<code>RefCell&lt;Vec&lt;String&gt;&gt;</code>而不是<code>Vec&lt;String&gt;</code>。在<code>new</code>函数中，我们在空向量周围创建一个新的<code>RefCell&lt;Vec&lt;String&gt;&gt;</code>实例。</p> <p>对于<code>send</code>方法的实现，第一个参数仍然是对<code>self</code>的不可变借用，这与特性定义相匹配。我们在<code>self.sent_messages</code>中的<code>RefCell&lt;Vec&lt;String&gt;&gt;</code>上调用<code>borrow_mut</code>，以获取<code>RefCell&lt;Vec&lt;String&gt;&gt;</code>内部值的可变引用，即向量。然后我们可以在向量的可变引用上调用<code>push</code>，以跟踪测试期间发送的消息。</p> <p>我们必须做的最后一个更改是在断言中：要查看内部向量中有多少项，我们在<code>RefCell&lt;Vec&lt;String&gt;&gt;</code>上调用<code>borrow</code>以获取对向量的不可变引用。</p> <p>现在你已经看到了如何使用<code>RefCell&lt;T&gt;</code>，让我们深入了解它是如何工作的！</p> <h4 id="在运行时使用refcell-t-跟踪借用"><a href="#在运行时使用refcell-t-跟踪借用" class="header-anchor">#</a> 在运行时使用<code>RefCell&lt;T&gt;</code>跟踪借用</h4> <p>当创建不可变和可变引用时，我们分别使用<code>&amp;</code>和<code>&amp;mut</code>语法。使用<code>RefCell&lt;T&gt;</code>时，我们使用<code>borrow</code>和<code>borrow_mut</code>方法，它们是属于<code>RefCell&lt;T&gt;</code>的安全API的一部分。<code>borrow</code>方法返回智能指针类型<code>Ref&lt;T&gt;</code>，而<code>borrow_mut</code>返回智能指针类型<code>RefMut&lt;T&gt;</code>。这两种类型都实现了<code>Deref</code>，所以我们可以像普通引用一样对待它们。</p> <p><code>RefCell&lt;T&gt;</code>跟踪当前有多少<code>Ref&lt;T&gt;</code>和<code>RefMut&lt;T&gt;</code>智能指针处于活动状态。每次我们调用<code>borrow</code>，<code>RefCell&lt;T&gt;</code>就会增加其活动的不可变借用计数。当一个<code>Ref&lt;T&gt;</code>值离开作用域时，不可变借用的计数减少1。就像编译时借用规则一样，<code>RefCell&lt;T&gt;</code>允许我们在任何时候有多个不可变借用或一个可变借用。</p> <p>如果我们尝试违反这些规则，而不是像使用引用那样得到编译器错误，<code>RefCell&lt;T&gt;</code>的实现将在运行时panic。示例15-23显示了对示例15-22中<code>send</code>实现的修改。我们故意尝试为同一作用域创建两个活动的可变借用，以说明<code>RefCell&lt;T&gt;</code>在运行时阻止我们这样做。</p> <p>文件名: src/lib.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token type-definition class-name">Messenger</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> msg<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Messenger</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>messenger<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">T</span><span class="token punctuation">,</span> max<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">LimitTracker</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">LimitTracker</span> <span class="token punctuation">{</span>
            messenger<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            max<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set_value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>

        <span class="token keyword">let</span> percentage_of_max <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token keyword">as</span> <span class="token keyword">f64</span> <span class="token operator">/</span> <span class="token keyword">self</span><span class="token punctuation">.</span>max <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">1.0</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Error: You are over your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.9</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Urgent warning: You've used up over 90% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> percentage_of_max <span class="token operator">&gt;=</span> <span class="token number">0.75</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>messenger
                <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;Warning: You've used up over 75% of your quota!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> <span class="token module-declaration namespace">tests</span> <span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>

    <span class="token keyword">struct</span> <span class="token type-definition class-name">MockMessenger</span> <span class="token punctuation">{</span>
        sent_messages<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
            <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
                sent_messages<span class="token punctuation">:</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">impl</span> <span class="token class-name">Messenger</span> <span class="token keyword">for</span> <span class="token class-name">MockMessenger</span> <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> message<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> one_borrow <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> two_borrow <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            one_borrow<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            two_borrow<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token attribute attr-name">#[test]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">it_sends_an_over_75_percent_warning_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> mock_messenger <span class="token operator">=</span> <span class="token class-name">MockMessenger</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> limit_tracker <span class="token operator">=</span> <span class="token class-name">LimitTracker</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mock_messenger<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        limit_tracker<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>mock_messenger<span class="token punctuation">.</span>sent_messages<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例15-23：在同一作用域中创建两个可变引用，以查看<code>RefCell&lt;T&gt;</code>将会panic</p> <p>我们为从<code>borrow_mut</code>返回的<code>RefMut&lt;T&gt;</code>智能指针创建一个变量<code>one_borrow</code>。然后我们以相同的方式在变量<code>two_borrow</code>中创建另一个可变借用。这在同一作用域中创建了两个可变引用，这是不允许的。当我们运行我们库的测试时，示例15-23中的代码将编译而不会有任何错误，但测试将失败：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo test
   <span class="token class-name">Compiling</span> limit<span class="token operator">-</span>tracker v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/limit-tracker)</span>
    <span class="token class-name">Finished</span> `test` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>91s
     <span class="token class-name">Running</span> unittests src<span class="token operator">/</span>lib<span class="token punctuation">.</span><span class="token function">rs</span> <span class="token punctuation">(</span>target<span class="token operator">/</span>debug<span class="token operator">/</span>deps<span class="token operator">/</span>limit_tracker<span class="token operator">-</span>e599811fa246dbde<span class="token punctuation">)</span>

running <span class="token number">1</span> test
test <span class="token namespace">tests<span class="token punctuation">::</span></span>it_sends_an_over_75_percent_warning_message <span class="token punctuation">...</span> <span class="token constant">FAILED</span>

failures<span class="token punctuation">:</span>

<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token namespace">tests<span class="token punctuation">::</span></span>it_sends_an_over_75_percent_warning_message stdout <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>

thread <span class="token lifetime-annotation symbol">'tests</span><span class="token punctuation">::</span>it_sends_an_over_75_percent_warning_message' panicked at src<span class="token operator">/</span>lib<span class="token punctuation">.</span>rs<span class="token punctuation">:</span><span class="token number">60</span><span class="token punctuation">:</span><span class="token number">53</span><span class="token punctuation">:</span>
already borrowed<span class="token punctuation">:</span> <span class="token class-name">BorrowMutError</span>
note<span class="token punctuation">:</span> run with `<span class="token constant">RUST_BACKTRACE</span><span class="token operator">=</span><span class="token number">1</span>` environment variable to display a backtrace


failures<span class="token punctuation">:</span>
    <span class="token namespace">tests<span class="token punctuation">::</span></span>it_sends_an_over_75_percent_warning_message

test result<span class="token punctuation">:</span> <span class="token constant">FAILED</span><span class="token punctuation">.</span> <span class="token number">0</span> passed<span class="token punctuation">;</span> <span class="token number">1</span> failed<span class="token punctuation">;</span> <span class="token number">0</span> ignored<span class="token punctuation">;</span> <span class="token number">0</span> measured<span class="token punctuation">;</span> <span class="token number">0</span> filtered out<span class="token punctuation">;</span> finished <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>00s

error<span class="token punctuation">:</span> test failed<span class="token punctuation">,</span> to rerun pass `<span class="token operator">-</span><span class="token operator">-</span>lib`
</code></pre></div><p>注意代码以消息<code>already borrowed: BorrowMutError</code>panic。这就是<code>RefCell&lt;T&gt;</code>在运行时处理借用规则违规的方式。</p> <p>选择在运行时而不是编译时捕获借用错误，就像我们在这里所做的那样，意味着你可能会在开发过程的后期发现代码中的错误：可能直到你的代码部署到生产环境才会发现。此外，由于在运行时而不是编译时跟踪借用，你的代码会产生小的运行时性能损失。然而，使用<code>RefCell&lt;T&gt;</code>可以编写一个模拟对象，它可以修改自身以跟踪它在只允许不可变值的上下文中看到的消息。尽管有权衡，你可以使用<code>RefCell&lt;T&gt;</code>获得比普通引用提供更多的功能。</p> <h3 id="使用rc-t-和refcell-t-允许多个所有者拥有可变数据"><a href="#使用rc-t-和refcell-t-允许多个所有者拥有可变数据" class="header-anchor">#</a> 使用<code>Rc&lt;T&gt;</code>和<code>RefCell&lt;T&gt;</code>允许多个所有者拥有可变数据</h3> <p>使用<code>RefCell&lt;T&gt;</code>的一种常见方式是与<code>Rc&lt;T&gt;</code>结合使用。回想一下，<code>Rc&lt;T&gt;</code>允许你对某些数据有多个所有者，但它只提供对该数据的不可变访问。如果你有一个持有<code>RefCell&lt;T&gt;</code>的<code>Rc&lt;T&gt;</code>，你可以获得一个可以有多个所有者且可以修改的值！</p> <p>例如，回想一下示例15-18中的cons列表示例，我们使用<code>Rc&lt;T&gt;</code>允许多个列表共享另一个列表的所有权。因为<code>Rc&lt;T&gt;</code>只持有不可变值，一旦创建了列表中的值，我们就不能改变它们。让我们添加<code>RefCell&lt;T&gt;</code>，以便能够更改列表中的值。示例15-24显示，通过在Cons定义中使用<code>RefCell&lt;T&gt;</code>，我们可以修改存储在所有列表中的值。</p> <p>Filename: src/main.rs:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> <span class="token type-definition class-name">List</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span><span class="token keyword">i32</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">List</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Nil</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">List</span><span class="token punctuation">::</span><span class="token punctuation">{</span><span class="token class-name">Cons</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>value<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;a after = {a:?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;b after = {b:?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;c after = {c:?}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>示例15-24：使用<code>Rc&lt;RefCell&lt;i32&gt;&gt;</code>创建一个我们可以修改的<code>List</code></p> <p>我们创建一个<code>Rc&lt;RefCell&lt;i32&gt;&gt;</code>实例的值，并将其存储在名为<code>value</code>的变量中，以便稍后直接访问它。然后我们在<code>a</code>中创建一个<code>List</code>，其中包含一个持有<code>value</code>的<code>Cons</code>变体。我们需要克隆<code>value</code>，这样<code>a</code>和<code>value</code>都拥有内部<code>5</code>值的所有权，而不是将所有权从<code>value</code>转移到<code>a</code>或让<code>a</code>从<code>value</code>借用。</p> <p>我们将列表<code>a</code>包装在一个<code>Rc&lt;T&gt;</code>中，这样当我们创建列表<code>b</code>和<code>c</code>时，它们都可以引用<code>a</code>，这就是我们在示例15-18中所做的。</p> <p>在我们创建了列表<code>a</code>、<code>b</code>和<code>c</code>之后，我们想要在<code>value</code>中的值上加10。我们通过在<code>value</code>上调用<code>borrow_mut</code>来做到这一点，它使用我们在第5章中讨论的自动解引用功能（<a href="../structs/method-syntax#%E6%93%8D%E4%BD%9C%E7%AC%A6-%E5%9C%A8%E5%93%AA%E9%87%8C">&quot;操作符-&gt;在哪里？&quot;</a>）来解引用<code>Rc&lt;T&gt;</code>到内部的<code>RefCell&lt;T&gt;</code>值。<code>borrow_mut</code>方法返回一个<code>RefMut&lt;T&gt;</code>智能指针，我们在其上使用解引用操作符并更改内部值。</p> <p>当我们打印<code>a</code>、<code>b</code>和<code>c</code>时，我们可以看到它们都有修改后的值<code>15</code>而不是<code>5</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>$ cargo run
   <span class="token class-name">Compiling</span> cons<span class="token operator">-</span>list v0<span class="token number">.1</span><span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">(</span>file<span class="token punctuation">:</span><span class="token operator">/</span><span class="token comment">//projects/cons-list)</span>
    <span class="token class-name">Finished</span> `dev` profile <span class="token punctuation">[</span>unoptimized <span class="token operator">+</span> debuginfo<span class="token punctuation">]</span> <span class="token function">target</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">.</span>63s
     <span class="token class-name">Running</span> `target<span class="token operator">/</span>debug<span class="token operator">/</span>cons<span class="token operator">-</span>list`
a after <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token number">15</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span>
b after <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token number">15</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
c after <span class="token operator">=</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Cons</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span> <span class="token punctuation">{</span> value<span class="token punctuation">:</span> <span class="token number">15</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这种技术非常巧妙！通过使用<code>RefCell&lt;T&gt;</code>，我们有一个外部不可变的<code>List</code>值。但是我们可以使用<code>RefCell&lt;T&gt;</code>上的方法，这些方法提供对其内部可变性的访问，因此我们可以在需要时修改我们的数据。借用规则的运行时检查保护我们免受数据竞争，有时为了在我们的数据结构中获得这种灵活性而牺牲一点速度是值得的。注意，<code>RefCell&lt;T&gt;</code>不适用于多线程代码！<code>Mutex&lt;T&gt;</code>是<code>RefCell&lt;T&gt;</code>的线程安全版本，我们将在第16章中讨论<code>Mutex&lt;T&gt;</code>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rust-doc/doc/smart-pointers/rc.html" class="prev">
        `Rc&lt;T&gt;`，引用计数智能指针
      </a></span> <span class="next"><a href="/rust-doc/doc/smart-pointers/reference-cycles.html">
        引用循环可能导致内存泄漏
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/rust-doc/assets/js/app.a072e027.js" defer></script><script src="/rust-doc/assets/js/2.de3bffe6.js" defer></script><script src="/rust-doc/assets/js/1.5cc4c8d6.js" defer></script><script src="/rust-doc/assets/js/116.299e88c6.js" defer></script>
  </body>
</html>
